<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flicklet - TV & Movie Tracker</title>
  <meta name="description" content="Search, track, and rate shows & films fast. Never lose track of your binge-watching again!" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icons/icon-512.png" />

<style>
    :root{
      --bg:#ffffff; --text:#121212; --primary:#ff6b6b; --card:#f7f7f9; --border:#dedee3;
      --success:#51cf66; --warning:#ffd43b; --danger:#ff4d4f; --purple:#845ec2;
    }
    *{box-sizing:border-box}
    body{
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      margin:0; padding:20px; color:var(--text); min-height:100vh;
    }
    .dark-mode{
      --bg:#1a1a1a; --text:#f5f5f5; --card:#232323; --border:#383838;
      background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%) !important;
    }

    .main-container{
      max-width:1100px; margin:0 auto; background:var(--bg); border-radius:20px; padding:24px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
    }

    .header{display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; border-bottom:3px dashed var(--primary); padding-bottom:16px; margin-bottom:18px}
    .title{margin:0; font-size:2.1rem; color:var(--primary); font-weight:800; letter-spacing:.2px}
    .subtitle{margin:2px 0 8px; color:#8a8a98; font-weight:600}
    .user-section{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    #langToggle{padding:8px 10px; border-radius:14px; border:2px solid var(--border); background:var(--card); color:var(--text); font-weight:700}

    .auth-box, .name-container{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .name-container input{max-width:260px}

    .tab-container{display:flex; gap:6px; background:var(--card); padding:8px; border-radius:12px; margin:14px 0}
    .tab{flex:1; border:0; background:transparent; padding:12px 10px; border-radius:10px; font-weight:800; cursor:pointer}
    .tab.active{background:linear-gradient(45deg,var(--primary),var(--purple)); color:#fff}
    .tab-badge{background:#fff; color:var(--primary); border-radius:12px; padding:2px 8px; font-size:12px; margin-left:6px}

    .search-container{background:var(--card); border:2px solid var(--primary); border-radius:14px; padding:12px; margin:14px 0}
    .search-row{display:grid; grid-template-columns:1fr 180px auto auto; gap:8px}
    .search-input{padding:10px 12px; border-radius:12px; border:2px solid var(--border); background:var(--bg); color:var(--text)}
    .btn{border:0; background:linear-gradient(45deg,var(--primary),var(--purple)); color:#fff; border-radius:18px; padding:10px 14px; font-weight:800; cursor:pointer}
    .btn.secondary{background:linear-gradient(45deg,#737d8c,#57606f)}
    .btn.success{background:linear-gradient(45deg,#2ed573,#1dd1a1)}
    .btn.danger{background:linear-gradient(45deg,#ff4d4f,#ff2d55)}

    .stats{
      display: flex;
      flex-wrap: wrap;
      gap: 12px; 
      margin: 14px 0;
    }

    .stat {
      flex: 1 1 calc(25% - 9px); /* 4 items per row */
      min-width: 140px;
      background: var(--card);
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }

    #bingeMeter {
      flex-basis: calc(50% - 6px) !important; /* make it wider */
      order: 10; /* put it last so it goes to next row */
    }

    @media (max-width: 768px) {
      .stat {
        flex: 1 1 calc(50% - 6px); /* 2 per row on mobile */
      }
      
      #bingeMeter {
        flex-basis: 100% !important; /* full width on mobile */
      }
    }

    .list-container{background:var(--card); border:3px dashed var(--border); border-radius:12px; padding:12px; min-height:80px}

    /* Cards */
    .show-card{
      display:grid; grid-template-columns:92px 1fr; gap:16px;
      border:2px solid var(--border); border-radius:12px; padding:14px; margin:12px 0; background:var(--bg)
    }
    .show-poster{width:92px; height:138px; border-radius:8px; object-fit:cover; cursor:pointer}
    .poster-placeholder{width:92px; height:138px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#e9e9ee; color:#777; font-size:12px}

    .show-details{display:grid; grid-template-rows:auto auto auto 1fr; gap:6px; min-width:0}
    .show-title{margin:0; color:var(--primary); font-size:1.05rem; font-weight:900; display:flex; gap:8px; align-items:center; cursor:pointer; line-height:1.2}
    .show-meta{color:#8a8a98; font-size:.88rem; display:flex; flex-wrap:wrap; gap:8px}
    .show-overview{font-size:.95rem; line-height:1.45; color:var(--text); display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden}
    .rating-container{display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:6px}
    .star-rating .star{cursor:pointer; filter:grayscale(1)}
    .star-rating .star.active{filter:none}
    .like-btn,.dislike-btn{padding:6px 12px; border-radius:14px; background:#dedee3; color:#444}
    .like-btn.active{background:linear-gradient(45deg,#2ed573,#1dd1a1); color:#fff}
    .dislike-btn.active{background:linear-gradient(45deg,#ff4757,#ff3742); color:#fff}

    /* status pill */
    .series-pill{margin-left:auto; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; white-space:nowrap; border:1px solid transparent}
    .series-pill.status-ongoing {background:rgba(81,207,102,.16);  color:#2f9e44; border-color:#2f9e44}
    .series-pill.status-ended   {background:rgba(255,77,79,.16);  color:#d63031; border-color:#d63031}
    .series-pill.status-upcoming{background:rgba(255,212,59,.16); color:#b08900; border-color:#b08900}

    /* Binge banner */
    #bingeBanner{display:flex; align-items:center; gap:12px; padding:4px 0}
    #bingeBanner .binge-time{font-family:ui-monospace,Menlo,monospace; font-weight:900; color:#ffd43b}
    #bingeBanner .binge-label{color:#e5e7eb; opacity:.95}
    #bingeBanner .binge-cta{
      padding:8px 12px; font-size:.88rem; border-radius:16px; color:#fff;
      background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4,#feca57,#ff9ff3,#54a0ff);
      background-size:400% 400%; animation:rainbow 3s ease-in-out infinite; border:2px solid rgba(255,255,255,.85)
    }
    @keyframes rainbow{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}

    .notification{
      position:fixed; right:20px; top:20px; z-index:1000; color:#fff; font-weight:900;
      padding:12px 16px; border-radius:10px; background:var(--purple); animation:fadeout .4s ease 2.6s forwards
    }
    .notification.success{background:var(--success)}
    .notification.warning{background:var(--warning); color:#000}
    .notification.error{background:var(--danger)}
    @keyframes fadeout{to{opacity:0; transform:translateX(120%)}}

    /* Modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; z-index:10000}
    .modal{background:var(--bg); color:var(--text); max-width:680px; width:92%; border-radius:14px; border:2px solid var(--primary); padding:18px}
    .modal h3{margin:0 0 10px; color:var(--primary)}
    .modal .modal-actions{display:flex; justify-content:flex-end; gap:8px; margin-top:14px}

    /* Mobile search row fix */
    @media (max-width: 768px) {
      .search-row {
        display: flex !important;
        flex-direction: column !important;
        gap: 8px !important;
      }

      .search-input {
        width: 100% !important;
      }

      .search-filters {
        display: flex !important;
        gap: 8px !important;
      }

      #genreFilter {
        flex: 1 !important;
      }

      .search-container .btn {
        flex: 1 !important;
      }
    }
</style>
</head>

<body>
  <div class="main-container">
    <div class="header">
      <div>
        <h1 id="welcomeText" class="title" data-i18n="app_title">Flicklet</h1>
        <div class="subtitle" data-i18n="subtitle">TV & Movie Tracker</div>
        <div id="bingeBanner" class="binge-banner" aria-live="polite"></div>

        <!-- Name entry - ALWAYS VISIBLE INITIALLY -->
        <div id="nameContainer" class="name-container" style="display:flex;">
          <input id="displayNameInput" class="search-input" placeholder="Enter your name here" data-testid="name-input" />
          <button id="saveNameBtn" class="btn secondary" data-testid="save-name-button">Save</button>
        </div>

        <!-- Auth UI -->
        <div id="authBox" class="auth-box" style="display:block;">
          <button id="googleSignInBtn" class="btn" data-testid="google-signin">üîë Continue with Google</button>
          <button id="emailSignInBtn" class="btn secondary" data-testid="email-signin">‚úâÔ∏è Email Sign-In</button>
        </div>
        <div id="signedBox" class="auth-box" style="display:none; gap:8px; align-items:center">
          <span>‚úÖ Signed in as: <strong class="signed-email"></strong></span>
          <button id="signOutBtn" class="btn secondary" type="button" data-testid="signout-button">Sign Out</button>
        </div>
      </div>
      <div class="user-section">
        <button id="darkModeToggle" class="btn" data-testid="dark-mode-toggle">üåô Go Dark</button>
        <select id="langToggle" aria-label="Language" title="Language" data-testid="language-toggle">
          <option value="en">EN</option>
          <option value="es">ES</option>
        </select>
      </div>
    </div>

    <div class="tab-container">
      <button id="homeTab" class="tab active" data-testid="home-tab">üè† Home</button>
      <button id="watchingTab" class="tab" data-testid="watching-tab">‚ñ∂Ô∏è <span data-i18n="currently_watching">Currently Watching</span> <span class="tab-badge" id="watchingBadge">0</span></button>
      <button id="wishlistTab" class="tab" data-testid="wishlist-tab">üìñ <span data-i18n="want_to_watch">Want to Watch</span> <span class="tab-badge" id="wishlistBadge">0</span></button>
      <button id="watchedTab" class="tab" data-testid="watched-tab">‚úÖ <span data-i18n="already_watched">Already Watched</span> <span class="tab-badge" id="watchedBadge">0</span></button>
    </div>

    <div id="homeSection" class="tab-section">
      <div class="search-container">
        <div class="search-row">
          <input id="searchInput" class="search-input" data-testid="search-input" placeholder="Search for shows or movies‚Ä¶" />
          <select id="genreFilter" data-testid="genre-filter"><option value="">All Genres</option></select>
          <button id="searchBtn" class="btn" data-testid="search-button">üîç Search</button>
          <button id="clearSearchBtn" class="btn secondary" data-testid="clear-search">‚úñÔ∏è <span data-i18n="clear">Clear</span></button>
        </div>
      </div>

      <div id="searchResults" class="section" style="display:none">
        <h3>üéØ Search Results <span class="count" id="resultsCount">0</span></h3>
        <div id="searchResultsList" class="list-container"></div>
      </div>

      <div class="stats">
        <div class="stat" onclick="switchToTab('watching')" data-testid="watching-stat">
          <div class="stat-num" id="totalWatchingCount">0</div>
          <div class="stat-label" data-i18n="currently_watching">Currently Watching</div>
        </div>
        <div class="stat" onclick="switchToTab('wishlist')" data-testid="wishlist-stat">
          <div class="stat-num" id="totalWishlistCount">2</div>
          <div class="stat-label" data-i18n="want_to_watch">Want to Watch</div>
        </div>
        <div class="stat" onclick="switchToTab('watched')" data-testid="watched-stat">
          <div class="stat-num" id="totalWatchedCount">0</div>
          <div class="stat-label" data-i18n="already_watched">Already Watched</div>
        </div>
        <div class="stat" data-testid="total-stat">
          <div class="stat-num" id="totalCount">2</div>
          <div class="stat-label">Total</div>
        </div>
      </div>

      <div class="search-container">
        <h3 style="color:var(--primary); margin-top:0">üíæ Backup Your Questionable Taste</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px">
          <input id="importFile" type="file" accept=".json" style="max-width:220px" data-testid="import-file" />
          <button id="exportBtn" class="btn success" data-testid="export-button">üì§ Export</button>
          <button id="clearAllBtn" class="btn danger" data-testid="clear-all-button">üóëÔ∏è Nuclear Option</button>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <button id="aboutBtn" class="btn secondary" data-testid="about-button">‚ÑπÔ∏è About Flicklet</button>
          <button id="usageStatsBtn" class="btn secondary" data-testid="stats-button">üìä Usage Stats</button>
          <button id="filterBtn" class="btn secondary" data-testid="filter-button">üé≠ Show All Content</button>
        </div>
      </div>
    </div>

    <div id="watchingSection" class="tab-section" style="display:none">
      <div class="section">
        <div class="section-header"><h3>‚ñ∂Ô∏è <span data-i18n="currently_watching">Currently Watching</span> <span class="count" id="watchingCount">0</span></h3></div>
        <div id="watchingList" class="list-container" data-testid="watching-list"><div class="empty-state sassy-empty">No shows yet? What are you, productive or something? üôÑ</div></div>
      </div>
    </div>

    <div id="wishlistSection" class="tab-section" style="display:none">
      <div class="section">
        <div class="section-header"><h3>üìñ <span data-i18n="want_to_watch">Want to Watch</span> <span class="count" id="wishlistCount">0</span></h3></div>
        <div id="wishlistList" class="list-container" data-testid="wishlist-list"><div class="empty-state sassy-empty">Your wishlist is emptier than a Netflix comedy special üíÄ</div></div>
      </div>
    </div>

    <div id="watchedSection" class="tab-section" style="display:none">
      <div class="section">
        <div class="section-header"><h3>‚úÖ <span data-i18n="already_watched">Already Watched</span> <span class="count" id="watchedCount">0</span></h3></div>
        <div id="watchedList" class="list-container" data-testid="watched-list"><div class="empty-state sassy-empty">Nothing completed yet? Commitment issues much? üòè</div></div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /* ============== i18n (with snark) ============== */
    const I18N = {
      en:{ app_title:'Flicklet', subtitle:'TV & Movie Tracker', binge_total:'Total Binge Time',
           currently_watching:'Currently Watching', want_to_watch:'Want to Watch', already_watched:'Already Watched',
           streaming_on:'Streaming', clear:'Clear', series_complete:'Series Complete', coming_soon:'Coming Soon',
           currently_airing:'Currently Airing', next:'Next', last:'Last', start:'Start' },
      es:{ app_title:'Flicklet', subtitle:'Seguimiento de series y pel√≠culas', binge_total:'Tiempo total de marat√≥n',
           currently_watching:'Viendo actualmente', want_to_watch:'Quiero ver', already_watched:'Ya visto',
           streaming_on:'En', clear:'Limpiar', series_complete:'Serie terminada', coming_soon:'Pr√≥ximamente',
           currently_airing:'En emisi√≥n', next:'Pr√≥s.', last:'√ölt.', start:'Comenzar' }
    };
    function t(k){ const lang = appData?.settings?.lang || 'en'; return (I18N[lang] && I18N[lang][k]) || I18N.en[k] || k; }
    function applyTranslations(){ document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(k) el.textContent=t(k); }); }
    function formatDateShort(dateStr){
      if(!dateStr) return '';
      const lang = (appData?.settings?.lang === 'es') ? 'es-ES' : 'en-US';
      const d = new Date(dateStr); if(Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString(lang,{month:'short', day:'numeric', year:'numeric'});
    }

    /* ============== Firebase ============== */
    firebase.initializeApp({
      apiKey:"AIzaSyDEiqf8cxQJ11URcQeE8jqq5EMa5M6zAXM",
      authDomain:"flicklet-71dff.firebaseapp.com",
      projectId:"flicklet-71dff",
      storageBucket:"flicklet-71dff.firebasestorage.app",
      messagingSenderId:"1034923556763",
      appId:"1:1034923556763:web:bba5489cd1d9412c9c2b3e"
    });
    const auth = firebase.auth();
    const db   = firebase.firestore();
    let currentUser = null;

    // --- Login helpers ---
    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      return auth.signInWithPopup(provider);
    }
    function emailLogin() {
      const email = prompt('Email:'); if (!email) return;
      const pw = prompt('Password:'); if (!pw) return;
      return auth.signInWithEmailAndPassword(email, pw)
        .catch(() => auth.createUserWithEmailAndPassword(email, pw));
    }
    window.login = login; window.emailLogin = emailLogin;

    // --- Firestore sanitize (no undefined allowed) ---
    function sanitizeForFirestore(value) {
      if (value === undefined) return undefined;
      if (value === null) return null;
      const t = typeof value;
      if (t === 'string' || t === 'boolean') return value;
      if (t === 'number') return Number.isFinite(value) ? value : null;
      if (value instanceof Date) return value;
      if (Array.isArray(value)) return value.map(sanitizeForFirestore).filter(v => v !== undefined);
      if (t === 'object') {
        const out = {};
        for (const [k, v] of Object.entries(value)) {
          const c = sanitizeForFirestore(v);
          if (c !== undefined) out[k] = c;
        }
        return out;
      }
      return undefined;
    }

    async function loadUserDataFromCloud(uid) {
      try {
        const snap = await db.collection('users').doc(uid).get();
        if (!snap.exists) return;
        const cloud = snap.data() || {};
        if (cloud.watchlists) {
          if (cloud.watchlists.tv)     appData.tv     = cloud.watchlists.tv;
          if (cloud.watchlists.movies) appData.movies = cloud.watchlists.movies;
        }
        if (cloud.settings) appData.settings = { ...appData.settings, ...cloud.settings };

        const cleaned = sanitizeForFirestore({
          tv: appData.tv, movies: appData.movies, settings: appData.settings
        });
        appData.tv       = cleaned.tv       || { watching:[], wishlist:[], watched:[] };
        appData.movies   = cleaned.movies   || { watching:[], wishlist:[], watched:[] };
        appData.settings = cleaned.settings || appData.settings;

        localStorage.setItem('tvMovieTrackerData', JSON.stringify(appData));
        document.getElementById('langToggle').value = appData.settings.lang || 'en';
        applyTranslations();
        updateUI();
        showNotification('Data synced from cloud! üì±','success');
      } catch (e) {
        console.warn('load cloud failed', e);
        showNotification('Failed to load cloud data. Using local.','warning');
      }
    }

    async function saveAppData() {
      localStorage.setItem('tvMovieTrackerData', JSON.stringify(appData));
      if (!currentUser) return;
      try {
        const payload = sanitizeForFirestore({
          watchlists:{ tv: appData.tv, movies: appData.movies },
          settings: appData.settings,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
        });
        await db.collection('users').doc(currentUser.uid).set(payload,{merge:true});
      } catch (error) {
        console.error('cloud sync failed', error);
        showNotification('Cloud sync failed. Data saved locally.', 'warning');
      }
    }

    /* ============== App state ============== */
    const TMDB_IMG_BASE = 'https://image.tmdb.org/t/p/w200';
    const API_BASE      = '/.netlify/functions/tmdb';
    const appData = { tv:{watching:[],wishlist:[],watched:[]}, movies:{watching:[],wishlist:[],watched:[]}, settings:{theme:'light', displayName:'', lang:'en'} };
    let currentActiveTab = 'home';
    let searchCache = [];
    let currentPage = 1;
    let showTVOnly=false, showMoviesOnly=false;

    function showNotification(msg,type='info'){
      const n=document.createElement('div'); n.className=`notification ${type}`; n.textContent=msg; document.body.appendChild(n);
      setTimeout(()=>n.remove(),2800);
    }

    function loadAppData(){
      try{
        const saved=localStorage.getItem('tvMovieTrackerData');
        if(saved){
          const parsed=JSON.parse(saved);
          if(!parsed.tv) parsed.tv={watching:[],wishlist:[],watched:[]};
          if(!parsed.movies) parsed.movies={watching:[],wishlist:[],watched:[]};
          if(!parsed.settings) parsed.settings={theme:'light',displayName:'',lang:'en'};
          Object.assign(appData, parsed);
        }
      }catch(e){ console.warn(e); }
      if(appData.settings.theme==='dark') document.body.classList.add('dark-mode');
      document.getElementById('langToggle').value = appData.settings.lang || 'en';
      updateWelcomeText(); applyTranslations();
    }

    /* ============== Auth UI / listener ============== */
    function updateAuthUI(user){
      const loginBox  = document.getElementById('authBox');
      const signedBox = document.getElementById('signedBox');
      if (user) {
        loginBox.style.display = 'none';
        signedBox.style.display = 'flex';
        signedBox.querySelector('.signed-email').textContent = user.email || 'Signed in';
      } else {
        loginBox.style.display = 'flex';
        signedBox.style.display = 'none';
      }
    }

    auth.onAuthStateChanged(async (user)=>{
      currentUser = user;
      updateAuthUI(user);
      if(user){
        try{
          await db.collection('users').doc(user.uid).set({
            profile:{ email:user.email||'', displayName:user.displayName||'', photoURL:user.photoURL||'' },
            lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
          },{merge:true});
          await loadUserDataFromCloud(user.uid);
        }catch(e){ console.warn(e); }
      }
    });

    /* ============== Search / fetch with language ============== */
    function langQuery(){ return appData.settings.lang==='es' ? '&language=es-ES' : '&language=en-US'; }

    async function fetchShowData(query, page=1, genre=''){
      let endpoint, params;
      if(genre && !query){ endpoint='discover/tv'; params=`endpoint=${endpoint}&page=${page}&with_genres=${genre}`; }
      else{ endpoint='search/multi'; params=`endpoint=${endpoint}&page=${page}${query?`&query=${encodeURIComponent(query)}`:''}`; }

      const response = await fetch(`${API_BASE}?${params}${langQuery()}`);
      if(!response.ok) throw new Error(`Search failed: ${response.status}`);
      const data = await response.json();

      const enhanced = await Promise.all((data.results||[]).map(async (item)=>{
        try{
          if(item.media_type==='tv' || item.first_air_date){
            const r = await fetch(`${API_BASE}?endpoint=tv/${item.id}${langQuery()}`);
            if(r.ok){ const d=await r.json(); return {...item,
              status:d.status, number_of_seasons:d.number_of_seasons, number_of_episodes:d.number_of_episodes,
              last_air_date:d.last_air_date, first_air_date:d.first_air_date,
              next_episode_to_air:d.next_episode_to_air, last_episode_to_air:d.last_episode_to_air,
              in_production:d.in_production, genres:d.genres, networks:d.networks||[],
              episode_run_time:d.episode_run_time||[45],
              runtime:d.episode_run_time ? d.episode_run_time[0] : 45
            }; }
          }else if(item.media_type==='movie' || item.release_date){
            const r = await fetch(`${API_BASE}?endpoint=movie/${item.id}${langQuery()}`);
            if(r.ok){ const d=await r.json(); return {...item, status:d.status, release_date:d.release_date, genres:d.genres, runtime:d.runtime||120}; }
          }
        }catch(_){}
        return item;
      }));
      return enhanced;
    }

    async function loadGenres(){
      try{
        const r=await fetch(`${API_BASE}?endpoint=genre/tv/list${langQuery()}`);
        const data=await r.json();
        const sel=document.getElementById('genreFilter'); sel.innerHTML='<option value="">All Genres</option>';
        (data.genres||[]).forEach(g=> sel.innerHTML += `<option value="${g.id}">${g.name}</option>`);
      }catch(_){}
    }

    async function performSearch(){
      const q=document.getElementById('searchInput').value.trim();
      const g=document.getElementById('genreFilter').value;
      if(!q && !g){ showNotification('Type something. Anything. ü•¥','warning'); return; }
      document.getElementById('searchResults').style.display='block';
      const list=document.getElementById('searchResultsList');
      list.innerHTML='<div class="empty-state">Searching‚Ä¶</div>';
      try{
        const results=await fetchShowData(q,currentPage,g);
        searchCache=results; displaySearchResults(results);
      }catch(e){ list.innerHTML=`<div class="empty-state">Search died: ${e.message}</div>`; }
    }
    function displaySearchResults(results){
      const c=document.getElementById('searchResultsList');
      document.getElementById('resultsCount').textContent=results.length;
      if(!results.length){ c.innerHTML='<div class="empty-state sassy-empty">No results. Raise your standards later.</div>'; return; }
     c.innerHTML=''; results.forEach(item=> c.appendChild(createShowCard(item,true)));
   }

   /* ============== Card helpers ============== */
   function getSeriesPill(item){
     if (!item || (item.media_type!=='tv' && !item.first_air_date)) return '';

     const status    = (item.status || '').toLowerCase();            // e.g. 'returning series', 'ended', 'in production', 'planned'
     const nextAir   = item.next_episode_to_air?.air_date || null;
     const lastAir   = item.last_episode_to_air?.air_date || item.last_air_date || null;
     const firstAir  = item.first_air_date || null;

     const today = new Date(); today.setHours(0,0,0,0);
     const firstAirFuture = firstAir ? (new Date(firstAir) > today) : false;

     // Classify
     let mode; // 'ended' | 'upcoming' | 'ongoing'
     if (['ended','canceled','cancelled'].includes(status)) {
       mode = 'ended';
     } else if (
       ['planned','pilot'].includes(status) ||
       firstAirFuture ||
       (status === 'in production' && !lastAir) // only "coming soon" if nothing has aired yet
     ) {
       mode = 'upcoming';
     } else {
       // returning series, or in production *with* aired episodes
       mode = 'ongoing';
     }

     let label = '', cls = '';
     if (mode === 'ended') {
       cls   = 'status-ended';
       label = `${t('series_complete')}${lastAir ? ` ‚Ä¢ ${formatDateShort(lastAir)}` : ''}`;
     } else if (mode === 'upcoming') {
       cls   = 'status-upcoming';
       // show a date if we have one (prefer first_air_date, otherwise next if provided)
       const when = firstAir || nextAir;
       label = `${t('coming_soon')}${when ? ` ‚Ä¢ ${formatDateShort(when)}` : ''}`;
     } else {
       cls = 'status-ongoing';
       const s = item.currentSeason ? parseInt(item.currentSeason,10) : null;
       const e = item.currentEpisode ? parseInt(item.currentEpisode,10) : null;
       const total = Number.isFinite(item.number_of_episodes) ? item.number_of_episodes : null;

       const progress = (s && e && total) ? `S${s}E${e} of ${total}` :
                        (s && e) ? `S${s}E${e}` : null;

       const when = nextAir ? `${t('next')}: ${formatDateShort(nextAir)}` :
                    (lastAir ? `${t('last')}: ${formatDateShort(lastAir)}` : null);

       label = [progress || t('currently_airing'), when].filter(Boolean).join(' ‚Ä¢ ');
     }

     const title = [
       item.status || null,
       nextAir ? `Next: ${formatDateShort(nextAir)}` : null,
       lastAir ? `Last: ${formatDateShort(lastAir)}` : null
     ].filter(Boolean).join(' ‚Ä¢ ');

     return `<span class="series-pill ${cls}" title="${title}">${label}</span>`;
   }

   async function ensureTvDetails(item, card){
     if(item.media_type!=='tv' && !item.first_air_date) return;
     const needs = !(item.status && (item.next_episode_to_air || item.last_air_date) && item.networks);
     if(!needs) return;
     try{
       const r = await fetch(`${API_BASE}?endpoint=tv/${item.id}${langQuery()}`);
       if(!r.ok) return;
       const d = await r.json();
       Object.assign(item, {
         status:d.status, number_of_seasons:d.number_of_seasons, number_of_episodes:d.number_of_episodes,
         last_air_date:d.last_air_date, first_air_date:d.first_air_date,
         next_episode_to_air:d.next_episode_to_air, last_episode_to_air:d.last_episode_to_air,
         in_production:d.in_production, genres:d.genres, networks:d.networks||[],
         episode_run_time:d.episode_run_time||[45],
         runtime: item.runtime ?? (d.episode_run_time ? d.episode_run_time[0] : 45)
       });
       // Update pill + meta in-place
       const meta = card.querySelector('.show-meta');
       const pillWrap = card.querySelector('.rating-container');
       if(meta){
         const networkNames=(item.networks||[]).map(n=>n.name).join(', ');
         const date = item.first_air_date || item.release_date || '';
         const rating = item.vote_average ? Number(item.vote_average).toFixed(1) : 'N/A';
         const mediaType=item.media_type||'tv';
         meta.innerHTML = `‚≠ê ${rating}${date?` ‚Ä¢ ${date.split('-')[0]}`:''} ‚Ä¢ ${mediaType.toUpperCase()} ${networkNames?`‚Ä¢ ${t('streaming_on')}: ${networkNames}`:''}`;
       }
       if(pillWrap){
         const old = pillWrap.querySelector('.series-pill');
         if(old) old.remove();
         pillWrap.insertAdjacentHTML('beforeend', getSeriesPill(item));
       }
     }catch(_){}
   }

   function createShowCard(item, isSearch=false){
     const card=document.createElement('div'); card.className='show-card';
     const title=item.name||item.title||'Unknown Title';
     const date = item.first_air_date || item.release_date || '';
     const rating=item.vote_average ? Number(item.vote_average).toFixed(1) : 'N/A';
     const mediaType=item.media_type || (item.first_air_date ? 'tv' : 'movie');

     card.setAttribute('data-id', String(item.id));
     card.setAttribute('data-media-type', mediaType);
     card.setAttribute('data-testid', `content-card-${item.id}`);

     const poster = item.poster_path
       ? `<img class="show-poster" src="${TMDB_IMG_BASE}${item.poster_path}" alt="${title}" onclick="openTMDBLink(${item.id},'${mediaType}')" data-testid="poster-${item.id}">`
       : `<div class="poster-placeholder" onclick="openTMDBLink(${item.id},'${mediaType}')" data-testid="poster-placeholder-${item.id}">No Image</div>`;

     const runtimeMinutes = Number(item.runtime) || (mediaType==='tv'
           ? (Array.isArray(item.episode_run_time) && Number(item.episode_run_time[0])) || 45
           : 120);
     card.setAttribute('data-runtime-minutes', String(runtimeMinutes));

     const networkNames = (item.networks||[]).map(n=>n.name).join(', ');

     let actions = '';
     if(isSearch){
       const safe=JSON.stringify(item).replace(/"/g,'&quot;');
       actions = `
         <div class="show-actions">
           <button class="btn" onclick="addToList(${safe}, 'watching')" data-testid="watch-btn-${item.id}">‚ñ∂Ô∏è ${t('currently_watching')}</button>
           <button class="btn" onclick="addToList(${safe}, 'wishlist')" data-testid="wishlist-btn-${item.id}">üìñ ${t('want_to_watch')}</button>
           <button class="btn" onclick="addToList(${safe}, 'watched')" data-testid="watched-btn-${item.id}">‚úÖ ${t('already_watched')}</button>
         </div>`;
     }else{
       const likeStatus=item.likeStatus||'none';
       const userRating=item.userRating||0;
       actions = `
         <div class="rating-container">
           <span>Your Rating:</span>
           <div class="star-rating" data-testid="star-rating-${item.id}">
             ${[1,2,3,4,5].map(n=>`<span class="star ${n<=userRating?'active':''}" data-rating="${n}" onclick="setRating(${item.id},${n})" data-testid="star-${item.id}-${n}">‚≠ê</span>`).join('')}
           </div>
           <div class="like-dislike">
             <button class="like-btn ${likeStatus==='like'?'active':''}" onclick="setLikeStatus(${item.id}, 'like')" data-testid="like-btn-${item.id}">üëç</button>
             <button class="dislike-btn ${likeStatus==='dislike'?'active':''}" onclick="setLikeStatus(${item.id}, 'dislike')" data-testid="dislike-btn-${item.id}">üëé</button>
           </div>
           ${mediaType==='tv' ? getSeriesPill(item) : ''}
         </div>

         <div class="show-actions" style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
           <button class="btn secondary" onclick="moveItem(${item.id}, 'watching')" data-testid="move-watching-${item.id}">‚Üí ${t('currently_watching')}</button>
           <button class="btn secondary" onclick="moveItem(${item.id}, 'wishlist')" data-testid="move-wishlist-${item.id}">‚Üí ${t('want_to_watch')}</button>
           <button class="btn secondary" onclick="moveItem(${item.id}, 'watched')" data-testid="move-watched-${item.id}">‚Üí ${t('already_watched')}</button>
           <button class="btn danger" onclick="removeItemFromCurrentList(${item.id})" data-testid="remove-btn-${item.id}">üóëÔ∏è Remove</button>
         </div>`;
     }

     card.innerHTML = `
       ${poster}
       <div class="show-details">
         <h4 class="show-title" onclick="openTMDBLink(${item.id},'${mediaType}')" data-testid="title-${item.id}">${title} <span style="opacity:.6">üîó</span></h4>
         <div class="show-meta" data-testid="meta-${item.id}">‚≠ê ${rating} ${date?`‚Ä¢ ${date.split('-')[0]}`:''} ‚Ä¢ ${mediaType.toUpperCase()} ${networkNames?`‚Ä¢ ${t('streaming_on')}: ${networkNames}`:''}</div>
         <div class="show-overview" data-testid="overview-${item.id}">${item.overview||'No description.'}</div>
         ${actions}
       </div>`;

     ensureTvDetails(item, card);
     return card;
   }

   function openTMDBLink(id, type){ window.open(`https://www.themoviedb.org/${type}/${id}`,'_blank'); }

   /* ============== List ops ============== */
   function addToList(item, list){
     const cat = (item.media_type==='tv'||item.first_air_date)?'tv':'movies';
     const exists = appData[cat][list].some(s=>s.id===item.id);
     if(!exists) appData[cat][list].unshift(item);
     saveAppData(); updateUI();
   }
   function moveItem(id, dest){
     const item=findItem(id); if(!item) return;
     ['tv','movies'].forEach(cat=> ['watching','wishlist','watched'].forEach(lst=>{
       appData[cat][lst]=appData[cat][lst].filter(s=>s.id!==id);
     }));
     const cat=item.media_type==='tv'?'tv':'movies';
     appData[cat][dest].unshift(item);
     saveAppData(); updateUI();
   }
   function setRating(id, rating){ const it=findItem(id); if(!it) return; it.userRating=rating; saveAppData(); updateUI(); }
   function setLikeStatus(id,status){ const it=findItem(id); if(!it) return; it.likeStatus=status; saveAppData(); updateUI(); }
   function removeItemFromCurrentList(id){
     const item=findItem(id); if(!item) return;
     if(!confirm(`Remove "${item.title||item.name}" from this list?`)) return;
     ['tv','movies'].forEach(cat=> ['watching','wishlist','watched'].forEach(lst=>{
       appData[cat][lst]=appData[cat][lst].filter(s=>s.id!==id);
     }));
     saveAppData(); updateUI();
   }
   function findItem(id){
     for(const cat of ['tv','movies']){
       for(const lst of ['watching','wishlist','watched']){
         const f=appData[cat][lst].find(s=>s.id===id);
         if(f) return f;
       }
     }
     return null;
   }

   /* ============== Binge calc / banner / meter ============== */
   function calculateBingeTime({scope='watching'}={}){
     let roots=[];
     if(scope==='watching'){ const w=document.getElementById('watchingList'); if(w) roots=[w]; }
     else { roots=[document]; }
     const cards=roots.flatMap(r=> Array.from(r.querySelectorAll('.show-card[data-runtime-minutes]')));
     const total = cards.reduce((m,c)=> m + (parseInt(c.getAttribute('data-runtime-minutes'))||0), 0);
     const h=Math.floor(total/60), m=total%60, d=Math.floor(h/24), rh=h%24;
     let str=''; if(d) str+=`${d}d `; if(rh) str+=`${rh}h `; str+=`${m}m`;
     return { totalMinutes:total, timeStr:str, showCount:cards.length };
   }
function updateBingeMeter(){
  const stats=calculateBingeTime();
  const container=document.querySelector('.stats'); if(!container) return;
  let el=document.getElementById('bingeMeter');
  if(!el){ 
    el=document.createElement('div'); 
    el.id='bingeMeter'; 
    el.className='stat';
    // FORCE the grid positioning via JavaScript
    el.style.gridColumn = '2 / 4';
    el.style.gridRow = '2';
    container.appendChild(el); 
  }
  el.innerHTML=`<div class="stat-num">${stats.timeStr}</div><div class="stat-label">${t('binge_total')}</div>`;
}
   function updateBingeBanner(){
     const stats=calculateBingeTime({scope:'watching'});
     const banner=document.getElementById('bingeBanner'); if(!banner) return;
     const es = [
       "de decisiones cuestionables en cola. üé≠",
       "de procrastinaci√≥n medida con precisi√≥n. ü§°",
       "de verg√ºenza en streaming calculada. üì∫",
       "de marat√≥n sin arrepentimientos (mentira). üçø"
     ];
     const en = [
       "of questionable life choices queued! üé≠",
       "of procrastination precisely measured. ü§°",
       "of streaming shame calculated. üì∫",
       "of binge you definitely won't regret. üçø"
     ];
     const msg = (appData.settings.lang==='es' ? es : en)[Math.floor(Math.random()*4)];
     banner.innerHTML = `
       <span class="binge-time" id="bingeTimeText" data-testid="binge-time">${stats.timeStr}</span>
       <span class="binge-label">${msg}</span>
       <button class="binge-cta" id="startBingeBtn" type="button" aria-label="${t('start')}" data-testid="start-binge-button">${t('start')} ‚ñ∂</button>
     `;
     document.getElementById('startBingeBtn')?.addEventListener('click', ()=>{
       switchToTab('watching');
       setTimeout(()=>document.getElementById('watchingList')?.scrollIntoView({behavior:'smooth',block:'start'}), 120);
     });
   }

   /* ============== UI update (with counts patch) ============== */
   function updateUI(){
     const totals={
       watching: appData.tv.watching.length + appData.movies.watching.length,
       wishlist: appData.tv.wishlist.length + appData.movies.wishlist.length,
       watched:  appData.tv.watched.length  + appData.movies.watched.length
     };

     const idMap = {
       watching: ['watchingBadge','watchingCount','totalWatchingCount'],
       wishlist: ['wishlistBadge','wishlistCount','totalWishlistCount'],
       watched:  ['watchedBadge','watchedCount','totalWatchedCount'],
     };
     Object.entries(idMap).forEach(([key, ids])=>{
       ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent = totals[key]; });
     });
     const totalCountEl=document.getElementById('totalCount');
     if(totalCountEl) totalCountEl.textContent = totals.watching + totals.wishlist + totals.watched;

     const watching=[...appData.tv.watching,...appData.movies.watching];
     const wishlist=[...appData.tv.wishlist,...appData.movies.wishlist];
     const watched =[...appData.tv.watched, ...appData.movies.watched];

     function filter(items){
       if(showTVOnly) return items.filter(it=> (it.media_type||'tv')==='tv');
       if(showMoviesOnly) return items.filter(it=> (it.media_type||'movie')==='movie');
       return items;
     }
     updateList('watchingList', filter(watching));
     updateList('wishlistList', filter(wishlist));
     updateList('watchedList',  filter(watched));

     updateBingeMeter();
     updateBingeBanner();
     applyTranslations();
   }

   function updateList(containerId, items){
     const c=document.getElementById(containerId); if(!c) return;
     if(!items.length){
       const msg = containerId==='watchingList' ? 'No shows yet? What are you, productive or something? üôÑ'
                 : containerId==='wishlistList' ? 'Your wishlist is emptier than a Netflix comedy special üíÄ'
                 : 'Nothing completed yet? Commitment issues much? üòè';
       c.innerHTML=`<div class="empty-state sassy-empty">${msg}</div>`;
       return;
     }
     c.innerHTML=''; items.forEach(it=> c.appendChild(createShowCard(it,false)));
   }

   /* ============== Tabs / controls / modals ============== */
   function switchToTab(tab){
     currentActiveTab=tab;
     document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
     document.getElementById(tab+'Tab').classList.add('active');
     document.querySelectorAll('.tab-section').forEach(s=> s.style.display='none');
     document.getElementById(tab+'Section').style.display='block';
   }

   function hideNameContainer(){ 
     const container = document.getElementById('nameContainer');
     if(container) container.style.display='none'; 
   }
   function showNameContainer(){ 
     const container = document.getElementById('nameContainer');
     if(container) container.style.display='flex'; 
   }

function updateWelcomeText(){
  const n=(appData.settings.displayName||'').trim();
  const pool=["Chaos","Questionable Taste","Binge Empire","Streaming Madness","Watch List Anarchy"];
  const welcomeEl = document.getElementById('welcomeText');
  if(welcomeEl) {
    welcomeEl.textContent = n ? `${n}'s ${pool[Math.floor(Math.random()*pool.length)]}` : t('app_title');
  }
  
  // ALWAYS show name container so users can change their name
  const nameContainer = document.getElementById('nameContainer');
  if(nameContainer) {
    nameContainer.style.display = 'flex';
  }
}

   function toggleContentFilter(){
     const btn=document.getElementById('filterBtn');
     if(!showTVOnly && !showMoviesOnly){ showTVOnly=true; btn.textContent='üì∫ Show TV Only'; }
     else if(showTVOnly){ showTVOnly=false; showMoviesOnly=true; btn.textContent='üé¨ Show Movies Only'; }
     else { showMoviesOnly=false; btn.textContent='üé≠ Show All Content'; }
     updateUI();
   }

   function openModal(title, html, testId = 'generic-modal') {
     const wrap = document.createElement('div');
     wrap.className = 'modal-backdrop';
     wrap.setAttribute('data-testid', 'modal-backdrop');

     wrap.innerHTML = `
       <div class="modal" data-testid="${testId}">
         <h3>${title}</h3>
         <div class="modal-body">${html}</div>
         <div class="modal-actions">
           <button class="btn secondary" data-testid="modal-close" type="button">Close</button>
         </div>
       </div>
     `;

     document.body.appendChild(wrap);

     const close = () => wrap.remove();
     wrap.addEventListener('click', (e) => { if (e.target === wrap) close(); });
     wrap.querySelector('[data-testid="modal-close"]').addEventListener('click', close);
   }

   function showAboutModal() {
     openModal('About Flicklet', `
       <p><strong>Flicklet</strong> tracks TV & movies, syncs to the cloud, and provides premium-grade snark while you procrastinate.</p>
       <p>Built with Capacitor + Firebase + TMDB.</p>
     `, 'about-modal');
   }

   function showStatsModal() {
     const totals = {
       tv: appData.tv.watching.length + appData.tv.wishlist.length + appData.tv.watched.length,
       movies: appData.movies.watching.length + appData.movies.wishlist.length + appData.movies.watched.length
     };
     const binge = calculateBingeTime();
     openModal('Usage Stats', `
       <ul>
         <li>Total items: <strong>${totals.tv + totals.movies}</strong></li>
         <li>TV: <strong>${totals.tv}</strong> ‚Ä¢ Movies: <strong>${totals.movies}</strong></li>
         <li>${t('binge_total')}: <strong>${binge.timeStr}</strong></li>
       </ul>
     `, 'stats-modal');
   }

   /* ============== bootstrap ============== */
   document.addEventListener('DOMContentLoaded', ()=>{
     loadAppData(); loadGenres(); updateUI();

     // tabs
     document.getElementById('homeTab').onclick = ()=>switchToTab('home');
     document.getElementById('watchingTab').onclick = ()=>switchToTab('watching');
     document.getElementById('wishlistTab').onclick = ()=>switchToTab('wishlist');
     document.getElementById('watchedTab').onclick = ()=>switchToTab('watched');

     // theme + language
     const darkBtn = document.getElementById('darkModeToggle');
     const setDarkLabel = () => {
       const dark = document.body.classList.contains('dark-mode');
       darkBtn.textContent = dark ? '‚òÄÔ∏è Go Light' : 'üåô Go Dark';
     };
     setDarkLabel();
     darkBtn.onclick = ()=>{
       document.body.classList.toggle('dark-mode');
       appData.settings.theme = document.body.classList.contains('dark-mode')?'dark':'light';
       setDarkLabel(); saveAppData();
     };

     document.getElementById('langToggle').addEventListener('change', async (e)=>{
       appData.settings.lang = e.target.value || 'en';
       saveAppData(); applyTranslations(); await loadGenres();
       // refresh on-card details for localized metadata
       document.querySelectorAll('.show-card[data-media-type="tv"]').forEach(card=>{
         const id=card.getAttribute('data-id'); const item=findItem(Number(id)); if(item) ensureTvDetails(item, card);
       });
       if(document.getElementById('searchResults').style.display!=='none'){ performSearch(); }
       updateUI();
     });

     // name save - FIXED
     document.getElementById('saveNameBtn').onclick = ()=>{
       const val = (document.getElementById('displayNameInput').value||'').trim();
       appData.settings.displayName = val; 
       saveAppData(); 
       updateWelcomeText();
       if(val) {
         showNotification('Name saved! üí§', 'success');
       }
     };

     // auth buttons (inline)
     document.getElementById('googleSignInBtn').onclick = ()=>login();
     document.getElementById('emailSignInBtn').onclick  = ()=>emailLogin();
     document.getElementById('signOutBtn').onclick      = ()=>auth.signOut();

     // search
     document.getElementById('searchBtn').onclick=performSearch;
     document.getElementById('clearSearchBtn').onclick=()=>{
       document.getElementById('searchInput').value=''; document.getElementById('genreFilter').value='';
       document.getElementById('searchResults').style.display='none';
     };
     document.getElementById('searchInput').addEventListener('keydown', e=>{ if(e.key==='Enter') performSearch(); });

     // backup/actions
     document.getElementById('exportBtn').onclick=()=>{
       const blob=new Blob([JSON.stringify(appData,null,2)],{type:'application/json'});
       const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`flicklet-backup.json`;
       document.body.appendChild(a); a.click(); a.remove();
     };
     document.getElementById('importFile').onchange=(e)=>{
       const f=e.target.files[0]; if(!f) return; const r=new FileReader();
       r.onload=()=>{ try{ const d=JSON.parse(r.result); Object.assign(appData,d); saveAppData(); updateUI(); }catch{ showNotification('Broken file.','error'); } };
       r.readAsText(f);
     };
     document.getElementById('clearAllBtn').onclick=()=>{
       if(!confirm('This wipes everything. You sure?')) return;
       appData.tv={watching:[],wishlist:[],watched:[]}; appData.movies={watching:[],wishlist:[],watched:[]}; saveAppData(); updateUI();
     };
     document.getElementById('aboutBtn').onclick=showAboutModal;
     document.getElementById('usageStatsBtn').onclick=showStatsModal;
     document.getElementById('filterBtn').onclick=toggleContentFilter;
   });

 </script>
</body>
</html>