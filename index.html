<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Flicklet - TV & Movie Tracker</title>
  <meta name="description" content="Search, track, and rate shows & films fast. Never lose track of your binge-watching again!" />

  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icons/icon-512.png" />

  <style>
    :root{
      --bg:#fff; --text:#000; --primary:#ff6b6b; --card:#f9f9f9; --border:#ddd;
      --success:#51cf66; --warning:#ffd43b; --danger:#ff6b6b; --purple:#845ec2;
    }
    *{box-sizing:border-box}
    body{
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:var(--text); margin:0; padding:20px; min-height:100vh;
    }
    .dark-mode{
      --bg:#1a1a1a; --text:#f5f5f5; --card:#2d2d2d; --border:#444;
      background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%) !important;
    }
    .main-container{
      max-width:1200px; margin:0 auto; background:var(--bg); border-radius:20px; padding:30px;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
    }
    .header{display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; border-bottom:3px dashed var(--primary); padding-bottom:18px; margin-bottom:24px}
    .title{margin:0; font-size:2.4rem; color:var(--primary); font-weight:800}
    .subtitle{margin-top:4px; color:#777}
    .user-section{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    #langToggle{
      padding:8px 10px; border-radius:14px; border:2px solid var(--border);
      background:var(--card); color:var(--text); font-weight:700;
    }

    .tab-container{display:flex; gap:6px; background:var(--card); padding:8px; border-radius:12px; margin:18px 0}
    .tab{flex:1; border:0; background:transparent; padding:14px; border-radius:10px; font-weight:700; cursor:pointer}
    .tab.active{background:linear-gradient(45deg,var(--primary),var(--purple)); color:#fff}
    .tab-badge{background:#fff; color:var(--primary); border-radius:12px; padding:2px 8px; font-size:12px; margin-left:6px}

    .search-container{background:var(--card); border:2px solid var(--primary); border-radius:16px; padding:16px; margin:18px 0}
    .search-row{display:flex; gap:10px; flex-wrap:wrap}
    .search-input{flex:1; min-width:240px; padding:10px; border-radius:12px; border:2px solid var(--border); background:var(--bg); color:var(--text)}
    button{
      border:0; background:linear-gradient(45deg,var(--primary),var(--purple)); color:#fff; border-radius:20px;
      padding:10px 16px; font-weight:700; cursor:pointer
    }
    button.secondary{background:linear-gradient(45deg,#747d8c,#57606f)}
    button.success{background:linear-gradient(45deg,#2ed573,#1dd1a1)}
    button.danger{background:linear-gradient(45deg,#ff4757,#ff3742)}

    .stats{display:flex; flex-wrap:wrap; gap:14px; margin:18px 0}
    .stat{flex:1; min-width:140px; background:var(--card); border:2px solid var(--primary); border-radius:14px; padding:16px; text-align:center}
    .stat-num{font-size:2rem; color:var(--primary); font-weight:800}
    .stat-label{font-size:.75rem; color:#777; text-transform:uppercase; font-weight:800}

    .list-container{background:var(--card); border:3px dashed var(--border); border-radius:12px; padding:16px; min-height:80px}
    .show-card{display:flex; gap:16px; border:2px solid var(--border); border-radius:12px; padding:16px; margin:12px 0; background:var(--bg)}
    .show-poster{width:90px; height:135px; border-radius:8px; object-fit:cover; cursor:pointer}
    .poster-placeholder{width:90px; height:135px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#eee; color:#777; font-size:12px}
    .show-details{flex:1; display:flex; flex-direction:column}
    .show-title{margin:0 0 6px 0; color:var(--primary); font-size:1.15rem; display:flex; gap:8px; align-items:center; cursor:pointer}
    .show-meta{color:#888; font-size:.9rem; margin-bottom:8px}
    .show-overview{font-size:.95rem; line-height:1.5; margin-bottom:10px}
    .rating-container{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .star-rating .star{cursor:pointer; filter:grayscale(1)}
    .star-rating .star.active{filter:none}
    .like-btn,.dislike-btn{padding:6px 12px; border-radius:14px; background:#ddd; color:#444}
    .like-btn.active{background:linear-gradient(45deg,#2ed573,#1dd1a1); color:#fff}
    .dislike-btn.active{background:linear-gradient(45deg,#ff4757,#ff3742); color:#fff}

    /* pill at far right of rating row */
    .series-pill{margin-left:auto; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800; white-space:nowrap; border:1px solid transparent}
    .series-pill.status-ongoing {background:rgba(81,207,102,.15);  color:#37b24d; border-color:#37b24d}
    .series-pill.status-ended   {background:rgba(255,71,87,.15);   color:#ff4757; border-color:#ff4757}
    .series-pill.status-upcoming{background:rgba(255,212,59,.15);  color:#f59f00; border-color:#f59f00}

    .tags-container button:empty{display:none !important}

    .empty-state{padding:30px; text-align:center; color:#777}
    .sassy-empty{color:var(--primary); font-weight:800}

    .notification{
      position:fixed; right:20px; top:20px; z-index:1000; color:#fff; font-weight:800;
      padding:12px 16px; border-radius:10px; background:var(--purple); animation:fadeout .4s ease 2.6s forwards
    }
    .notification.success{background:var(--success)}
    .notification.warning{background:var(--warning); color:#000}
    .notification.error{background:var(--danger)}
    @keyframes fadeout{to{opacity:0; transform:translateX(120%)}}

    /* Binge banner */
    #bingeBanner{display:flex; align-items:center; gap:12px; padding:4px 0}
    #bingeBanner .binge-time{font-family:ui-monospace,Menlo,monospace; font-weight:800; color:var(--warning)}
    #bingeBanner .binge-label{color:#e5e7eb; opacity:.95}
    #bingeBanner .binge-cta{
      padding:8px 14px; font-size:.9rem; border-radius:18px; color:#fff;
      background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4,#feca57,#ff9ff3,#54a0ff);
      background-size:400% 400%; animation:rainbow 3s ease-in-out infinite; border:2px solid #fff
    }
    @keyframes rainbow{
      0%,100%{background-position:0% 50%}
      50%{background-position:100% 50%}
    }

    /* basic modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; z-index:10000}
    .modal{background:var(--bg); color:var(--text); max-width:680px; width:92%; border-radius:14px; border:2px solid var(--primary); padding:18px}
    .modal h3{margin:0 0 10px 0; color:var(--primary)}
    .modal .modal-actions{display:flex; justify-content:flex-end; gap:8px; margin-top:14px}
  </style>
</head>

<body>
  <div class="main-container">
    <div class="header">
      <div>
        <h1 id="welcomeText" class="title" data-i18n="app_title">Flicklet</h1>
        <div class="subtitle" data-i18n="subtitle">TV & Movie Tracker</div>
        <!-- In-your-face binge banner -->
        <div id="bingeBanner" class="binge-banner" aria-live="polite"></div>
      </div>
      <div class="user-section">
        <div id="nameContainer" class="name-container">
          <div class="name-instruction">üëÜ Add your name for a personal touch!</div>
          <input id="displayNameInput" class="name-input" placeholder="Your name here..." />
        </div>
        <button id="darkModeToggle">üåô Go Dark</button>
        <select id="langToggle" aria-label="Language" title="Language">
          <option value="en">EN</option>
          <option value="es">ES</option>
        </select>
      </div>
    </div>

    <div class="tab-container">
      <button id="homeTab" class="tab active" data-testid="home-tab">üè† Home</button>
      <button id="watchingTab" class="tab" data-testid="watching-tab">‚ñ∂Ô∏è <span data-i18n="currently_watching">Currently Watching</span> <span class="tab-badge" id="watchingBadge">0</span></button>
      <button id="wishlistTab" class="tab" data-testid="wishlist-tab">üìñ <span data-i18n="want_to_watch">Want to Watch</span> <span class="tab-badge" id="wishlistBadge">0</span></button>
      <button id="watchedTab" class="tab" data-testid="watched-tab">‚úÖ <span data-i18n="already_watched">Already Watched</span> <span class="tab-badge" id="watchedBadge">0</span></button>
    </div>

    <div id="homeSection" class="tab-section">
      <!-- Auth box -->
      <div id="authSection" class="search-container" style="display:none">
        <h3 id="authTitle" data-i18n="sign_in_title">üîê Sign In to Sync Your Data</h3>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <button id="googleSignIn" style="background:#4285f4">üì± Sign in with Google</button>
          <button id="emailSignIn"  class="secondary">üìß Sign in with Email</button>
          <button id="signOut" class="danger" style="display:none">üö™ Sign Out</button>
        </div>
        <div id="authStatus" style="margin-top:8px; font-weight:800"></div>
      </div>

      <div class="search-container">
        <div class="search-row">
          <input id="searchInput" class="search-input" data-testid="search-input" placeholder="Search for shows or movies..." />
          <select id="genreFilter"><option value="">All Genres</option></select>
          <button id="searchBtn" data-testid="search-button">üîç Search</button>
          <button id="clearSearchBtn" class="secondary" style="display:none">‚úñÔ∏è <span data-i18n="clear">Clear</span></button>
        </div>
      </div>

      <div id="searchResults" class="section" style="display:none">
        <h3>üéØ Search Results <span class="count" id="resultsCount">0</span></h3>
        <div id="searchResultsList" class="list-container"></div>
      </div>

      <div class="stats">
        <div class="stat" onclick="switchToTab('watching')">
          <div class="stat-num" id="totalWatchingCount">0</div>
          <div class="stat-label" data-i18n="currently_watching">Currently Watching</div>
        </div>
        <div class="stat" onclick="switchToTab('wishlist')">
          <div class="stat-num" id="totalWishlistCount">0</div>
          <div class="stat-label" data-i18n="want_to_watch">Want to Watch</div>
        </div>
        <div class="stat" onclick="switchToTab('watched')">
          <div class="stat-num" id="totalWatchedCount">0</div>
          <div class="stat-label" data-i18n="already_watched">Already Watched</div>
        </div>
        <div class="stat">
          <div class="stat-num" id="totalCount">0</div>
          <div class="stat-label">Total</div>
        </div>
      </div>

      <div class="search-container">
        <h3 style="color:var(--primary); margin-top:0">üíæ Backup Your Questionable Taste</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px">
          <input id="importFile" type="file" accept=".json" style="max-width:220px" />
          <button id="exportBtn" class="success" data-testid="export-button">üì§ Export</button>
          <button id="clearAllBtn" class="danger" data-testid="clear-all-button">üóëÔ∏è Nuclear Option</button>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <button id="aboutBtn" class="secondary" data-testid="about-button">‚ÑπÔ∏è About Flicklet</button>
          <button id="usageStatsBtn" class="secondary" data-testid="stats-button">üìä Usage Stats</button>
          <button id="filterBtn" class="secondary">üé≠ Show All Content</button>
        </div>
      </div>
    </div>

    <div id="watchingSection" class="tab-section" style="display:none">
      <div class="section">
        <div class="section-header"><h3>‚ñ∂Ô∏è <span data-i18n="currently_watching">Currently Watching</span> <span class="count" id="watchingCount">0</span></h3></div>
        <div id="watchingList" class="list-container"><div class="empty-state sassy-empty">No shows yet? What are you, productive or something? üôÑ</div></div>
      </div>
    </div>

    <div id="wishlistSection" class="tab-section" style="display:none">
      <div class="section">
        <div class="section-header"><h3>üìñ <span data-i18n="want_to_watch">Want to Watch</span> <span class="count" id="wishlistCount">0</span></h3></div>
        <div id="wishlistList" class="list-container"><div class="empty-state sassy-empty">Your wishlist is emptier than a Netflix comedy special üíÄ</div></div>
      </div>
    </div>

    <div id="watchedSection" class="tab-section" style="display:none">
      <div class="section">
        <div class="section-header"><h3>‚úÖ <span data-i18n="already_watched">Already Watched</span> <span class="count" id="watchedCount">0</span></h3></div>
        <div id="watchedList" class="list-container"><div class="empty-state sassy-empty">Nothing completed yet? Commitment issues much? üòè</div></div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ---- i18n (snark included) ----
    const I18N = {
      en:{
        app_title:'Flicklet',
        subtitle:'TV & Movie Tracker',
        sign_in_title:'üîê Sign In to Sync Your Data',
        cloud_on:'Cloud Sync: On',
        binge_total:'Total Binge Time',
        start:'Start',
        currently_watching:'Currently Watching',
        want_to_watch:'Want to Watch',
        already_watched:'Already Watched',
        streaming_on:'Streaming',
        clear:'Clear',
        series_complete:'Series Complete',
        coming_soon:'Coming Soon',
        currently_airing:'Currently Airing',
        next:'Next',
        last:'Last'
      },
      es:{
        app_title:'Flicklet',
        subtitle:'Seguimiento de series y pel√≠culas',
        sign_in_title:'üîê Inicia sesi√≥n para sincronizar tus datos',
        cloud_on:'Sincronizaci√≥n en la nube: activa',
        binge_total:'Tiempo total de marat√≥n',
        start:'Comenzar',
        currently_watching:'Viendo actualmente',
        want_to_watch:'Quiero ver',
        already_watched:'Ya visto',
        streaming_on:'En',
        clear:'Limpiar',
        series_complete:'Serie terminada',
        coming_soon:'Pr√≥ximamente',
        currently_airing:'En emisi√≥n',
        next:'Pr√≥x.',
        last:'√ölt.'
      }
    };
    function t(k){ const lang = appData?.settings?.lang || 'en'; return (I18N[lang] && I18N[lang][k]) || I18N.en[k] || k; }
    function applyTranslations(){ document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(k) el.textContent=t(k); }); }
    function formatDateShort(dateStr){
      if(!dateStr) return '';
      const lang = (appData?.settings?.lang === 'es') ? 'es-ES' : 'en-US';
      const d = new Date(dateStr); if(Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString(lang,{month:'short', day:'numeric', year:'numeric'});
    }

    // ---- Firebase ----
    firebase.initializeApp({
      apiKey:"AIzaSyDEiqf8cxQJ11URcQeE8jqq5EMa5M6zAXM",
      authDomain:"flicklet-71dff.firebaseapp.com",
      projectId:"flicklet-71dff",
      storageBucket:"flicklet-71dff.firebasestorage.app",
      messagingSenderId:"1034923556763",
      appId:"1:1034923556763:web:bba5489cd1d9412c9c2b3e"
    });
    const auth = firebase.auth();
    const db   = firebase.firestore();
    let currentUser = null;

    auth.onAuthStateChanged(async (user)=>{
      currentUser = user;
      updateAuthUI(user);
      if(user){
        try{
          await db.collection('users').doc(user.uid).set({
            profile:{ email:user.email||'', displayName:user.displayName||'', photoURL:user.photoURL||'' },
            lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
          },{merge:true});
          await loadUserDataFromCloud(user.uid);
        }catch(e){ console.warn(e); }
      }
    });

    // ---- App data & helpers ----
    const TMDB_IMG_BASE = 'https://image.tmdb.org/t/p/w200';
    const API_BASE      = '/.netlify/functions/tmdb';
    const appData = { tv:{watching:[],wishlist:[],watched:[]}, movies:{watching:[],wishlist:[],watched:[]}, settings:{theme:'light', displayName:'', lang:'en'} };
    let currentActiveTab = 'home';
    let searchCache = [];
    let currentPage = 1;
    let showTVOnly=false, showMoviesOnly=false;

    function showNotification(msg,type='info'){
      const n=document.createElement('div'); n.className=`notification ${type}`; n.textContent=msg; document.body.appendChild(n);
      setTimeout(()=>n.remove(),2800);
    }
    function openModal(title, html){
      const wrap=document.createElement('div'); wrap.className='modal-backdrop';
      wrap.innerHTML=`<div class="modal"><h3>${title}</h3><div class="modal-body">${html}</div><div class="modal-actions"><button class="secondary" id="modalClose">Close</button></div></div>`;
      document.body.appendChild(wrap);
      wrap.addEventListener('click',e=>{ if(e.target===wrap) wrap.remove(); });
      wrap.querySelector('#modalClose').onclick=()=>wrap.remove();
    }
    function showRandomTip(arr){ showNotification(arr[Math.floor(Math.random()*arr.length)], 'info'); }

    function loadAppData(){
      try{
        const saved=localStorage.getItem('tvMovieTrackerData');
        if(saved){
          const parsed=JSON.parse(saved);
          if(!parsed.tv) parsed.tv={watching:[],wishlist:[],watched:[]};
          if(!parsed.movies) parsed.movies={watching:[],wishlist:[],watched:[]};
          if(!parsed.settings) parsed.settings={theme:'light',displayName:'',lang:'en'};
          Object.assign(appData, parsed);
        }
      }catch(e){ console.warn(e); }
      if(appData.settings.theme==='dark') document.body.classList.add('dark-mode');
      document.getElementById('displayNameInput').value = appData.settings.displayName || '';
      document.getElementById('langToggle').value = appData.settings.lang || 'en';
      updateWelcomeText(); applyTranslations();
    }
    async function saveAppData(){
      localStorage.setItem('tvMovieTrackerData', JSON.stringify(appData));
      if(!currentUser) return;
      try{
        await db.collection('users').doc(currentUser.uid).set({
          watchlists:{ tv:appData.tv, movies:appData.movies },
          settings:appData.settings,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        },{merge:true});
      }catch(e){ console.warn('cloud sync failed', e); }
    }
    async function loadUserDataFromCloud(uid){
      try{
        const snap=await db.collection('users').doc(uid).get();
        if(snap.exists){
          const cloud=snap.data();
          if(cloud.watchlists){ appData.tv=cloud.watchlists.tv||appData.tv; appData.movies=cloud.watchlists.movies||appData.movies; }
          if(cloud.settings){ appData.settings={...appData.settings, ...cloud.settings}; }
          localStorage.setItem('tvMovieTrackerData', JSON.stringify(appData));
          document.getElementById('langToggle').value = appData.settings.lang || 'en';
          applyTranslations();
          updateUI();
          showNotification('Data synced from cloud! üìÅ','success');
        }
      }catch(e){ console.warn(e); }
    }

    function updateAuthUI(user){
      const s=document.getElementById('authSection');
      if(!s) return;
      const title=document.getElementById('authTitle');
      const status=document.getElementById('authStatus');
      const g=document.getElementById('googleSignIn'), e=document.getElementById('emailSignIn'), o=document.getElementById('signOut');
      if(user){
        if(title){ title.style.display='none'; }
        status.textContent=`‚úÖ Signed in as: ${user.email}`; status.style.color='var(--success)';
        g.style.display='none'; e.style.display='none'; o.style.display='inline-block';
      }else{
        if(title){ title.style.display=''; title.textContent=t('sign_in_title'); }
        status.textContent='‚ùå Not signed in - data stays local only'; status.style.color='var(--danger)';
        g.style.display='inline-block'; e.style.display='inline-block'; o.style.display='none';
      }
    }

    // ---- Search / fetch with language ----
    async function fetchShowData(query, page=1, genre=''){
      const langParam = (appData.settings.lang==='es') ? '&language=es-ES' : '&language=en-US';
      let endpoint, params;
      if(genre && !query){ endpoint='discover/tv'; params=`endpoint=${endpoint}&page=${page}&with_genres=${genre}`; }
      else{ endpoint='search/multi'; params=`endpoint=${endpoint}&page=${page}${query?`&query=${encodeURIComponent(query)}`:''}`; }

      const response = await fetch(`${API_BASE}?${params}${langParam}`);
      if(!response.ok) throw new Error(`Search failed: ${response.status}`);
      const data = await response.json();

      const enhanced = await Promise.all((data.results||[]).map(async (item)=>{
        try{
          if(item.media_type==='tv' || item.first_air_date){
            const r = await fetch(`${API_BASE}?endpoint=tv/${item.id}${langParam}`);
            if(r.ok){ const d=await r.json(); return {...item,
              status:d.status, number_of_seasons:d.number_of_seasons, number_of_episodes:d.number_of_episodes,
              last_air_date:d.last_air_date, first_air_date:d.first_air_date,
              next_episode_to_air:d.next_episode_to_air, last_episode_to_air:d.last_episode_to_air,
              in_production:d.in_production, genres:d.genres, networks:d.networks||[],
              episode_run_time:d.episode_run_time||[45],
              runtime:d.episode_run_time ? d.episode_run_time[0] : 45
            }; }
          }else if(item.media_type==='movie' || item.release_date){
            const r = await fetch(`${API_BASE}?endpoint=movie/${item.id}${langParam}`);
            if(r.ok){ const d=await r.json(); return {...item, status:d.status, release_date:d.release_date, genres:d.genres, runtime:d.runtime||120}; }
          }
        }catch(_){/* ignore detail failures */}
        return item;
      }));
      return enhanced;
    }

    async function loadGenres(){
      const langParam = (appData.settings.lang==='es') ? '&language=es-ES' : '&language=en-US';
      try{
        const r=await fetch(`${API_BASE}?endpoint=genre/tv/list${langParam}`);
        const data=await r.json();
        const sel=document.getElementById('genreFilter'); sel.innerHTML='<option value="">All Genres</option>';
        (data.genres||[]).forEach(g=> sel.innerHTML += `<option value="${g.id}">${g.name}</option>`);
      }catch(_){}
    }

    async function performSearch(){
      const q=document.getElementById('searchInput').value.trim();
      const g=document.getElementById('genreFilter').value;
      if(!q && !g){ showNotification('Type something. Anything. ü•¥','warning'); return; }
      document.getElementById('searchResults').style.display='block';
      const list=document.getElementById('searchResultsList');
      list.innerHTML='<div class="empty-state">Searching‚Ä¶</div>';
      try{
        const results=await fetchShowData(q,currentPage,g);
        searchCache=results; displaySearchResults(results);
      }catch(e){ list.innerHTML=`<div class="empty-state">Search died: ${e.message}</div>`; }
    }
    function displaySearchResults(results){
      const c=document.getElementById('searchResultsList');
      document.getElementById('resultsCount').textContent=results.length;
      if(!results.length){ c.innerHTML='<div class="empty-state sassy-empty">No results. Raise your standards later.</div>'; return; }
      c.innerHTML=''; results.forEach(item=> c.appendChild(createShowCard(item,true)));
    }

    // ---- Card building ----
    function getSeriesPill(item){
      if(!item || item.media_type!=='tv') return '';
      const status   = item.status || '';
      const lastAir  = item.last_episode_to_air?.air_date || item.last_air_date || null;
      const nextEp   = item.next_episode_to_air || null;
      const inProd   = !!item.in_production;
      const totalEp  = Number.isFinite(item.number_of_episodes) ? item.number_of_episodes : null;
      const curS = parseInt(item.currentSeason ?? 0,10) || null;
      const curE = parseInt(item.currentEpisode ?? 0,10) || null;

      let cls='status-ongoing';
      let label=t('currently_airing');

      if(status==='Ended' || status==='Canceled'){
        cls='status-ended';
        label=`${t('series_complete')}${lastAir ? ` ‚Ä¢ ${formatDateShort(lastAir)}` : ''}`;
      }else if(status==='In Production' || inProd){
        cls='status-upcoming';
        label=t('coming_soon');
      }else{
        cls='status-ongoing';
        const progress = (curS && curE && totalEp) ? `S${curS}E${curE} of ${totalEp}` :
                         (curS && curE) ? `S${curS}E${curE}` : null;
        const whenNext = nextEp?.air_date ? `${t('next')}: ${formatDateShort(nextEp.air_date)}` :
                         lastAir ? `${t('last')}: ${formatDateShort(lastAir)}` : null;
        label = [progress || t('currently_airing'), whenNext].filter(Boolean).join(' ‚Ä¢ ');
      }
      const title = [status || null, lastAir ? `Last air: ${formatDateShort(lastAir)}` : null].filter(Boolean).join(' ‚Ä¢ ');
      return `<span class="series-pill ${cls}" title="${title}">${label}</span>`;
    }

    function createShowCard(item, isSearch=false){
      const card=document.createElement('div'); card.className='show-card';
      const title=item.name||item.title||'Unknown Title';
      const date = item.first_air_date || item.release_date || '';
      const rating=item.vote_average ? item.vote_average.toFixed(1) : 'N/A';
      const mediaType=item.media_type || (item.first_air_date ? 'tv' : 'movie');

      const poster = item.poster_path
        ? `<img class="show-poster" src="${TMDB_IMG_BASE}${item.poster_path}" alt="${title}" onclick="openTMDBLink(${item.id},'${mediaType}')">`
        : `<div class="poster-placeholder" onclick="openTMDBLink(${item.id},'${mediaType}')">No Image</div>`;

      const runtimeMinutes = Number(item.runtime) || (mediaType==='tv'
            ? (Array.isArray(item.episode_run_time) && Number(item.episode_run_time[0])) || 45
            : 120);
      card.setAttribute('data-runtime-minutes', String(runtimeMinutes));

      const networkNames = (item.networks||[]).map(n=>n.name).join(', ');

      let actions = '';
      if(isSearch){
        const safe=JSON.stringify(item).replace(/"/g,'&quot;');
        actions = `
          <div class="show-actions">
            <button onclick="addToList(${safe}, 'watching')">‚ñ∂Ô∏è ${t('currently_watching')}</button>
            <button onclick="addToList(${safe}, 'wishlist')">üìñ ${t('want_to_watch')}</button>
            <button onclick="addToList(${safe}, 'watched')">‚úÖ ${t('already_watched')}</button>
          </div>`;
      }else{
        const likeStatus=item.likeStatus||'none';
        const userRating=item.userRating||0;
        actions = `
          <div class="rating-container">
            <span>Your Rating:</span>
            <div class="star-rating">
              ${[1,2,3,4,5].map(n=>`<span class="star ${n<=userRating?'active':''}" data-rating="${n}" onclick="setRating(${item.id},${n})">‚≠ê</span>`).join('')}
            </div>
            <div class="like-dislike">
              <button class="like-btn ${likeStatus==='like'?'active':''}" onclick="setLikeStatus(${item.id}, 'like')">üëç</button>
              <button class="dislike-btn ${likeStatus==='dislike'?'active':''}" onclick="setLikeStatus(${item.id}, 'dislike')">üëé</button>
            </div>
            ${mediaType==='tv' ? getSeriesPill(item) : ''}
          </div>

          <div class="tags-container">
            <div style="display:flex; gap:8px; margin-bottom:8px">
              <input id="tagInput-${item.id}" class="tag-input" placeholder="Add tags (horror, comedy, etc.)" />
              <button onclick="addTagFromInput(${item.id})" style="padding:6px 10px">Add Tag</button>
            </div>
            <div id="tags-${item.id}" class="tags-display">
              ${(item.tags||[]).map(tag=>`<span class="tag">${tag} <span class="tag-remove" onclick="removeTag(${item.id}, '${tag}')">√ó</span></span>`).join('')}
            </div>
          </div>

          <div class="show-actions">
            <button onclick="moveItem(${item.id}, 'watching')">‚Üí ${t('currently_watching')}</button>
            <button onclick="moveItem(${item.id}, 'wishlist')">‚Üí ${t('want_to_watch')}</button>
            <button onclick="moveItem(${item.id}, 'watched')">‚Üí ${t('already_watched')}</button>
            <button class="danger" onclick="removeItemFromCurrentList(${item.id})">üóëÔ∏è Remove</button>
          </div>`;
      }

      card.innerHTML = `
        ${poster}
        <div class="show-details">
          <h4 class="show-title" onclick="openTMDBLink(${item.id},'${mediaType}')">${title} <span style="opacity:.6">üîó</span></h4>
          <div class="show-meta">‚≠ê ${rating} ${date?`‚Ä¢ ${date.split('-')[0]}`:''} ‚Ä¢ ${mediaType.toUpperCase()} ${networkNames?`‚Ä¢ ${t('streaming_on')}: ${networkNames}`:''}</div>
          <div class="show-overview">${item.overview||'No description.'}</div>
          ${actions}
        </div>`;
      return card;
    }

    function openTMDBLink(id, type){ window.open(`https://www.themoviedb.org/${type}/${id}`,'_blank'); }

    // ---- Lists / state ops ----
    function addToList(item, list){
      const cat = (item.media_type==='tv'||item.first_air_date)?'tv':'movies';
      const exists = appData[cat][list].some(s=>s.id===item.id);
      if(!exists) appData[cat][list].unshift(item);
      saveAppData(); updateUI();
    }
    function moveItem(id, dest){
      const item=findItem(id); if(!item) return;
      ['tv','movies'].forEach(cat=> ['watching','wishlist','watched'].forEach(lst=>{
        appData[cat][lst]=appData[cat][lst].filter(s=>s.id!==id);
      }));
      const cat=item.media_type==='tv'?'tv':'movies';
      appData[cat][dest].unshift(item);
      saveAppData(); updateUI();
    }
    function setRating(id, rating){ const it=findItem(id); if(!it) return; it.userRating=rating; saveAppData(); updateUI(); }
    function setLikeStatus(id,status){ const it=findItem(id); if(!it) return; it.likeStatus=status; saveAppData(); updateUI(); }
    function addTagFromInput(id){ const inp=document.getElementById(`tagInput-${id}`); if(!inp) return; const v=inp.value.trim(); if(!v) return; const it=findItem(id); it.tags=it.tags||[]; if(!it.tags.includes(v)) it.tags.push(v); inp.value=''; saveAppData(); updateUI(); }
    function removeTag(id,tag){ const it=findItem(id); if(!it) return; it.tags=(it.tags||[]).filter(t=>t!==tag); saveAppData(); updateUI(); }
    function removeItemFromCurrentList(id){
      const item=findItem(id); if(!item) return;
      if(!confirm(`Remove "${item.title||item.name}" from this list?`)) return;
      ['tv','movies'].forEach(cat=> ['watching','wishlist','watched'].forEach(lst=>{
        appData[cat][lst]=appData[cat][lst].filter(s=>s.id!==id);
      }));
      saveAppData(); updateUI();
    }
    function findItem(id){
      for(const cat of ['tv','movies']){
        for(const lst of ['watching','wishlist','watched']){
          const f=appData[cat][lst].find(s=>s.id===id);
          if(f) return f;
        }
      }
      return null;
    }

    // ---- UI update, banner & meter ----
    function calculateBingeTime({scope='watching'}={}){
      let roots=[];
      if(scope==='watching'){ const w=document.getElementById('watchingList'); if(w) roots=[w]; }
      else { roots=[document]; }
      const cards=roots.flatMap(r=> Array.from(r.querySelectorAll('.show-card[data-runtime-minutes]')));
      const total = cards.reduce((m,c)=> m + (parseInt(c.getAttribute('data-runtime-minutes'))||0), 0);
      const h=Math.floor(total/60), m=total%60, d=Math.floor(h/24), rh=h%24;
      let str=''; if(d) str+=`${d}d `; if(rh) str+=`${rh}h `; str+=`${m}m`;
      return { totalMinutes:total, timeStr:str, showCount:cards.length };
    }
    function updateBingeMeter(){
      const stats=calculateBingeTime();
      const container=document.querySelector('.stats'); if(!container) return;
      let el=document.getElementById('bingeMeter');
      if(!el){ el=document.createElement('div'); el.id='bingeMeter'; el.className='stat'; container.appendChild(el); }
      el.innerHTML=`<div class="stat-num">${stats.timeStr}</div><div class="stat-label">${t('binge_total')}</div>`;
    }
    function updateBingeBanner(){
      const stats=calculateBingeTime({scope:'watching'});
      const banner=document.getElementById('bingeBanner'); if(!banner) return;
      const es = [
        "de decisiones cuestionables en cola. üé≠",
        "de procrastinaci√≥n medida con precisi√≥n. ü§°",
        "de verg√ºenza en streaming calculada. üì∫",
        "de marat√≥n sin arrepentimientos (mentira). üçø"
      ];
      const en = [
        "of questionable life choices queued! üé≠",
        "of procrastination precisely measured. ü§°",
        "of streaming shame calculated. üì∫",
        "of binge you definitely won‚Äôt regret. üçø"
      ];
      const msg = (appData.settings.lang==='es' ? es : en)[Math.floor(Math.random()*4)];
      banner.innerHTML = `
        <span class="binge-time" id="bingeTimeText">${stats.timeStr}</span>
        <span class="binge-label">${msg}</span>
        <button class="binge-cta" id="startBingeBtn" type="button" aria-label="${t('start')}">${t('start')} ‚ñ∂</button>
      `;
      const btn=document.getElementById('startBingeBtn');
      if(btn) btn.onclick=()=>{
        switchToTab('watching');
        setTimeout(()=>{
          const list=document.getElementById('watchingList');
          if(list) list.scrollIntoView({behavior:'smooth',block:'start'});
        },120);
      };
    }

    function updateUI(){
      const totals={
        watching: appData.tv.watching.length + appData.movies.watching.length,
        wishlist: appData.tv.wishlist.length + appData.movies.wishlist.length,
        watched:  appData.tv.watched.length  + appData.movies.watched.length
      };
      ['watching','wishlist','watched'].forEach(k=>{
        const b=document.getElementById(k+'Badge'); if(b) b.textContent=totals[k];
        const c=document.getElementById(k+'Count'); if(c) c.textContent=totals[k];
      });
      const totalCount=document.getElementById('totalCount');
      if(totalCount) totalCount.textContent=totals.watching+totals.wishlist+totals.watched;

      // lists (apply filters)
      const watching=[...appData.tv.watching,...appData.movies.watching];
      const wishlist=[...appData.tv.wishlist,...appData.movies.wishlist];
      const watched =[...appData.tv.watched, ...appData.movies.watched];

      function filter(items){
        if(showTVOnly) return items.filter(it=> (it.media_type||'tv')==='tv');
        if(showMoviesOnly) return items.filter(it=> (it.media_type||'movie')==='movie');
        return items;
      }
      updateList('watchingList', filter(watching));
      updateList('wishlistList', filter(wishlist));
      updateList('watchedList',  filter(watched));

      updateBingeMeter();
      updateBingeBanner();
      applyTranslations();
    }

    function updateList(containerId, items){
      const c=document.getElementById(containerId); if(!c) return;
      if(!items.length){
        const msg = containerId==='watchingList' ? 'No shows yet? What are you, productive or something? üôÑ'
                  : containerId==='wishlistList' ? 'Your wishlist is emptier than a Netflix comedy special üíÄ'
                  : 'Nothing completed yet? Commitment issues much? üòè';
        c.innerHTML=`<div class="empty-state sassy-empty">${msg}</div>`;
        return;
      }
      c.innerHTML=''; items.forEach(it=> c.appendChild(createShowCard(it,false)));
    }

    // ---- Tabs / UI wiring ----
    function switchToTab(tab){
      currentActiveTab=tab;
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(tab+'Tab').classList.add('active');
      document.querySelectorAll('.tab-section').forEach(s=> s.style.display='none');
      document.getElementById(tab+'Section').style.display='block';
    }

    function updateWelcomeText(){
      const n=(appData.settings.displayName||'').trim();
      const pool=["Chaos","Questionable Taste","Binge Empire","Streaming Madness","Watch List Anarchy"];
      document.getElementById('welcomeText').textContent = n ? `${n}'s ${pool[Math.floor(Math.random()*pool.length)]}` : t('app_title');
    }

    // ---- Misc actions ----
    function toggleContentFilter(){
      const btn=document.getElementById('filterBtn');
      if(!showTVOnly && !showMoviesOnly){ showTVOnly=true; btn.textContent='üì∫ Show TV Only'; }
      else if(showTVOnly){ showTVOnly=false; showMoviesOnly=true; btn.textContent='üé¨ Show Movies Only'; }
      else { showMoviesOnly=false; btn.textContent='üé≠ Show All Content'; }
      updateUI();
    }
    function showAboutModal(){
      openModal('About Flicklet', `
        <p><strong>Flicklet</strong> helps you track TV & movies, syncs to the cloud, and throws shade while you procrastinate.</p>
        <p>Built with Capacitor + Firebase + TMDB.</p>
      `);
    }
    function showStatsModal(){
      const totals={
        tv: appData.tv.watching.length+appData.tv.wishlist.length+appData.tv.watched.length,
        movies: appData.movies.watching.length+appData.movies.wishlist.length+appData.movies.watched.length
      };
      const binge=calculateBingeTime();
      openModal('Usage Stats', `
        <ul>
          <li>Total items: <strong>${totals.tv+totals.movies}</strong></li>
          <li>TV: <strong>${totals.tv}</strong> ‚Ä¢ Movies: <strong>${totals.movies}</strong></li>
          <li>${t('binge_total')}: <strong>${binge.timeStr}</strong></li>
        </ul>
      `);
    }

    // ---- bootstrap ----
    document.addEventListener('DOMContentLoaded', ()=>{
      loadAppData(); loadGenres(); updateUI();

      // buttons
      document.getElementById('homeTab').onclick = ()=>switchToTab('home');
      document.getElementById('watchingTab').onclick = ()=>switchToTab('watching');
      document.getElementById('wishlistTab').onclick = ()=>switchToTab('wishlist');
      document.getElementById('watchedTab').onclick = ()=>switchToTab('watched');

      document.getElementById('darkModeToggle').onclick = ()=>{
        document.body.classList.toggle('dark-mode');
        appData.settings.theme = document.body.classList.contains('dark-mode')?'dark':'light';
        saveAppData();
      };
      document.getElementById('langToggle').addEventListener('change', (e)=>{
        appData.settings.lang = e.target.value || 'en';
        saveAppData(); applyTranslations(); loadGenres(); updateUI();
      });

      // auth buttons
      document.getElementById('googleSignIn').onclick = async ()=>{
        try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        catch(e){ showNotification('Google sign-in failed.','error'); }
      };
      document.getElementById('emailSignIn').onclick = async ()=>{
        const email=prompt('Email?'); const pw=prompt('Password?');
        if(!email||!pw) return;
        try{ await auth.signInWithEmailAndPassword(email,pw); }
        catch(e){ if(e.code==='auth/user-not-found'){ await auth.createUserWithEmailAndPassword(email,pw); } }
      };
      document.getElementById('signOut').onclick = ()=>auth.signOut();

      // search
      document.getElementById('searchBtn').onclick=performSearch;
      document.getElementById('clearSearchBtn').onclick=()=>{ document.getElementById('searchInput').value=''; document.getElementById('genreFilter').value=''; document.getElementById('searchResults').style.display='none'; };
      document.getElementById('searchInput').addEventListener('keydown', e=>{ if(e.key==='Enter') performSearch(); });

      // backup/actions
      document.getElementById('exportBtn').onclick=()=>{
        const blob=new Blob([JSON.stringify(appData,null,2)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`flicklet-backup.json`;
        document.body.appendChild(a); a.click(); a.remove();
      };
      document.getElementById('importFile').onchange=(e)=>{
        const f=e.target.files[0]; if(!f) return; const r=new FileReader();
        r.onload=()=>{ try{ const d=JSON.parse(r.result); Object.assign(appData,d); saveAppData(); updateUI(); }catch{ showNotification('Broken file.','error'); } };
        r.readAsText(f);
      };
      document.getElementById('clearAllBtn').onclick=()=>{
        if(!confirm('This wipes everything. You sure?')) return;
        appData.tv={watching:[],wishlist:[],watched:[]}; appData.movies={watching:[],wishlist:[],watched:[]}; saveAppData(); updateUI();
      };
      document.getElementById('aboutBtn').onclick=showAboutModal;
      document.getElementById('usageStatsBtn').onclick=showStatsModal;
      document.getElementById('filterBtn').onclick=toggleContentFilter;

      // show auth box now; updateAuthUI will adjust
      document.getElementById('authSection').style.display='block';
    });

    // Export a couple for debugging if you want
    window.updateUI = updateUI;
    window.updateBingeBanner = updateBingeBanner;
  </script>
</body>
</html>
