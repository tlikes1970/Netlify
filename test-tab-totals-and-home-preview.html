<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Tab Totals and Home Preview</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-pass { background-color: #d4edda; border-color: #c3e6cb; }
        .test-fail { background-color: #f8d7da; border-color: #f5c6cb; }
        .test-result { font-weight: bold; margin: 10px 0; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Test: Tab Totals and Home Preview Functionality</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="testTabBadgeCounts()">Test Tab Badges</button>
        <button onclick="testCurrentlyWatchingPreview()">Test Currently Watching Preview</button>
        <button onclick="testHomePageLayout()">Test Home Page Layout</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="testResults">Click "Run All Tests" to start testing...</div>
    </div>
    
    <div class="test-section">
        <h2>Console Log</h2>
        <div id="consoleLog" class="log"></div>
    </div>

    <script>
        // Mock data for testing
        const testData = {
            tv: {
                watching: [
                    { id: 1, title: "Breaking Bad", poster_path: "/ggFHVNu6YYI5L9pCfOacjizRGt.jpg", mediaType: "tv" },
                    { id: 2, title: "The Office", poster_path: "/7DJKHzAiZOlkpJQvAjjF4gxX5k.jpg", mediaType: "tv" }
                ],
                wishlist: [
                    { id: 3, title: "Stranger Things", poster_path: "/49WJfeN0moxb9IPfGn9AIqCtW6W.jpg", mediaType: "tv" }
                ],
                watched: [
                    { id: 4, title: "Friends", poster_path: "/f496cm9enuEsZkSPzCwnTESEK5s.jpg", mediaType: "tv" }
                ]
            },
            movies: {
                watching: [
                    { id: 5, title: "Inception", poster_path: "/9gk7adHYeDvHkCSEqAvQNLV5Uge.jpg", mediaType: "movie" }
                ],
                wishlist: [
                    { id: 6, title: "The Matrix", poster_path: "/f89U3ADr1oiB1s9GkdPOEpXUk5H.jpg", mediaType: "movie" }
                ],
                watched: [
                    { id: 7, title: "The Dark Knight", poster_path: "/qJ2tW6WMUDux911r6m7haRef0WH.jpg", mediaType: "movie" }
                ]
            }
        };

        // Mock functions for testing
        window.appData = testData;
        window.FLAGS = { homeRowCurrentlyWatching: true };
        
        // Mock updateTabCounts function
        window.updateTabCounts = function() {
            try {
                const A = window.appData || {};
                const tv = A.tv || {}, mv = A.movies || {};
                const sum = (arr) => Array.isArray(arr) ? arr.length : 0;
                const counts = {
                    watching: sum(tv.watching) + sum(mv.watching),
                    wishlist: sum(tv.wishlist) + sum(mv.wishlist),
                    watched:  sum(tv.watched)  + sum(mv.watched)
                };
                
                // Update badges with fallback selectors
                ['watching','wishlist','watched'].forEach(list => {
                    const badge = document.getElementById(`${list}Badge`) || 
                                 document.getElementById(`${list}Count`) ||
                                 document.querySelector(`[data-count="${list}"]`);
                    if (badge) {
                        badge.textContent = counts[list];
                        
                        // Force badge to be visible with inline styles to override any CSS
                        badge.style.setProperty('display', 'inline-block', 'important');
                        badge.style.setProperty('visibility', 'visible', 'important');
                        badge.style.setProperty('opacity', '1', 'important');
                        badge.style.setProperty('fontSize', '11px', 'important');
                        badge.style.setProperty('backgroundColor', '#e91e63', 'important');
                        badge.style.setProperty('color', 'white', 'important');
                        badge.style.setProperty('padding', '2px 6px', 'important');
                        badge.style.setProperty('borderRadius', '10px', 'important');
                        badge.style.setProperty('marginLeft', '6px', 'important');
                        badge.style.setProperty('fontWeight', '600', 'important');
                        badge.style.setProperty('minWidth', '16px', 'important');
                        badge.style.setProperty('textAlign', 'center', 'important');
                        badge.style.setProperty('lineHeight', '1.2', 'important');
                        badge.style.setProperty('position', 'relative', 'important');
                        badge.style.setProperty('zIndex', '1', 'important');
                        
                        // Add class for additional CSS targeting
                        badge.classList.add('tab-badge');
                        
                        log(`Updated ${list}Badge: ${counts[list]}`);
                    } else {
                        log(`Badge not found for ${list}: ${list}Badge, ${list}Count, or [data-count="${list}"]`);
                    }
                });
                
                log("counts:", counts);
                return counts;
            } catch (e) {
                log("Error in updateTabCounts:", e);
                return { watching:0, wishlist:0, watched:0 };
            }
        };

        // Mock renderCurrentlyWatchingPreview function
        window.renderCurrentlyWatchingPreview = function() {
            const previewSection = document.getElementById('currentlyWatchingPreview');
            const scrollContainer = document.getElementById('currentlyWatchingScroll');
            
            if (!previewSection || !scrollContainer) {
                log("Preview elements not found");
                return false;
            }
            
            // Simulate rendering cards
            const watchingItems = getCurrentlyWatchingItems();
            if (watchingItems.length > 0) {
                previewSection.style.display = 'block';
                scrollContainer.innerHTML = watchingItems.map(item => 
                    `<div class="preview-card">${item.title}</div>`
                ).join('');
                log(`Rendered ${watchingItems.length} currently watching items`);
                return true;
            } else {
                previewSection.style.display = 'none';
                log("No currently watching items found");
                return false;
            }
        };

        function getCurrentlyWatchingItems() {
            const watchingItems = [];
            
            if (window.appData.tv?.watching) {
                watchingItems.push(...window.appData.tv.watching.map(item => ({
                    ...item,
                    mediaType: 'tv'
                })));
            }
            
            if (window.appData.movies?.watching) {
                watchingItems.push(...window.appData.movies.watching.map(item => ({
                    ...item,
                    mediaType: 'movie'
                })));
            }
            
            return watchingItems;
        }

        // Test functions
        function testTabBadgeCounts() {
            log("🧪 Testing tab badge counts...");
            
            // Set up test data
            window.appData = testData;
            
            // Call updateTabCounts function
            if (typeof window.updateTabCounts === 'function') {
                const counts = window.updateTabCounts();
                
                // Expected counts
                const expectedCounts = {
                    watching: 3, // 2 TV + 1 movie
                    wishlist: 2, // 1 TV + 1 movie  
                    watched: 2   // 1 TV + 1 movie
                };
                
                // Verify counts
                const watchingBadge = document.getElementById('watchingBadge');
                const wishlistBadge = document.getElementById('wishlistBadge');
                const watchedBadge = document.getElementById('watchedBadge');
                
                log("Badge elements found:", {
                    watching: !!watchingBadge,
                    wishlist: !!wishlistBadge,
                    watched: !!watchedBadge
                });
                
                log("Badge text content:", {
                    watching: watchingBadge?.textContent,
                    wishlist: wishlistBadge?.textContent,
                    watched: watchedBadge?.textContent
                });
                
                log("Expected vs Actual:", {
                    watching: { expected: expectedCounts.watching, actual: counts.watching },
                    wishlist: { expected: expectedCounts.wishlist, actual: counts.wishlist },
                    watched: { expected: expectedCounts.watched, actual: counts.watched }
                });
                
                const result = {
                    watching: counts.watching === expectedCounts.watching,
                    wishlist: counts.wishlist === expectedCounts.wishlist,
                    watched: counts.watched === expectedCounts.watched
                };
                
                displayTestResult('Tab Badge Counts', result);
                return result;
            } else {
                log("❌ updateTabCounts function not available");
                displayTestResult('Tab Badge Counts', { watching: false, wishlist: false, watched: false });
                return { watching: false, wishlist: false, watched: false };
            }
        }

        function testCurrentlyWatchingPreview() {
            log("🧪 Testing currently watching preview...");
            
            // Set up test data
            window.appData = testData;
            
            // Check if preview section exists
            const previewSection = document.getElementById('currentlyWatchingPreview');
            const scrollContainer = document.getElementById('currentlyWatchingScroll');
            
            log("Preview elements found:", {
                previewSection: !!previewSection,
                scrollContainer: !!scrollContainer
            });
            
            if (!previewSection || !scrollContainer) {
                log("❌ Preview elements not found");
                displayTestResult('Currently Watching Preview', false);
                return false;
            }
            
            // Trigger preview render
            if (typeof window.renderCurrentlyWatchingPreview === 'function') {
                const result = window.renderCurrentlyWatchingPreview();
                
                // Check if items are rendered
                const cards = scrollContainer.querySelectorAll('.preview-card');
                log("Preview cards rendered:", cards.length);
                
                // Check if section is visible
                const isVisible = previewSection.style.display !== 'none';
                log("Preview section visible:", isVisible);
                
                const success = cards.length > 0 && isVisible;
                displayTestResult('Currently Watching Preview', success);
                return success;
            } else {
                log("❌ renderCurrentlyWatchingPreview function not available");
                displayTestResult('Currently Watching Preview', false);
                return false;
            }
        }

        function testHomePageLayout() {
            log("🧪 Testing home page layout...");
            
            // Check if currently watching section is in the top row
            const currentlyWatchingSection = document.getElementById('currentlyWatchingPreview');
            const homeSection = document.getElementById('homeSection');
            
            if (!currentlyWatchingSection || !homeSection) {
                log("❌ Required sections not found");
                displayTestResult('Home Page Layout', false);
                return false;
            }
            
            // Check if currently watching is the first child of home section
            const firstChild = homeSection.querySelector('.home-group:first-child');
            const currentlyWatchingGroup = currentlyWatchingSection.closest('.home-group');
            
            log("Layout check:", {
                firstChild: firstChild?.id,
                currentlyWatchingGroup: currentlyWatchingGroup?.id,
                isFirst: currentlyWatchingGroup === firstChild
            });
            
            const success = currentlyWatchingGroup === firstChild;
            displayTestResult('Home Page Layout', success);
            return success;
        }

        function runAllTests() {
            log("🚀 Running all tests...");
            
            const results = {
                tabBadges: testTabBadgeCounts(),
                currentlyWatchingPreview: testCurrentlyWatchingPreview(),
                homePageLayout: testHomePageLayout()
            };
            
            log("📊 Test Results:", results);
            
            const allPassed = Object.values(results).every(result => 
                typeof result === 'boolean' ? result : Object.values(result).every(Boolean)
            );
            
            log(allPassed ? "✅ All tests passed!" : "❌ Some tests failed!");
            
            return results;
        }

        function displayTestResult(testName, result) {
            const resultsDiv = document.getElementById('testResults');
            const isPass = typeof result === 'boolean' ? result : Object.values(result).every(Boolean);
            const resultClass = isPass ? 'test-pass' : 'test-fail';
            const status = isPass ? 'PASS' : 'FAIL';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-section ${resultClass}`;
            resultDiv.innerHTML = `
                <div class="test-result">${testName}: ${status}</div>
                <div>Result: ${JSON.stringify(result, null, 2)}</div>
            `;
            
            resultsDiv.appendChild(resultDiv);
        }

        function log(message, data) {
            const logDiv = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}${data ? ' ' + JSON.stringify(data, null, 2) : ''}\n`;
            logDiv.textContent += logMessage;
            console.log(message, data);
        }

        function clearLog() {
            document.getElementById('consoleLog').textContent = '';
            document.getElementById('testResults').innerHTML = 'Click "Run All Tests" to start testing...';
        }

        // Initialize test environment
        function initTestEnvironment() {
            // Create mock HTML structure
            document.body.innerHTML += `
                <div id="homeSection" class="tab-section active">
                    <div id="group-1-your-shows" class="home-group">
                        <div class="group-header">
                            <h2 class="group-title">Your Shows</h2>
                        </div>
                        
                        <section id="currentlyWatchingPreview" class="home-preview-row">
                            <div class="preview-row-header">
                                <h3 class="preview-row-title">👁️ Currently Watching</h3>
                            </div>
                            <div class="preview-row-container cw-row">
                                <div class="preview-row-scroll row-inner" id="currentlyWatchingScroll">
                                    <!-- Cards will be populated by JavaScript -->
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
                
                <div class="tab-container" id="navigation">
                    <button id="homeTab" class="tab active">🏠 Home</button>
                    <button id="watchingTab" class="tab">
                        ▶️ Currently Watching
                        <span class="tab-badge" id="watchingBadge">0</span>
                    </button>
                    <button id="wishlistTab" class="tab">
                        📖 Want to Watch
                        <span class="tab-badge" id="wishlistBadge">0</span>
                    </button>
                    <button id="watchedTab" class="tab">
                        ✅ Already Watched
                        <span class="tab-badge" id="watchedBadge">0</span>
                    </button>
                </div>
            `;
            
            log("Test environment initialized");
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initTestEnvironment);
    </script>
</body>
</html>

