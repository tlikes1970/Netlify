<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Flicklet - TV & Movie Tracker v25.0</title>
    <meta
      name="description"
      content="Search, track, and rate shows & films fast."
    />
    <meta name="build" content="v25.0">
    
    <!-- Permissions Policy to prevent compute-pressure violations -->
    <meta http-equiv="Permissions-Policy" content="compute-pressure=(), camera=(), microphone=(), geolocation=()" />
    
    <!-- Cross-Origin-Opener-Policy for Google Auth popup compatibility -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups" />
    
    <!-- TMDB API Configuration - Use environment variable or tmdb-config.js -->
    <meta name="tmdb-api-key" content="b7247bb415b50f25b5e35e2566430b96" />
    
    <!-- Base tag for root-relative URLs -->
    <base href="/">
    
    <!-- Icons for different platforms -->
    <link rel="icon" href="/icons/icon-512.png" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />
    <link rel="manifest" href="/manifest.json" />

    <!-- Critical CSS - Inlined for performance -->
    <style>
      /* Critical CSS - Above the fold styles */
      :root {
        --fg: #1f2937;
        --bg: #ffffff;
        --muted: #374151;
        --card: #ffffff;
        --border: #e5e7eb;
        --accent: #ff4c8d;
        --text-secondary: #374151;
        --placeholder: #6b7280;
        --badge-text: #1f2937;
        --meta-text: #374151;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; margin: 0; padding: 0; }
      body {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: var(--text);
        line-height: 1.5;
        min-height: 100svh;
        overflow-x: hidden;
        overflow-y: visible;
      }
      .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: var(--bg);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        min-height: calc(100vh - 40px);
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }
      .title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--fg);
        margin: 0;
      }
      .subtitle {
        font-size: 1rem;
        color: var(--muted);
        margin: 4px 0 0 0;
      }
      .top-search {
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--bg);
        padding: 16px;
        margin: 16px 0;
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .search-row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .search-input {
        flex: 1;
        min-width: 200px;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 16px;
        background: var(--bg);
        color: var(--fg);
      }
      .btn {
        padding: 12px 24px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg);
        color: var(--fg);
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-height: 44px;
        min-width: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .btn:hover {
        background: var(--color-surface-2);
        border-color: var(--accent);
      }
      .btn:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }
      .tab-container {
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        flex-wrap: nowrap;
        gap: 0;
        background: transparent;
        padding: 0;
        border-radius: 0;
        margin: 16px 0 0 0;
        border: none;
        border-bottom: 1px solid var(--border);
        position: relative;
        z-index: 100;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .tab {
        padding: 12px 24px;
        border: none;
        background: transparent;
        color: var(--muted);
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 2px solid transparent;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .tab.active {
        color: var(--fg);
        border-bottom-color: var(--accent);
      }
      .tab:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }
      @media (max-width: 768px) {
        .main-container { padding: 16px; margin: 10px; }
        .header { flex-direction: column; gap: 8px; text-align: center; }
        .title { font-size: 1.8rem; }
        .search-row { flex-direction: column; gap: 8px; }
        .search-input { width: 100%; min-width: auto; }
        .tab-container { padding: 0 16px; }
        .tab { padding: 8px 16px; font-size: 14px; }
      }
    </style>
    
    <!-- Critical CLS prevention CSS -->
    <style id="critical-cls-guard">
      /* Reserve space for help/top area */
      .search-help{ min-height: clamp(72px, 8vw, 128px); }

      /* Reserve space for the first curated row (prevents late layout jumps) */
      .curated-row:first-of-type{ min-height: clamp(220px, 30vw, 340px); }

      /* Give images in curated rows a stable box without touching layout elsewhere */
      @supports (aspect-ratio: 2 / 3){
        .curated-row img{
          aspect-ratio: 2 / 3;
          height: auto;
          width: 100%;
          object-fit: cover;
          display:block;
          background-color: rgba(0,0,0,0.04);
        }
      }

      /* Optional subtle skeleton if containers are empty at paint (no DOM changes needed) */
      .search-help:empty,
      .curated-row:first-of-type:empty{
        background: linear-gradient(90deg, #f2f2f2 25%, #f8f8f8 37%, #f2f2f2 63%);
        background-size: 400% 100%;
        animation: clsSkeleton 1.2s ease-in-out infinite;
        border-radius: 8px;
      }
      @keyframes clsSkeleton{0%{background-position:100% 0}100%{background-position:0 0}}
    </style>
    
    <!-- Minimal performance guard to prevent overlays -->
    <style id="perf-guards-minimal">
      /* Make sure the help container never overlays or captures clicks */
      .search-help{
        position: static !important;
        min-height: 0 !important;
        padding: 0 !important;
        background: none !important;
        z-index: auto !important;
      }
      /* If any residual text remains, don't let it block interactions */
      .search-help, .search-help *{
        pointer-events: none !important;
      }

      /* Keep first curated row lightweight without interfering with above-the-fold UI */
      .curated-row:first-of-type{
        content-visibility: auto;         /* render only when near viewport */
        contain-intrinsic-size: auto 320px; /* reserve vertical size without forcing layout */
        min-height: 0;                     /* no artificial height on desktop */
      }

      /* Never mask sticky search */
      .top-search{ position: sticky; } /* leave behavior intact; no z-index changes here */
    </style>
    
    <!-- Non-critical CSS - Load asynchronously -->
    <link rel="preload" href="/styles/inline-style-01.css?v=v17.9" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/styles/inline-style-02.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/styles/components.css?v=v17.9" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/styles/mobile.css?v=v17.9" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/styles/main.css?v=v17.9" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/styles/consolidated-layout.css?v=v17.9" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/styles/action-bar.css?v=v22.21" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/styles/card-system.css?v=v23.53" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/styles/cards.css?v=v24.27" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/styles/unified-poster-card.css?v=v25.0" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/styles/modals.css?v=v25.0" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- Fallback for browsers without preload support -->
    <noscript>
      <link rel="stylesheet" href="/styles/inline-style-01.css?v=v17.9">
      <link rel="stylesheet" href="/styles/inline-style-02.css">
      <link rel="stylesheet" href="/styles/components.css?v=v17.9">
      <link rel="stylesheet" href="/styles/mobile.css?v=v17.9">
      <link rel="stylesheet" href="/styles/main.css?v=v17.9">
      <link rel="stylesheet" href="/styles/consolidated-layout.css?v=v17.9">
      <link rel="stylesheet" href="/styles/action-bar.css?v=v22.21">
      <link rel="stylesheet" href="/styles/card-system.css?v=v23.53">
      <link rel="stylesheet" href="/styles/cards.css?v=v24.27">
    </noscript>

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <!-- Project config (must define window.firebaseConfig) -->
    <script src="/firebase-config.js"></script>

    <!-- Guarded init: initialize app + Firestore once -->
    <script>
    (function () {
      const hasSDK = !!(window.firebase && typeof window.firebase.initializeApp === 'function');
      const cfg = window.firebaseConfig;
      if (!hasSDK) {
        console.info('Firebase SDK missing; skip init');
        return;
      }
      if (!cfg || typeof cfg !== 'object') {
        console.info('Firebase config missing; skip init');
        return;
      }
      try {
        if (!firebase.apps?.length) firebase.initializeApp(cfg);
        if (firebase.firestore) { 
          window.db = firebase.firestore(); 
        } else { 
          console.warn('Firestore compat not available'); 
        }
        console.info('Firebase initialized');
      } catch (e) {
        console.error('Firebase init error', e);
      }
    })();
    </script>

    <!-- BOOTSTRAP GUARDS (must come before all app scripts) -->
    <script>
    (function () {
      // Firebase guard
      const hasFirebase = !!(window.firebase && typeof window.firebase.initializeApp === 'function');
      if (!hasFirebase) {
        console.info('ℹ️ Firebase not loaded — cloud features disabled');
        // Provide harmless fallbacks so later code doesn't break
        window.loadUserDataFromCloud = window.loadUserDataFromCloud || (async () => null);
        window.addToList = window.addToList || (() => false);
        // Signal to app bootstrap that firebase is unavailable
        window.__NO_FIREBASE__ = true;
      }

      // TMDB client will be loaded via tmdb.js script

      // Minimal genre map fallback
      window.__GENRES__ = window.__GENRES__ || {
        // Core IDs used by TMDB (movies)
        16: 'Animation', 27: 'Horror', 28: 'Action', 35: 'Comedy', 18: 'Drama',
        12: 'Adventure', 14: 'Fantasy', 53: 'Thriller', 80: 'Crime', 99: 'Documentary'
      };

      // Service Worker registration (temporarily disabled)
      if (false && 'serviceWorker' in navigator) {
        const host = location.hostname;
        const isLocal = host === 'localhost' || host.endsWith('.local') || host.endsWith('.lan');
        const isProd = host.endsWith('netlify.app') && !host.includes('--deploy-preview-');
        if (isLocal || isProd) {
          navigator.serviceWorker.register('cnm-sw.js').catch(console.warn);
        } else {
          console.info('[SW] Registration skipped in this environment:', host);
        }
      }
    })();
    </script>

    <!-- Feature flags and safety guard -->
    <script src="/js/flags.js"></script>
    
    <!-- Early flags initialization (must be before any row scripts) -->
    <script src="/scripts/flags-init.js"></script>
    
    <!-- Debug utilities (must load early) -->
    <script src="/js/debug-utils.js"></script>
    
    <!-- Emergency function restoration (critical fallbacks) -->
    <!-- <script src="/js/emergency-functions.js"></script> --> <!-- DISABLED: Main functions are now working -->
    
    <!-- Syntax error bypass (ensures functionality) -->
    <script src="/js/syntax-fix.js"></script>
    
    <!-- Home sections configuration (must load early) -->
    <script src="/js/home-sections-config.js"></script>
    
    <!-- DOM element caching system -->
    <script src="/js/dom-cache.js" defer></script>
    
    <!-- Centralized error handling -->
    <script src="/js/error-handler.js" defer></script>
    
    <!-- Unified visibility management -->
    <script src="/js/visibility-manager.js" defer></script>
    
    <!-- Common utilities (reduced duplication) -->
    <script src="/js/common-utils.js" defer></script>
    
    <!-- Layout enhancements (skeleton loaders, scroll indicators, accessibility) -->
    <script src="/js/layout-enhancements.js" defer></script>
    
    <!-- Chrome extension messaging polyfill -->
    <script src="/scripts/polyfill.js" defer></script>
    
    <!-- Immediate mobile detection -->
    <script>
      (function() {
        // Single mobile detection system - viewport width only
        function applyMobileClass() {
          const isMobileSize = window.innerWidth <= 768;
          
          if (isMobileSize && document.body) {
            document.body.classList.add('mobile');
            console.log('📱 Mobile class applied - viewport width:', window.innerWidth);
          }
        }
        
        // Apply immediately if body is ready
        if (document.body) {
          applyMobileClass();
        } else {
          // Wait for DOM ready
          document.addEventListener('DOMContentLoaded', applyMobileClass);
        }
        
        // Listen for resize events to update mobile class
        window.addEventListener('resize', () => {
          const isMobile = window.innerWidth <= 768;
          if (isMobile && !document.body.classList.contains('mobile')) {
            document.body.classList.add('mobile');
            console.log('📱 Mobile class added on resize');
          } else if (!isMobile && document.body.classList.contains('mobile')) {
            document.body.classList.remove('mobile');
            console.log('📱 Mobile class removed on resize');
          }
        });
      })();
    </script>

</head>

  <body>
    <script>
    (function () {
      if (!('serviceWorker' in navigator)) return;
      const host = location.hostname;
      const isPreview = host.includes('--deploy-preview-');
      if (isPreview) {
        // Purge any already-installed SW and caches on previews
        navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
        if (window.caches && caches.keys) {
          caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
        }
        // Block future registrations in this context
        const noop = () => Promise.reject(new Error('SW disabled on preview'));
        try { navigator.serviceWorker.register = noop; } catch {}
        console.info('[SW] Disabled for deploy preview:', host);
      }
    })();
    </script>

    <!-- Skip Links for Accessibility -->
    <a href="#main" class="skip-link">Skip to main content</a>
    <a href="#search" class="skip-link">Skip to search</a>
    <a href="#navigation" class="skip-link">Skip to navigation</a>

    <!-- Main Container -->
    <div class="main-container" id="appRoot">
      <header class="header" role="banner" data-lang-layout="inline">
        <div class="header-bar">
          <div class="header-left">
            <span class="version-display">v25.0</span>
            <h1 class="brand" data-i18n="app_title">Flicklet</h1>
            <span class="tagline" data-i18n="app_subtitle">TV &amp; Movie Tracker</span>
          </div>
          <div class="header-right">
            <!-- Signed OUT -->
            <div data-auth="signed-out-visible" class="signin-area">
              <div class="signin-label">Sign in</div>
              <button id="signIn" data-action="sign-in" class="btn btn--sm">👤 Sign In</button>
              <!-- Welcome message for signed-out users only -->
              <div class="snark" data-snark>Welcome back.</div>
            </div>

            <!-- Signed IN -->
            <div data-auth="signed-in-visible" hidden class="account-area">
              <!-- visible hint so it's obvious clicking your name signs out -->
              <div class="account-hint">Sign out</div>
              <button id="accountMenuBtn" class="user-btn btn btn--sm" aria-haspopup="menu" aria-expanded="false">
                <span class="user-initial" aria-hidden="true">U</span>
                <span id="usernameDisplay" class="user-name" data-username-display title="Sign out">Username</span>
              </button>
              <div id="accountMenu" class="account-menu" role="menu" hidden>
                <button id="logoutBtn" role="menuitem" class="menu-item">Log out</button>
              </div>
            </div>
            <select id="langToggle" class="lang-select select--sm" aria-label="Language" title="Language">
              <option value="en">EN</option>
              <option value="es">ES</option>
            </select>
          </div>
        </div>
        <!-- leave .top-search exactly as-is, below this block -->
      </header>


      <!-- Sticky Top Search -->
      <div class="top-search" id="search-container">

        <div class="search-help" id="searchHelp">
          
        </div>
        <div class="search-row" id="desktop-search-row">
          <input
            id="search"
            type="search"
            class="search-input search-area-input"
            placeholder=""
            data-i18n-placeholder="search_placeholder"
          />
          <select id="genreSelect" class="genre-filter search-area-genre">
            <option value="" data-i18n="all_genres">All Genres</option>
          </select>
          <button id="searchBtn" type="button" class="btn search-btn search-area-search" aria-label="Search for TV shows and movies">
            <span class="icon" aria-hidden="true">🔍</span>
            <span class="label" data-i18n="search">Search</span>
          </button>
          <button id="clearSearchBtn" type="button" class="btn btn--secondary clear-search-btn search-area-clear" aria-label="Clear search results">
            <span class="icon" aria-hidden="true">✖️</span>
            <span class="label" data-i18n="clear">Clear</span>
          </button>
        </div>
        <div
          id="tagFilterRow"
          class="tag-filters"
          aria-label="Tag filters"
        >        </div>
      </div>

      <!-- Tab container moved outside homeSection for proper positioning -->
      <div class="tab-container" id="navigation">
        <button id="homeTab" class="tab active" title="Overview of your TV & movie tracking" aria-label="Home tab - view dashboard and recommendations">🏠 <span data-i18n="home">Home</span></button>
        <button id="watchingTab" class="tab" title="Shows and movies you're currently watching" aria-label="Watching tab - view shows and movies you're currently watching">
          ▶️ <span data-i18n="currently_watching">Currently Watching</span>
          <span class="tab-badge" id="watchingBadge">0</span>
        </button>
        <button id="wishlistTab" class="tab" title="Shows and movies you want to watch later" aria-label="Wishlist tab - view shows and movies you want to watch">
          📖 <span data-i18n="want_to_watch">Want to Watch</span>
          <span class="tab-badge" id="wishlistBadge">0</span>
        </button>
        <button id="watchedTab" class="tab" title="Shows and movies you've already finished" aria-label="Watched tab - view shows and movies you've completed">
          ✅ <span data-i18n="already_watched">Already Watched</span>
          <span class="tab-badge" id="watchedBadge">0</span>
        </button>
        <button id="discoverTab" class="tab" title="Get personalized recommendations based on your taste" aria-label="Discover tab - find new shows and movies">✨ <span data-i18n="discover">Discover</span></button>
      </div>

      <!-- Search Results Container - Now positioned after tabs -->
      <div id="searchResults" class="search-results" style="display: none;">
        <h4>🎯 <span data-i18n="search_results">Search Results</span> <span class="count" id="resultsCount">0</span></h4>
        <div id="searchResultsList" class="list-container"></div>
      </div>

      <!-- Home - Immovable Layout Contract -->
      <div id="homeSection" class="tab-section active">
        <!-- Quote Bar - Hard-baked between Sticky Search and Group 1 -->
        <div id="quote-bar" class="quote-bar" role="region" aria-label="Quote of the moment" data-state="loading" style="display: none;">
          <div class="quote-marquee">
            <span class="quote-text" id="quoteText" data-i18n="loading_inspirational_quote">Loading inspirational quote...</span>
          </div>
        </div>

        <!-- Group 1 - Your Shows -->
        <div id="group-1-your-shows" class="home-group">
          <div class="group-header">
            <h2 class="group-title" data-i18n="your_shows">Your Shows</h2>
          </div>
          
          <!-- Currently Watching (row): always present -->
          <section id="currentlyWatchingPreview" class="home-preview-row" aria-label="Currently Watching Preview">
            <div class="preview-row-header">
              <h3 class="preview-row-title" data-i18n="currently_watching_section">👁️ Currently Watching</h3>
            </div>
            <div class="preview-row-container cw-row">
              <div class="preview-row-scroll row-inner" id="currentlyWatchingScroll">
                <!-- Cards will be populated by JavaScript -->
                <div class="placeholder-message" id="cw-placeholder" style="display: none;">
                  Add something to your Currently Watching list and it'll show up here.
                </div>
              </div>
            </div>
          </section>

          <!-- Group divider -->
          <div class="group-divider"></div>

          <!-- Next Up This Week (row): if data → carousel; if none → collapsed one-line placeholder -->
          <section id="next-up-row" class="home-preview-row" data-feature="homeRowNextUp" style="display: none;">
            <div class="preview-row-header">
              <h3 class="preview-row-title" data-i18n="next_up_this_week">📅 Next Up This Week</h3>
            </div>
            <div class="preview-row-container">
              <div class="next-up-scroll row-inner preview-row-scroll">
                <!-- tiles injected here -->
                <div class="placeholder-message" id="nextup-placeholder" style="display: none;" data-i18n="no_upcoming_episodes">
                  No upcoming episodes this week.
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Group 2 - Community -->
        <div id="group-2-community" class="home-group">
          <div class="group-header">
            <h2 class="group-title" data-i18n="community">Community</h2>
          </div>
          
          <!-- Community Content - Two Column Layout -->
          <div class="community-content">
            <!-- Left: Empty Player Box -->
            <div class="community-left">
              <div class="player-placeholder">
                <div class="placeholder-content">
                  <h3 data-i18n="community_player">Community Player</h3>
                  <p data-i18n="community_player_placeholder">Video content will appear here</p>
                </div>
              </div>
            </div>
            
            <!-- Right: Game Cards Section -->
            <div class="community-right">
              <section id="home-games" class="home-games">
                <article class="card card--game" id="flickwordTile" data-module="flickword" role="region" tabindex="0" aria-haspopup="dialog" aria-controls="modal-flickword" aria-labelledby="flickword-title">
                  <div class="card__header">
                    <h3 class="card__title" id="flickword-title" data-i18n="flickword">🎯 FlickWord</h3>
                    <div class="card__tools">
                      <div class="game-stats">
                        <div class="stat-item">
                          <span class="stat-label" data-i18n="streak">Streak</span>
                          <span class="stat-value" data-fw-streak>0</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label" data-i18n="best">Best</span>
                          <span class="stat-value" data-fw-best>0</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label" data-i18n="win_percent">Win %</span>
                          <span class="stat-value" data-fw-win>—</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="card__body card__body--scroll">
                    <p class="card__description" data-i18n="flickword_tagline">Wordle-style daily word play</p>
                    <div aria-live="polite" class="sr-only" data-status-live></div>
                  </div>
                  
                  <div class="card__actions">
                    <button class="btn btn--primary" data-action="start-flickword" data-i18n="play_now">Play Now</button>
                  </div>
                </article>

                <article class="card card--game" id="triviaTile" data-module="trivia" role="region" tabindex="0" aria-haspopup="dialog" aria-controls="modal-trivia" aria-labelledby="trivia-title">
                  <div class="card__header">
                    <h3 class="card__title" id="trivia-title" data-i18n="daily_trivia">🧠 Daily Trivia</h3>
                    <div class="card__tools">
                      <div class="game-stats">
                        <div class="stat-item">
                          <span class="stat-label" data-i18n="streak">Streak</span>
                          <span class="stat-value" data-tv-streak>1</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label" data-i18n="best">Best</span>
                          <span class="stat-value" data-tv-best>5</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label" data-i18n="accuracy">Accuracy</span>
                          <span class="stat-value" data-tv-acc>—</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="card__body card__body--scroll">
                    <p class="card__description" data-i18n="daily_trivia_tagline">Fresh question, new bragging rights</p>
                    <div aria-live="polite" class="sr-only" data-status-live></div>
                  </div>
                  
                  <div class="card__actions">
                    <button class="btn btn--primary" data-action="start-trivia" data-i18n="play_now">Play Now</button>
                  </div>
                </article>
              </section>
            </div>
          </div>
        </div>

        <!-- Group 3 - For You -->
        <div id="group-3-for-you" class="home-group">
          <div class="group-header">
            <h2 class="group-title" data-i18n="for_you">For You</h2>
          </div>
          
          <!-- Personalized genre rows from Settings -->
          <section id="personalized-section" class="home-preview-row" style="display: none;">
            <div class="preview-row-header">
              <h3 class="preview-row-title">🎨 <span data-i18n="personalized_recommendations">Personalized Recommendations</span></h3>
              <p class="section-subtitle" data-i18n="based_on_watching_history">Based on your watching history and preferences</p>
            </div>
            <div class="preview-row-container">
              <div class="section-content" id="personalized-content">
                <!-- Personalized content will be populated here -->
              </div>
            </div>
          </section>

          <!-- Group divider -->
          <div class="group-divider"></div>

          <!-- Curated rows count per user setting -->
          <section id="curated-section" class="home-preview-row">
            <div class="preview-row-header">
              <h3 class="preview-row-title" data-i18n="curated_sections">🎯 Curated Sections</h3>
            </div>
            <div class="preview-row-container">
              <div id="curatedSections" class="home-section" style="display: none;">
                <!-- Curated content will be populated here -->
              </div>
            </div>
          </section>
        </div>

        <!-- Group 4 - In Theaters Near You -->
        <div id="group-4-theaters" class="home-group">
          <div class="group-header">
            <h2 class="group-title" data-i18n="in_theaters">In Theaters</h2>
          </div>
          
          <section id="theaters-section" class="home-preview-row" style="display: none;">
            <div class="preview-row-header">
              <h3 class="preview-row-title">🎬 <span data-i18n="in_theaters_near_you">In Theaters Near You</span></h3>
              <p class="section-subtitle" data-i18n="current_theatrical_releases">Current theatrical releases</p>
            </div>
            <div class="preview-row-container">
              <div class="section-content" id="theaters-content">
                <!-- Theater content will be populated here -->
                <div class="theaters-fallback" id="theaters-fallback" style="display: none;" data-i18n="location_prompt">
                  Turn on location to see movies playing near you.
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Group 5 - Feedback -->
        <div id="group-5-feedback" class="home-group">
          <div class="group-header">
            <h2 class="group-title" data-i18n="feedback">Feedback</h2>
          </div>
          
          <section id="feedbackSection" class="home-preview-row">
            <div class="preview-row-header">
              <h3 class="preview-row-title" data-i18n="share_your_thoughts">💬 Share Your Thoughts</h3>
              <p class="section-subtitle" data-i18n="help_improve_feedback">Help us improve Flicklet with your feedback</p>
            </div>
            <div class="preview-row-container">
              <div class="feedback-content">
                <div class="feedback-card">
                  <div class="feedback-actions">
                    <button class="btn btn--primary" onclick="openSettingsToFeedback()" data-i18n="report_bug">
                      🐛 Report a Bug
                    </button>
                    <button class="btn btn--secondary" onclick="openSettingsToFeedback()" data-i18n="suggest_feature">
                      💡 Suggest a Feature
                    </button>
                    <button class="btn btn--secondary" onclick="openSettingsToFeedback()" data-i18n="general_feedback">
                      💬 General Feedback
                    </button>
                    <button class="btn btn--secondary" onclick="openSettingsToFeedback()" data-i18n="submit_video">
                      📹 Submit Video
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <main id="main" role="main">

      <!-- Watching -->
      <div id="watchingSection" class="tab-section" style="display: none">
        <div class="section">
          <div class="section-header">
            <h3>
              ▶️ <span data-i18n="currently_watching">Currently Watching</span>
              <span class="count" id="watchingCount">0</span>
            </h3>
          </div>
          <div id="watchingList" class="list-container"></div>
        </div>
      </div>

      <!-- Wishlist -->
      <div id="wishlistSection" class="tab-section" style="display: none">
        <div class="section">
          <div class="section-header">
            <h3>
              📖 <span data-i18n="want_to_watch">Want to Watch</span>
              <span class="count" id="wishlistCount">0</span>
            </h3>
          </div>
          <div id="wishlistList" class="list-container"></div>
        </div>
      </div>

      <!-- Watched -->
      <div id="watchedSection" class="tab-section" style="display: none">
        <div class="section">
          <div class="section-header">
            <h3>
              ✅ <span data-i18n="already_watched">Already Watched</span>
              <span class="count" id="watchedCount">0</span>
            </h3>
          </div>
          <div id="watchedList" class="list-container"></div>
        </div>
      </div>

      <!-- Discover -->
              <div id="discoverSection" class="tab-section" style="display: none">
          <div class="section">
            <h3>✨ <span data-i18n="discover">Discover</span></h3>
            <p data-i18n="discover_description">Recommendations based on your likes and ratings.</p>
            <div id="discoverList" class="list-container"></div>
          </div>
        </div>


      <!-- Settings / Profile -->
              <div id="settingsSection" class="tab-section" style="display: none">
              <div class="settings-tabs" role="tablist" aria-label="Settings Sections">
                <button role="tab" aria-selected="true" class="active" data-target="#general"><span data-i18n="general">General</span></button>
                <button role="tab" aria-selected="false" data-target="#notifications"><span data-i18n="notifications">Notifications</span></button>
                <button role="tab" aria-selected="false" data-target="#layout"><span data-i18n="layout">Layout</span></button>
                <button role="tab" aria-selected="false" data-target="#data"><span data-i18n="data">Data</span></button>
                <button role="tab" aria-selected="false" data-target="#pro"><span data-i18n="pro">Pro</span></button>
                <button role="tab" aria-selected="false" data-target="#about"><span data-i18n="about">About</span></button>
              </div>

              <div class="settings-container">
                <!-- General Section -->
                <section id="general" class="settings-section active">
                  <div class="settings-subsection">
                    <h3 class="settings-title">⚙️ <span data-i18n="general">General</span></h3>
                    <p class="settings-description" data-i18n="general_description">Manage your account and basic preferences</p>
                    
                    <!-- Display Name -->
                    <div class="settings-control-group">
                      <label for="displayNameInput" class="settings-label" data-i18n="display_name">Display Name</label>
                      <div class="settings-input-group">
                        <input
                          id="displayNameInput"
                          class="settings-input"
                          placeholder="Enter your name"
                        />
                        <button id="saveNameBtn" class="btn btn--primary" onclick="saveDisplayName()">
                          💾 <span data-i18n="save">Save</span>
                        </button>
                      </div>
                      <p class="settings-hint">Your name will appear in the header and personalize your experience</p>
                    </div>
                  </div>

                  <div class="settings-subsection">
                    <h4 class="settings-subtitle">📊 <span data-i18n="my_statistics">My Statistics</span></h4>
                    <p class="settings-hint">View your watching statistics and achievements</p>
                    <div id="statsContent" class="settings-stats">
                      <div class="loading" data-i18n="loading_stats">Loading stats...</div>
                    </div>
                  </div>

                  <div class="settings-subsection">
                    <h4 class="settings-subtitle">🚫 <span data-i18n="not_interested_management">Not Interested Management</span></h4>
                    <p class="settings-description" data-i18n="not_interested_description">Manage shows and movies you've marked as not interested</p>
                    <div class="settings-control-group">
                      <button id="manageNotInterestedBtn" class="btn" onclick="openNotInterestedModal()">
                        🚫 <span data-i18n="manage_not_interested_list">Manage Not Interested List</span>
                      </button>
                      <p class="settings-hint">View and remove items from your "Not Interested" list to see them in recommendations again</p>
                    </div>
                  </div>
                </section>

                <!-- Notifications Section -->
                <section id="notifications" class="settings-section">
                  <div class="settings-subsection">
                    <h3 class="settings-title">🔔 <span data-i18n="notifications">Notifications</span></h3>
                    <p class="settings-description" data-i18n="notifications_description">Choose which types of notifications you'd like to receive</p>
                    
                    <!-- Episode Alerts -->
                    <div class="settings-control-group">
                      <label class="settings-checkbox-label">
                        <input type="checkbox" id="notifEpisodes" class="settings-checkbox" />
                        <span class="settings-checkbox-text" data-i18n="episode_alerts">Upcoming episode alerts</span>
                      </label>
                      <p class="settings-hint">Get notified when new episodes of shows you're watching are about to air</p>
                    </div>

                    <!-- Weekly Discover -->
                    <div class="settings-control-group">
                      <label class="settings-checkbox-label">
                        <input type="checkbox" id="notifDiscover" class="settings-checkbox" />
                        <span class="settings-checkbox-text" data-i18n="weekly_discover">Weekly discover picks</span>
                      </label>
                      <p class="settings-hint">Receive weekly recommendations for new shows and movies based on your preferences</p>
                    </div>

                    <!-- Monthly Digest -->
                    <div class="settings-control-group">
                      <label class="settings-checkbox-label">
                        <input type="checkbox" id="notifDigest" class="settings-checkbox" />
                        <span class="settings-checkbox-text" data-i18n="monthly_digest">Monthly stats digest</span>
                      </label>
                      <p class="settings-hint">Get a monthly summary of your watching statistics and achievements</p>
                    </div>
                  </div>

                  <!-- Pro Notifications -->
                  <div class="settings-subsection">
                    <h4 class="settings-subtitle" data-i18n="pro_notifications">⭐ Pro Notifications</h4>
                    <p class="settings-description" data-i18n="advanced_notification_features">Advanced notification features for Pro users</p>
                    
                    <!-- Advanced Notifications (PRO) -->
                    <div class="settings-control-group">
                      <h5 class="settings-label">🔔 Advanced Notifications (PRO)</h5>
                      <p class="settings-hint">Configure advanced notification settings with custom lead times and list monitoring</p>
                      <div class="settings-block card-surface" style="display: flex; flex-direction: column; gap: 15px; padding: 15px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                          <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="advOn" disabled aria-disabled="true">
                            <span>Enable advanced notifications</span>
                          </label>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                          <label for="advLead" style="font-weight: 500;">Lead time (hours):</label>
                          <select id="advLead" disabled aria-disabled="true" aria-label="Notification lead time" style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="6">6</option>
                            <option value="12">12</option>
                            <option value="24" selected>24</option>
                            <option value="48">48</option>
                            <option value="custom">Custom…</option>
                          </select>
                          <input type="number" id="advLeadCustom" min="1" step="1" value="24" disabled aria-disabled="true" style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; width: 80px;">
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                          <label for="advLists" style="font-weight: 500;">Monitor lists:</label>
                          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="checkbox" id="advListWatching" checked disabled aria-disabled="true">
                              <span>Currently Watching</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="checkbox" id="advListWishlist" disabled aria-disabled="true">
                              <span>Want to Watch</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="checkbox" id="advListWatched" disabled aria-disabled="true">
                              <span>Already Watched</span>
                            </label>
                          </div>
                        </div>
                        <div class="meta-muted" role="note">🔒 Pro feature - upgrade to unlock advanced notifications</div>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- Layout Section -->
                <section id="layout" class="settings-section">
                  <div class="settings-subsection">
                    <h3 class="settings-title">🎨 <span data-i18n="layout_settings">Layout Settings</span></h3>
                    <p class="settings-description" data-i18n="layout_description">Customize how your lists and cards are displayed</p>
                    
                    <!-- Core Layout Features -->
                    <h4 class="settings-subtitle" data-i18n="core_features">📋 Core Features</h4>
                    <p class="settings-description" data-i18n="basic_layout_customization">Basic layout customization available to all users</p>
                    
                    <!-- Condensed Mode -->
                    <div class="settings-control-group">
                      <label class="settings-checkbox-label">
                        <input type="checkbox" id="condensedMode" class="settings-checkbox" />
                        <span class="settings-checkbox-text" data-i18n="condensed_list_view">Condensed list view (more items per screen)</span>
                      </label>
                      <p class="settings-hint" data-i18n="show_more_items_per_screen">Show more items per screen by reducing card spacing and padding</p>
                    </div>

                    <!-- Show Posters -->
                    <div class="settings-control-group">
                      <label class="settings-checkbox-label">
                        <input type="checkbox" id="showPosters" class="settings-checkbox" checked />
                        <span class="settings-checkbox-text" data-i18n="show_posters">Show movie/TV show posters</span>
                      </label>
                      <p class="settings-hint" data-i18n="display_poster_images">Display poster images for each show and movie in your lists</p>
                    </div>

                    <!-- Theme Toggle -->
                    <div class="settings-control-group">
                      <div class="settings-toggle-group">
                        <label class="settings-label" data-i18n="theme_preference">Theme Preference</label>
                        <div class="theme-toggle-container">
                          <button id="themeToggleBtn" class="btn btn--secondary theme-toggle-btn" data-action="toggle-theme">
                            <span id="themeToggleIcon">🌙</span>
                            <span id="themeToggleText" data-i18n="dark_mode">Dark Mode</span>
                          </button>
                          <p class="settings-hint" data-i18n="theme_toggle_hint">Click to switch between light and dark themes</p>
                        </div>
                      </div>
                    </div>

                    <!-- Home Page Lists Count -->
                    <div class="settings-control-group">
                      <label for="settingCuratedRows" class="settings-label" data-i18n="home_page_lists">Home Page TV/Movie Lists</label>
                      <div class="settings-input-group">
                        <input
                          type="number"
                          id="settingCuratedRows"
                          name="curatedRows"
                          min="1"
                          max="3"
                          value="3"
                          class="settings-input settings-input-number"
                        />
                        <span class="settings-hint">(1-3)</span>
                        <span id="curatedRowsStatus" class="settings-status">Auto-saves</span>
                      </div>
                      <p class="settings-hint" data-i18n="number_of_curated_sections">Number of curated recommendation sections to show on the home page</p>
                    </div>

                    <!-- Currently Watching Preview Limit -->
                    <div class="settings-control-group">
                      <label for="settingCurrentlyWatchingLimit" class="settings-label" data-i18n="currently_watching_preview_limit">Currently Watching Preview Limit</label>
                      <div class="settings-input-group">
                        <input
                          type="number"
                          id="settingCurrentlyWatchingLimit"
                          name="currentlyWatchingLimit"
                          min="5"
                          max="20"
                          value="12"
                          class="settings-input settings-input-number"
                        />
                        <span class="settings-hint">(5-20)</span>
                        <span id="currentlyWatchingLimitStatus" class="settings-status">Auto-saves</span>
                      </div>
                      <p class="settings-hint" data-i18n="number_of_currently_watching">Number of currently watching shows to display on the home page preview</p>
                    </div>

                    <!-- Episode Tracking Toggle -->
                    <div class="settings-control-group settings-control-group--feature">
                      <div class="settings-feature-card">
                        <div class="settings-feature-header">
                          <label class="settings-checkbox-label settings-checkbox-label--feature">
                            <input type="checkbox" id="enableEpisodeTracking" class="settings-checkbox settings-checkbox--feature" />
                            <span class="settings-checkbox-text settings-checkbox-text--feature" data-i18n="enable_episode_tracking">🎬 Enable Episode Tracking</span>
                          </label>
                          <div class="settings-feature-badge" data-i18n="recommended">Recommended</div>
                        </div>
                        <p class="settings-hint settings-hint--feature" data-i18n="allow_tracking_of_individual">Track individual episodes for TV series with detailed progress monitoring (opt-in per series)</p>
                        <div class="settings-feature-details">
                          <p class="settings-feature-benefit" data-i18n="episode_tracking_benefits">• Track your progress through each season<br>• Get notifications for new episodes<br>• See detailed watching statistics</p>
                        </div>
                      </div>
                    </div>

                  </div>

                  <!-- Pro Layout Features -->
                  <div class="settings-subsection">
                    <h4 class="settings-subtitle" data-i18n="pro_layout_features">⭐ Pro Layout Features</h4>
                    <p class="settings-description" data-i18n="advanced_layout_and_theming">Advanced layout and theming features for Pro users</p>
                    
                    <!-- Theme Packs -->
                    <div class="settings-control-group">
                      <h5 class="settings-label" data-i18n="theme_packs">🎨 Theme Packs</h5>
                      <p class="settings-hint" data-i18n="choose_a_visual_theme">Choose a visual theme for your Flicklet experience. Pro users get access to premium themes.</p>
                      <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <label for="themePackSelect" style="font-weight: 500;" data-i18n="theme">Theme:</label>
                        <select id="themePackSelect" aria-label="Choose theme" style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
                          <option value="classic" selected>Classic</option>
                          <option value="dark" disabled aria-disabled="true">Dark Pro 🔒</option>
                          <option value="neon" disabled aria-disabled="true">Neon Pro 🔒</option>
                          <option value="minimal" disabled aria-disabled="true">Minimal Pro 🔒</option>
                        </select>
                        <div class="meta-muted" role="note" data-i18n="pro_unlocks_more_themes">🔒 Pro unlocks more themes</div>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- Data Section -->
                <section id="data" class="settings-section">
                  <div class="settings-subsection">
                    <h3 class="settings-title">💾 <span data-i18n="data_management">Data Management</span></h3>
                    <p class="settings-description" data-i18n="data_description">Export, import, or reset your data</p>
                    
                    <!-- Core Data Features -->
                    <h4 class="settings-subtitle" data-i18n="core_features">📋 Core Features</h4>
                    <p class="settings-description" data-i18n="basic_data_management">Basic data management features available to all users</p>
                    
                    <!-- Export JSON -->
                    <div class="settings-control-group">
                      <button id="exportBtn" class="btn btn--secondary" aria-label="Export data to JSON">
                        📤 <span data-i18n="export_json">Export JSON</span>
                      </button>
                      <p class="settings-hint" data-i18n="download_a_complete_backup">Download a complete backup of your lists and settings as a JSON file</p>
                    </div>

                    <!-- Import JSON -->
                    <div class="settings-control-group">
                      <input type="file" id="importInput" accept=".json,application/json" hidden />
                      <button id="importBtn" class="btn btn--secondary" aria-label="Import data from JSON">
                        📥 <span data-i18n="import_json">Import JSON</span>
                      </button>
                      <p class="settings-hint" data-i18n="restore_your_data">Restore your data from a previously exported Flicklet backup file</p>
                    </div>

                    <!-- Not Interested Management -->
                    <div class="settings-control-group">
                      <h4 class="settings-subtitle">🚫 Not Interested List</h4>
                      <p class="settings-description">Manage items you don't want to see in recommendations</p>
                      
                      <div class="not-interested-controls">
                        <button id="viewNotInterestedBtn" class="btn btn--secondary">
                          👁️ View Not Interested Items
                        </button>
                        <button id="clearNotInterestedBtn" class="btn btn--danger">
                          🗑️ Clear All
                        </button>
                      </div>
                      
                      <div id="notInterestedList" class="not-interested-list" style="display: none;">
                        <div class="not-interested-list__header">
                          <h5>Items you're not interested in:</h5>
                          <button id="closeNotInterestedBtn" class="btn btn--sm btn--secondary">×</button>
                        </div>
                        <div id="notInterestedItems" class="not-interested-items">
                          <!-- Items will be populated here -->
                        </div>
                      </div>
                      
                      <p class="settings-hint">Items marked as "Not Interested" won't appear in your Discover recommendations</p>
                    </div>

                    <!-- Share Lists -->
                    <div class="settings-control-group">
                      <button id="shareOpenBtn" class="btn btn--secondary" data-action="share-lists" data-share-title="Flicklet — My List" data-share-url="" title="Share your lists" aria-label="Share your TV and movie lists">
                        🔗 <span data-i18n="share_lists">Share Lists</span>
                      </button>
                      <p class="settings-hint" data-i18n="generate_a_shareable_text">Generate a shareable text list of your TV shows and movies to send to friends</p>
                    </div>

                    <!-- Reset All Data -->
                    <div class="settings-control-group">
                      <button id="resetBtn" class="btn btn--danger" aria-label="Reset all data (requires confirmation)">
                        🗑️ <span data-i18n="reset_all_data">Reset All Data</span>
                      </button>
                      <p class="settings-hint" data-i18n="permanently_delete_all">⚠️ Permanently delete all your lists, settings, and data. This cannot be undone.</p>
                    </div>
                  </div>

                  <!-- Pro Data Features -->
                  <div class="settings-subsection">
                    <h4 class="settings-subtitle" data-i18n="pro_data_features">⭐ Pro Data Features</h4>
                    <p class="settings-description" data-i18n="advanced_data_management">Advanced data management features for Pro users</p>
                    
                    <!-- Export CSV (Pro) -->
                    <div class="settings-control-group">
                      <button class="btn" data-pro="required" data-pro-mode="hide" data-pro-feature="export-csv">
                        📊 <span data-i18n="export_csv_pro">Export CSV (Pro)</span>
                      </button>
                      <p class="settings-hint" data-i18n="export_your_data_csv">Export your data in CSV format for use in spreadsheets (Pro feature)</p>
                    </div>
                  </div>
                </section>

                <!-- Pro Section -->
                <section id="pro" class="settings-section">
                  <div class="settings-subsection">
                    <h3 class="settings-title">⭐ <span data-i18n="pro_features">Pro Features</span></h3>
                    <p class="settings-description" data-i18n="pro_description">
                      Unlock advanced features and premium content with Flicklet Pro
                    </p>
                    
                    <!-- Preview Pro Features -->
                    <div class="settings-control-group">
                      <button id="previewProBtn" class="btn btn--primary" onclick="toggleProPreview()">
                        ⭐ <span data-i18n="preview_pro_features">Preview Pro Features</span>
                      </button>
                      <p class="settings-hint" data-i18n="pro_hint">Toggle Pro features on/off to see what's available without purchasing</p>
                    </div>

                    <!-- Extra Trivia (Pro) -->
                    <div class="settings-control-group">
                      <button class="btn" data-pro="required" data-pro-mode="disable" data-pro-feature="extra-trivia">
                        🧠 <span data-i18n="extra_trivia_pro">Extra Trivia (Pro)</span>
                      </button>
                      <p class="settings-hint" data-i18n="access_additional_trivia">Access additional trivia questions and behind-the-scenes content (Pro feature)</p>
                    </div>

                    <!-- Export CSV (Pro) -->
                    <div class="settings-control-group">
                      <button id="exportCsvBtn" class="btn" data-pro="required" data-pro-mode="disable" data-pro-feature="export-csv" onclick="exportToCSV()">
                        📊 <span data-i18n="export_csv_pro">Export CSV (Pro)</span>
                      </button>
                      <p class="settings-hint" data-i18n="export_your_data_csv">Export your data in CSV format for use in spreadsheets (Pro feature)</p>
                    </div>

                    <!-- Pro Features List -->
                    <div class="settings-control-group">
                      <h4 class="settings-subtitle">✨ <span data-i18n="pro_features_include">Pro Features Include:</span></h4>
                      <p class="settings-hint">Advanced features and premium content available with Flicklet Pro subscription</p>
                      <div id="proFeaturesList" class="settings-pro-features">
                        <!-- Dynamic Pro features list will be rendered here -->
                      </div>
                    </div>
                  </div>
                </section>

                <!-- About Section -->
                <section id="about" class="settings-section">
                  <!-- About Unique4U -->
                  <div class="settings-subsection">
                    <h3 class="settings-title" data-i18n="about_unique4u">🏠 About Unique4U</h3>
                    <p class="settings-description" data-i18n="were_not_here_to_reinvent">
                      We're not here to reinvent the wheel — we're here to make the wheel less squeaky. At Unique4U, our rule is simple: keep it simple. The world already has enough apps that feel like a second job to use. We'd rather give you tools that just… work.
                    </p>
                    <p class="settings-description" data-i18n="everything_we_build">
                      Everything we build has its own personality, but they all live under one roof: a people-first, all-inclusive, slightly offbeat house we call Unique4U. If it's fun, useful, and a little different from the pack — it belongs here.
                    </p>
                  </div>

                  <!-- About the Creators -->
                  <div class="settings-subsection">
                    <h3 class="settings-title" data-i18n="about_the_creators">👥 About the Creators</h3>
                    <p class="settings-description" data-i18n="were_pam_and_travis">
                      We're Pam and Travis. Think of us as casual builders with a shared allergy to overcomplication. We make things because we need them, and we figure you probably do too.
                    </p>
                    <p class="settings-description" data-i18n="pam_once_trained_dolphins">
                      Pam once trained dolphins (true story) and also happens to be really good with numbers. Travis studied English and Philosophy, which means he can overthink and explain it in writing, then somehow turn that into practical business know-how. Together, we're like a mash-up of "creative meets operations" — and that combo lets us build apps that are simple, useful, and not boring.
                    </p>
                  </div>

                  <!-- About the App -->
                  <div class="settings-subsection">
                    <h3 class="settings-title" data-i18n="about_the_app">📱 About the App</h3>
                    <p class="settings-description" data-i18n="heres_the_deal">
                      Here's the deal: you want to remember what you're watching without needing a PhD in App Navigation. We built this because we got tired of two bad options — messy notes on our phones or bloated apps that make you log your "episode 7 mid-season thoughts." (Hard pass.)
                    </p>
                    <p class="settings-description">
                      <strong>Data Attribution:</strong> This product uses the TMDB API but is not endorsed or certified by TMDB.
                    </p>
                    <p class="settings-description" data-i18n="so_we_made_this_instead">
                      So we made this instead:
                    </p>
                    <ul style="margin: 16px 0; padding-left: 20px;" class="u-fg">
                      <li style="margin-bottom: 8px;"><strong>Stupidly easy.</strong> Open it, add your show, done.</li>
                      <li style="margin-bottom: 8px;"><strong>Always free at the core.</strong> No paywalls for the basics.</li>
                      <li style="margin-bottom: 8px;"><strong>Friend-proof sharing.</strong> Copy your list and drop it in a text when someone asks, "What should I watch?"</li>
                    </ul>
                    <p class="settings-description" data-i18n="if_you_watch_tv">
                      If you watch TV or movies and don't want to make it a hobby just to track them, this app's for you. Simple lists, zero drama.
                    </p>
                  </div>

                  <!-- Feedback Form -->
                  <div class="settings-subsection">
                    <h3 class="settings-title">💬 <span data-i18n="share_your_thoughts">Share Your Thoughts</span></h3>
                    <p class="settings-description" data-i18n="feedback_working">
                      Share your thoughts! Give us app feedback, tell us what's working (or not), 
                      share a quote for our rotation, make a confession, submit a video (describe your video idea and we'll get back to you), or just vent. We're listening!
                    </p>
                    
                    <form name="feedback" method="POST" data-netlify="true" netlify-honeypot="bot-field" class="settings-form" action="/thank-you" onsubmit="console.log('🔍 Form onsubmit called'); return false;">
                      <input type="hidden" name="form-name" value="feedback" />
                      <input type="hidden" name="theme" id="feedbackThemeInput" />
                      <div style="display: none;">
                        <label>Don't fill this out if you're human: <input name="bot-field" /></label>
                      </div>
                      
                      <!-- Feedback Form -->
                      <div class="settings-control-group">
                        <label for="feedbackMessage" class="settings-label" data-i18n="your_message">Your Message</label>
                        <textarea
                          id="feedbackMessage"
                          name="message"
                          class="settings-textarea"
                          placeholder="Share your thoughts, feedback, quotes, or just vent! We're listening."
                          rows="3"
                          required
                        ></textarea>
                        <p class="settings-hint">Your feedback helps us improve Flicklet. All messages are read and appreciated!</p>
                        <button type="submit" class="btn btn--primary">
                          📤 <span data-i18n="share_it">Share It!</span>
                        </button>
                      </div>
                    </form>
                  </div>
                </section>
              </div>

          <!-- Share Selection Modal -->
          <div id="shareSelectionModal" class="modal-backdrop" style="display: none; z-index: 10000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
            <div class="modal share-modal" style="max-width: 800px; max-height: 80vh; z-index: 10001; position: relative; background: white; border-radius: 8px; padding: 20px; margin: 20px auto; pointer-events: auto;">
              <h3>🔗 <span data-i18n="share_selected">Share Selected Items</span></h3>
              
              <!-- Select All Controls -->
              <div class="select-all-controls card-surface" style="margin-bottom: 20px; padding: 15px;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; pointer-events: auto;">
                    <input type="checkbox" id="selectAllWatching" style="pointer-events: auto; cursor: pointer;" />
                    <strong>📺 <span data-i18n="currently_watching">Currently Watching</span></strong>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; pointer-events: auto;">
                    <input type="checkbox" id="selectAllWishlist" style="pointer-events: auto; cursor: pointer;" />
                    <strong>📖 <span data-i18n="want_to_watch">Want to Watch</span></strong>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; pointer-events: auto;">
                    <input type="checkbox" id="selectAllWatched" style="pointer-events: auto; cursor: pointer;" />
                    <strong>✅ <span data-i18n="already_watched">Already Watched</span></strong>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; pointer-events: auto;">
                    <input type="checkbox" id="selectAllEverything" style="pointer-events: auto; cursor: pointer;" />
                    <strong>🌟 <span data-i18n="select_all_everything">Select Everything</span></strong>
                  </label>
                </div>
              </div>

              <!-- Items Lists -->
              <div class="share-items-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; pointer-events: auto;">
                <!-- Currently Watching -->
                <div class="share-list-section" style="margin-bottom: 20px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
                  <h4 style="margin: 0 0 10px 0; font-size: 16px; font-weight: bold;">📺 <span data-i18n="currently_watching">Currently Watching</span></h4>
                  <div id="shareWatchingList" class="share-items-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;"></div>
                </div>
                
                <!-- Want to Watch -->
                <div class="share-list-section" style="margin-bottom: 20px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
                  <h4 style="margin: 0 0 10px 0; font-size: 16px; font-weight: bold;">📖 <span data-i18n="want_to_watch">Want to Watch</span></h4>
                  <div id="shareWishlistList" class="share-items-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;"></div>
                </div>
                
                <!-- Already Watched -->
                <div class="share-list-section" style="margin-bottom: 20px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
                  <h4 style="margin: 0 0 10px 0; font-size: 16px; font-weight: bold;">✅ <span data-i18n="already_watched">Already Watched</span></h4>
                  <div id="shareWatchedList" class="share-items-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;"></div>
                </div>
              </div>

                            <!-- Action Buttons -->
              <div class="modal-actions" style="display: flex; gap: 10px; justify-content: center; pointer-events: auto;">
                <button id="generateShareLinkBtn" class="btn btn--success" style="display: none; pointer-events: auto; cursor: pointer;" onclick="generateShareLinkFromSelected()">
                  📋 <span data-i18n="generate_share_link">Select what to share</span>
                </button>
                <button id="copyShareBtn" class="btn btn--primary" style="display: none; pointer-events: auto; cursor: pointer;" onclick="copyShareList()">
                  📋 Copy
                </button>
                <button id="closeShareModalBtn" class="btn btn--secondary" style="pointer-events: auto; cursor: pointer;" onclick="closeShareSelectionModal()">
                  ✖️ <span data-i18n="close">Close</span>
                </button>
              </div>
            </div>
          </div>
  
          </div>
      </div>

      <!-- FABs - Will be moved to active tab dock by JavaScript -->
      <button id="settingsTab" class="fab-left" data-tab="settings" aria-label="Settings" data-requires-auth>⚙️ <span data-i18n="settings">Settings</span></button>
      <div class="fab-stack">
        <button id="darkModeToggle" class="fab" aria-label="Dark">
          <span id="themeIcon">🌙</span>
        </button>
        <button id="mardiToggle" class="fab" aria-label="Mardi">🎭</button>
      </div>
    </div>

    <!-- Firebase (compat for simplicity) -->
      </main>

    <!-- Firebase must load BEFORE app.js -->
    <!-- ==== SCRIPT ORDER: libraries → config → init your app scripts === -->

<!-- Firebase libs (compat for simplicity) -->

<!-- Firebase v9 CDN Bridge -->
<script src="/js/firebase-init.js"></script>


<!-- Auth Diagnostics (temporary) -->
<script src="/auth-diagnostics.js"></script>

<!-- Initialize Firebase (single, robust initialization) -->
<script>
  (function() {
    'use strict';
    
    // Prevent duplicate initialization
    if (window.firebaseInitialized) {
      console.warn("⚠️ Firebase already initialized, skipping duplicate");
      return;
    }
    
    try {
      // Validate configuration
      if (!window.firebaseConfig?.apiKey) {
        console.error("❌ Firebase config missing apiKey");
        return;
      }
      
      // Initialize Firebase only if not already initialized
      if (window.firebase && typeof window.firebase.initializeApp === 'function') {
        if (firebase.apps.length === 0) {
          firebase.initializeApp(window.firebaseConfig);
          console.info("✅ Firebase initialized:", window.firebaseConfig.projectId);
          
          // Set persistence to LOCAL for better localhost experience
          const auth = firebase.auth();
          auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
              console.info("🔒 Auth persistence set to LOCAL");
            })
            .catch((err) => {
              console.error("⚠️ Failed to set persistence", err);
            });
          
          // Expose Firebase services globally for debugging and app use
          window.FB = {
            auth: auth,
            db: firebase.firestore()
          };
          
          // Mark as initialized to prevent duplicates
          window.firebaseInitialized = true;
          window.firebase = firebase;
          window.auth = auth;
          window.db = firebase.firestore();
          
        } else {
          console.warn("⚠️ Firebase already initialized, reusing existing instance");
          window.firebaseInitialized = true;
        }
      } else {
        console.info('Firebase not available; skipping init');
      }
      
    } catch (e) {
      console.error("🔥 Firebase initialization error:", e);
      // Don't mark as initialized if there was an error
    }
  })();
</script>
<!-- Persistence is now handled in the main Firebase initialization above -->



    <!-- Config & core helpers (must be available to everything below) -->
    <script src="/tmdb-config.js"></script>
    <script src="/scripts/tmdb.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/app.js"></script>
    <script src="/js/bootstrap.js"></script>

    <!-- TMDB Image Utilities (must load before components that use it) -->
    <script src="/scripts/tmdb-images.js"></script>
    
    <!-- Component modules (must load before functions that use them) -->
    <script src="/js/components/poster-card.js"></script>
    <script src="/scripts/components/Card.js"></script>
    <script src="/scripts/components/ActionBar.js"></script>

    <!-- Core functionality (assumes utils/app exist) -->
    <script src="/scripts/auth.js"></script>
    <script src="/scripts/notifications.js"></script>
    <script src="/js/functions.js"></script>
    
    <!-- Unified Poster Card System -->
    <script src="/js/components/unified-poster-card.js?v=v25.0"></script>
    <script src="/js/modals/episode-guide-modal.js?v=v25.0"></script>
    <script src="/js/modals/notes-modal.js?v=v25.0"></script>
    <script src="/js/migration/unified-card-migration.js?v=v25.0"></script>
    
    <!-- Utility modules -->
    <script src="/scripts/utils/cardDataNormalizer.js"></script>
    
    <!-- Performance monitoring -->
    <script src="/scripts/performance-monitor.js"></script>
    
    <!-- tmdbGet shim to prevent runtime errors -->
    <script>
    (function () {
      // TMDB client will be loaded via tmdb.js script
    })();
    </script>
    
    <!-- Home layout -->
    <script src="/scripts/home.js"></script>
    
    <!-- Home Layout Guardrails - Immovable Contract Enforcement -->
    <script>
    (function() {
      'use strict';
      
      console.log('🏠 Home Layout Guardrails loaded');
      
      // Immovable Home Layout Contract - Exact 6 Section Order
      const REQUIRED_HOME_SECTIONS = [
        'quote-bar',
        'group-1-your-shows',
        'group-2-community', 
        'group-3-for-you',
        'group-4-theaters',
        'group-5-feedback'
      ];
      
      // Runtime Order Assertion
      function assertHomeOrder() {
        const homeRoot = document.getElementById('homeSection');
        if (!homeRoot) {
          console.error('❌ HOME ORDER VIOLATION: homeSection not found');
          return false;
        }
        
        const children = Array.from(homeRoot.children);
        const sectionIds = children.map(child => child.id).filter(id => id);
        
        console.log('🏠 Home sections found:', sectionIds);
        
        // Check if all required sections exist in correct order
        let orderViolation = false;
        REQUIRED_HOME_SECTIONS.forEach((requiredId, index) => {
          const foundIndex = sectionIds.indexOf(requiredId);
          if (foundIndex === -1) {
            console.error(`❌ HOME ORDER VIOLATION: Missing required section "${requiredId}"`);
            orderViolation = true;
          } else if (foundIndex !== index) {
            console.error(`❌ HOME ORDER VIOLATION: Section "${requiredId}" at position ${foundIndex}, expected ${index}`);
            orderViolation = true;
          }
        });
        
        // Check for unexpected sections
        sectionIds.forEach((id, index) => {
          if (!REQUIRED_HOME_SECTIONS.includes(id)) {
            console.error(`❌ HOME ORDER VIOLATION: Unexpected section "${id}" at position ${index}`);
            orderViolation = true;
          }
        });
        
        if (orderViolation) {
          console.error('❌ HOME ORDER VIOLATION: Removing unexpected nodes');
          // Remove unexpected nodes
          children.forEach((child, index) => {
            if (!REQUIRED_HOME_SECTIONS.includes(child.id)) {
              console.log(`🗑️ Removing unexpected section: ${child.id}`);
              child.remove();
            }
          });
        }
        
        return !orderViolation;
      }
      
      // Purge Legacy Sections
      function purgeLegacySections() {
        const legacySelectors = [
          '#bingeMeter',
          '.stats',
          '#upcomingEpisodes', 
          '#quote-flickword-container',
          '#quoteCard',
          '#randomQuoteCard',
          '#bingeBanner'
        ];
        
        legacySelectors.forEach(selector => {
          const element = document.querySelector(selector);
          if (element) {
            console.log(`🗑️ Purging legacy section: ${selector}`);
            element.remove();
          }
        });
      }
      
      // Initialize Quote Bar with Enhanced Quotes System
      function initQuoteBar() {
        const quoteBar = document.getElementById('quote-bar');
        if (!quoteBar) return;
        
        // Set loading state
        quoteBar.setAttribute('data-state', 'loading');
        quoteBar.style.display = 'block';
        
        // Wait for enhanced quotes system to load, then initialize
        const waitForEnhancedQuotes = () => {
          if (window.QuotesEnhanced && typeof window.QuotesEnhanced.drawQuote === 'function') {
            // Enhanced quotes system is ready
            const quote = window.QuotesEnhanced.drawQuote();
            const quoteText = document.getElementById('quoteText');
            if (quoteText) {
              quoteText.textContent = quote;
              quoteBar.setAttribute('data-state', 'loaded');
              
              // Add smooth transition
              quoteBar.style.opacity = '0';
              requestAnimationFrame(() => {
                quoteBar.style.transition = 'opacity 0.3s ease';
                quoteBar.style.opacity = '1';
              });
            }
          } else {
            // Fallback to basic quotes if enhanced system not ready
            const basicQuotes = [
              "The best way to predict the future is to create it. - Peter Drucker",
              "Life is what happens to you while you're busy making other plans. - John Lennon", 
              "The only way to do great work is to love what you do. - Steve Jobs",
              "Innovation distinguishes between a leader and a follower. - Steve Jobs",
              "Your time is limited, don't waste it living someone else's life. - Steve Jobs",
              "Stay hungry, stay foolish. - Steve Jobs",
              "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
              "It is during our darkest moments that we must focus to see the light. - Aristotle"
            ];
            const quote = basicQuotes[Math.floor(Math.random() * basicQuotes.length)];
            const quoteText = document.getElementById('quoteText');
            if (quoteText) {
              quoteText.textContent = quote;
              quoteBar.setAttribute('data-state', 'loaded');
              
              // Add smooth transition
              quoteBar.style.opacity = '0';
              requestAnimationFrame(() => {
                quoteBar.style.transition = 'opacity 0.3s ease';
                quoteBar.style.opacity = '1';
              });
            }
          }
        };
        
        // Try immediately, then retry after a short delay if needed
        waitForEnhancedQuotes();
        setTimeout(waitForEnhancedQuotes, 500);
      }
      
      // Disable Auto-Inject Systems
      function disableAutoInjectSystems() {
        // Disable MP-Playlists v1
        if (window.FLAGS) {
          window.FLAGS.spotlight_enabled = false;
          window.FLAGS.quotes_enabled = false;
          window.FLAGS.curated_rows_auto_inject = false;
          window.FLAGS.personalized_rows_auto_inject = false;
        }
        
        // Disable Quote System
        if (window.ensureBlocks) {
          window.ensureBlocks = function() { return false; };
        }
        
        // Disable MP-Playlists v1 boot
        if (window.MP_PLAYLISTS_V1) {
          window.MP_PLAYLISTS_V1.enabled = false;
        }
        
        console.log('🚫 Auto-inject systems disabled');
      }
      
            // Override FlickWord mount point to target our specific container
            function overrideFlickWordMount() {
              // Override the findHomeMount function to target our FlickWord container
              window.findHomeMount = function() {
                const flickwordMount = document.querySelector('.flickword-mount');
                if (flickwordMount) {
                  console.log('🎯 FlickWord mount found: .flickword-mount');
                  return flickwordMount;
                }
                // Fallback to original home section
                const homeSection = document.querySelector('#homeSection');
                console.log('🎯 FlickWord mount fallback: #homeSection');
                return homeSection;
              };
              
              // FlickFact feature removed - no longer needed
              
              console.log('🎯 FlickWord system overridden for new layout');
            }
      
      // Handle player container resizing
      function handlePlayerResizing() {
        const communityContent = document.querySelector('.community-content');
        const communityLeft = document.querySelector('.community-left');
        const communityRight = document.querySelector('.community-right');
        
        if (!communityContent || !communityLeft || !communityRight) return;
        
        // Force recalculation of container sizes
        function resizeContainers() {
          // Trigger reflow
          communityContent.style.display = 'none';
          communityContent.offsetHeight; // Force reflow
          communityContent.style.display = 'flex';
          
          // Ensure proper sizing
          communityLeft.style.width = '100%';
          communityRight.style.width = '100%';
          
          console.log('🔄 Community containers resized');
        }
        
        // Resize on window resize
        window.addEventListener('resize', resizeContainers);
        
        // Resize when iframe loads
        const iframe = communityLeft.querySelector('iframe');
        if (iframe) {
          iframe.addEventListener('load', resizeContainers);
        }
        
        // Initial resize
        setTimeout(resizeContainers, 100);
      }
      
      // Initialize when DOM is ready
      function initHomeGuardrails() {
        console.log('🏠 Initializing Home Layout Guardrails...');
        
        // Disable auto-inject systems first
        disableAutoInjectSystems();
        
        // Purge legacy sections
        purgeLegacySections();
        
        // Initialize quote bar
        initQuoteBar();
        
        // Override FlickWord mount point
        overrideFlickWordMount();
        
        // Handle player container resizing
        handlePlayerResizing();
        
        // Initialize Community Games
        function initCommunityGames() {
          console.log('🎮 Initializing Community Games...');
          
          // Check if game scripts loaded
          console.log('🎮 Game script check:', {
            triviaScript: typeof window.FlickletTrivia !== 'undefined',
            flickwordScript: typeof window.flickword !== 'undefined',
            triviaTile: !!document.getElementById('triviaTile'),
            flickwordCard: !!document.getElementById('flickwordCard')
          });
          
          // Try to manually trigger trivia if it exists
          if (typeof window.FlickletTrivia !== 'undefined') {
            console.log('🎮 FlickletTrivia found, checking for init function...');
            console.log('🎮 Available methods:', Object.keys(window.FlickletTrivia));
          }
          
          // Check if trivia is already loaded by the original script
          const triviaTile = document.getElementById('triviaTile');
          const questionEl = document.getElementById('triviaQuestion');
          const choicesEl = document.getElementById('triviaChoices');
          
          if (triviaTile && questionEl && choicesEl) {
            console.log('🎮 Trivia elements found:', {
              hasQuestion: !!questionEl.textContent,
              hasChoices: !!choicesEl.innerHTML,
              questionText: questionEl.textContent
            });
            
            // If trivia is already loaded, just ensure it fits in the container
            if (questionEl.textContent && questionEl.textContent !== '') {
              console.log('🎮 Trivia already loaded by original script');
              // Apply compact styling to existing content
              questionEl.style.fontSize = '13px';
              questionEl.style.lineHeight = '1.3';
              questionEl.style.marginBottom = '8px';
              
              // Style existing choice buttons
              const existingButtons = choicesEl.querySelectorAll('button, li, div');
              existingButtons.forEach(btn => {
                btn.style.padding = '6px 8px';
                btn.style.fontSize = '12px';
                btn.style.marginBottom = '4px';
                btn.style.borderRadius = '4px';
              });
            }
          }
          
          // The games should load automatically via their respective systems
          // FlickWord and Trivia are separate game systems that will populate their containers
          console.log('🎮 Community games containers ready');
        }
        
        // Trivia answer selection is handled by the trivia.js script
        // No need for a separate selectAnswer function here
        
        // Initialize games after a delay
        setTimeout(initCommunityGames, 2000);
        setTimeout(initCommunityGames, 5000);
        
        // Also try when DOM is fully ready
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(initCommunityGames, 1000);
          
          // Initialize theme system
          (function ensureTheme() {
            const k = 'flicklet-theme';
            const t = localStorage.getItem(k) || 'light';
            document.documentElement.setAttribute('data-theme', t);
            // Optional: wire buttons if present
            document.querySelectorAll('[data-set-theme]').forEach(btn=>{
              btn.addEventListener('click', e=>{
                const v = btn.getAttribute('data-set-theme');
                if (!v) return;
                localStorage.setItem(k, v);
                document.documentElement.setAttribute('data-theme', v);
              }, { once: false });
            });
          })();
        });
        
        // Assert order after a short delay to allow other scripts to run
        setTimeout(() => {
          const isValid = assertHomeOrder();
          if (isValid) {
            console.log('✅ Home layout order validated');
          }
        }, 100);
      }
      
      // Run immediately and on DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initHomeGuardrails);
      } else {
        initHomeGuardrails();
      }
      
      // Re-assert order after any major DOM changes
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'childList' && mutation.target.id === 'homeSection') {
            console.log('🏠 Home section DOM changed, re-asserting order...');
            setTimeout(assertHomeOrder, 50);
          }
        });
      });
      
      // Start observing when homeSection is available
      const checkHomeSection = setInterval(() => {
        const homeSection = document.getElementById('homeSection');
        if (homeSection) {
          observer.observe(homeSection, { childList: true, subtree: true });
          clearInterval(checkHomeSection);
        }
      }, 100);
      
    })();
    </script>
    
    <!-- Router -->
    <script src="/scripts/router.js"></script>
    
    
    <!-- Feature modules (safe to assume utils/app are ready) -->
    <script src="/scripts/currently-watching-preview.js"></script>
    <script src="/scripts/next-up-this-week.js"></script>
    <script src="/scripts/community-spotlight.js"></script>
    <!-- CURATED_ROWS: defer heavy work until idle (improves mobile TBT) -->
    <script type="module">
      const idle = (fn)=>('requestIdleCallback'in window)?requestIdleCallback(fn,{timeout:1500}):setTimeout(fn,400);
      idle(()=> import('./scripts/curated-rows.js').then(m=>m.init?.()).catch(console.warn));
    </script>
    <script src="/scripts/curated-seed.js"></script>
    <script src="/scripts/list-actions.js"></script>
    
    <!-- Personalized Rows System -->
    <script src="/scripts/data/user-settings.js"></script>
    <script src="/scripts/api/content.js"></script>
    <script src="/scripts/rows/personalized.js"></script>
    <script src="/scripts/settings/my-rows.js"></script>
    
    <script src="/scripts/share-modal.js"></script>
    <script src="/scripts/search-tips.js"></script>
    <script src="/scripts/series-org.js"></script>
    <script src="/scripts/tmdb-seed.js"></script>
    <script src="/scripts/pro-gate.js"></script>
    <script src="/js/language-manager.js"></script>
    <script src="/js/i18n.js"></script>

    <!-- Centralized Add Handler (must load before other handlers) -->
    <script src="/scripts/centralized-add-handler.js"></script>
    
    <!-- UI orchestration (must be last) -->
    <script src="/scripts/inline-script-01.js" defer></script>
    <script src="/scripts/inline-script-02.js" defer></script>
    <script src="/scripts/inline-script-03.js" defer></script>
    
    <!-- Global Card Actions System -->
    <script src="/scripts/card-actions.js"></script>
    
    <!-- CSV Export System -->
    <script src="/scripts/export-csv.js"></script>
    
    <!-- Enhanced Share System -->
    <script src="/scripts/share-enhanced.js"></script>
    
    <!-- Pro Preview System -->
    <script src="/scripts/pro-preview.js"></script>
    
    <!-- Notifications Test System -->
    <script src="/scripts/notifications-test.js"></script>
    
    <!-- Enhanced Quotes System -->
    <script src="/scripts/quotes-enhanced.js"></script>
    
    <!-- Settings Tie-ins System -->
    <script src="/scripts/settings-tie-ins.js"></script>
    
    <!-- Community Player System -->
    <script src="/scripts/community-player.js"></script>
    <script src="/scripts/episode-tracking.js"></script>
    
    <!-- Community Games -->
    <script src="/scripts/trivia.js?v=23.46&t=20250112"></script>
    <script src="/scripts/flickword-home-only.js.txt"></script>
    
    <!-- FlickWord Modal Functions -->
    <script>
      // FlickWord Modal Functions
      function openFlickWordModal() {
        console.log('🎯 Opening FlickWord modal');
        const modal = document.getElementById('flickwordModal');
        const frame = document.getElementById('flickwordFrame');
        
        if (modal && frame) {
          // Set today's date for the game
          const today = new Date().toISOString().split('T')[0];
          frame.src = `features/flickword-v2.html?date=${today}`;
          modal.style.display = 'block';
          
          // Focus management
          const closeBtn = modal.querySelector('.modal-close');
          if (closeBtn) closeBtn.focus();
        }
      }
      
      function closeFlickWordModal() {
        console.log('🎯 Closing FlickWord modal');
        const modal = document.getElementById('flickwordModal');
        const frame = document.getElementById('flickwordFrame');
        
        if (modal) {
          modal.style.display = 'none';
          if (frame) frame.src = '';
        }
      }
      
      // Update FlickWord teaser stats
      function updateFlickWordStats() {
        const streakEl = document.querySelector('.flickword-teaser .streak');
        const bestEl = document.querySelector('.flickword-teaser .best');
        
        if (streakEl && bestEl) {
          const stats = JSON.parse(localStorage.getItem('flickword:stats') || '{}');
          streakEl.textContent = `Streak: ${stats.streak || 0}`;
          bestEl.textContent = `Best: ${stats.best || 0}`;
        }
      }
      
      // Initialize FlickWord teaser
      function initFlickWordTeaser() {
        console.log('🎯 Initializing FlickWord teaser');
        updateFlickWordStats();
        
        // Listen for game results to update stats
        window.addEventListener('message', function(event) {
          if (event.data && event.data.type === 'flickword:result') {
            console.log('🎯 FlickWord result received:', event.data);
            updateFlickWordStats();
          }
        });
      }
      
      // Initialize when ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFlickWordTeaser);
      } else {
        initFlickWordTeaser();
      }
    </script>

    <!-- Game Cards Modal System -->
    <script>
    console.log('🎮 Script starting...');
    (function () {
      console.log('🎮 Initializing Game Cards Modal System');
      const qs  = (s, r=document) => r.querySelector(s);
      const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));

      // Open/close helpers
      let lastOpener = null;
      function openModal(id, opener) {
        console.log('🎮 Opening modal:', id);
        const m = qs('#' + id);
        if (!m) {
          console.error('🎮 Modal not found:', id);
          return;
        }
        lastOpener = opener || document.activeElement;
        m.setAttribute('aria-hidden', 'false');
        console.log('🎮 Modal opened:', m.id, 'aria-hidden:', m.getAttribute('aria-hidden'));
        
        // Set up FlickWord iframe with today's date
        if (id === 'modal-flickword') {
          const frame = qs('#flickword-game-frame');
          if (frame) {
            const today = new Date().toISOString().split('T')[0];
            frame.src = `features/flickword-v2.html?date=${today}`;
          }
        }

        // Focus trap
        const focusables = qsa('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])', m);
        const first = focusables[0], last = focusables[focusables.length - 1];
        (first || qs('[data-close]', m) || m).focus();

        function trap(e){
          if (e.key !== 'Tab') return;
          if (!focusables.length) return;
          if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
          else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
        }
        m._trap = trap;
        m.addEventListener('keydown', trap);
      }
      function closeModal(m) {
        console.log('🔴 Closing modal:', m?.id);
        if (!m) return;
        m.setAttribute('aria-hidden', 'true');
        m.removeEventListener('keydown', m._trap || (()=>{}));
        if (lastOpener && typeof lastOpener.focus === 'function') lastOpener.focus();
      }

      // Wire card + CTA triggers
      function wireCard(cardId, modalId){
        console.log('🎮 Wiring card:', cardId, 'to modal:', modalId);
        const card = qs('#' + cardId);
        if (!card) {
          console.error('🎮 Card not found:', cardId);
          return;
        }
        const open = (e) => { 
          console.log('🎮 Card clicked:', cardId);
          e.preventDefault(); 
          openModal(modalId, card); 
        };
        card.addEventListener('click', open);
        card.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') open(e); });
        const btn = qs('#' + cardId + ' .gc-cta');
        if (btn) {
          console.log('🎮 CTA button found for:', cardId);
          btn.addEventListener('click', open);
        } else {
          console.warn('🎮 CTA button not found for:', cardId);
        }
      }
      // Check if modals exist
      console.log('🎮 Available modals:', qsa('.game-modal').map(m => m.id));
      console.log('🎮 FlickWord modal:', qs('#modal-flickword'));
      console.log('🎮 Trivia modal:', qs('#modal-trivia'));
      
      wireCard('flickwordTile', 'modal-flickword');
      wireCard('triviaTile', 'modal-trivia');

      // Overlay & close buttons
      qsa('.game-modal').forEach(m => {
        qsa('[data-close]', m).forEach(el => {
          el.addEventListener('click', (e) => {
            console.log('🔴 Close button clicked for modal:', m.id);
            e.preventDefault();
            e.stopPropagation();
            closeModal(m);
          });
        });
        m.addEventListener('click', (e) => { 
          if (e.target.classList.contains('gm-overlay')) {
            closeModal(m);
          }
        });
        m.addEventListener('keydown', (e) => { 
          if (e.key === 'Escape') {
            closeModal(m);
          }
        });
      });
      
      // Global close function
      window.closeGameModal = closeModal;
      
      // Listen for game close messages
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'flickword:close') {
          const modal = qs('#modal-flickword');
          if (modal) closeModal(modal);
        }
        if (event.data && event.data.type === 'trivia:close') {
          const modal = qs('#modal-trivia');
          if (modal) closeModal(modal);
        }
      });

      // Handle new data-action buttons
      document.addEventListener('click', function(event) {
        const action = event.target.getAttribute('data-action');
        if (action === 'start-flickword') {
          event.preventDefault();
          event.stopPropagation();
          openModal('modal-flickword');
        } else if (action === 'start-trivia') {
          event.preventDefault();
          event.stopPropagation();
          openModal('modal-trivia');
        }
      });
      
      // Dispatch modal events for other systems to listen to
      const originalOpenModal = openModal;
      openModal = function(id, opener) {
        originalOpenModal(id, opener);
        document.dispatchEvent(new CustomEvent('modal:open', { detail: { id, opener } }));
      };
      
      const originalCloseModal = closeModal;
      closeModal = function(m) {
        const id = m?.id;
        originalCloseModal(m);
        if (id) {
          document.dispatchEvent(new CustomEvent('modal:close', { detail: { id } }));
        }
      };

      // ---- Reliable close: X, overlay, ESC ----
      (function wireModalCloseDelegation(){
        if (window.__modalCloseWired) return;
        window.__modalCloseWired = true;

        document.addEventListener('click', (e)=>{
          const t = e.target;
          if (t.classList?.contains('gm-overlay') || t.closest?.('[data-close]')){
            e.preventDefault();
            closeModal(t.closest('.game-modal'));
          }
        });
        document.addEventListener('keydown', (e)=>{
          if (e.key === 'Escape') {
            const openModal = document.querySelector('.game-modal[aria-hidden="false"]');
            if (openModal) closeModal(openModal);
          }
        });
      })();

      // ---- Exact iframe sizing on open + resize ----
      (function sizeIframesOnModalOpen(){
        function sizeIframe(modalId){
          const modal = document.getElementById(modalId);
          if (!modal) return;
          const body = modal.querySelector('.gm-body');
          const iframe = body?.querySelector('iframe');
          if (!iframe || !body) return;
          /* Height now managed by card system */
        }

        const needsResize = new Set();

        document.addEventListener('modal:open', (e)=>{
          const id = e.detail?.id;
          if (!id) return;
          requestAnimationFrame(()=> sizeIframe(id));
          needsResize.add(id);
        });

        document.addEventListener('modal:close', (e)=>{
          const id = e.detail?.id;
          if (!id) return;
          needsResize.delete(id);
        });

        window.addEventListener('resize', ()=>{
          for (const id of needsResize) sizeIframe(id);
        });
      })();

      // Stats hooks (wire real data later)
      window.GameStats = {
        set(data){
          if (data.flickword){
            if ('streak' in data.flickword) qs('[data-fw-streak]')?.replaceChildren(String(data.flickword.streak));
            if ('best'   in data.flickword) qs('[data-fw-best]')?.replaceChildren(String(data.flickword.best));
            if ('win'    in data.flickword) qs('[data-fw-win]')?.replaceChildren(String(data.flickword.win));
          }
          if (data.trivia){
            if ('streak' in data.trivia) qs('[data-tv-streak]')?.replaceChildren(String(data.trivia.streak));
            if ('best'   in data.trivia) qs('[data-tv-best]')?.replaceChildren(String(data.trivia.best));
            if ('acc'    in data.trivia) qs('[data-tv-acc]')?.replaceChildren(String(data.trivia.acc));
          }
        }
      };
    })();
    </script>

    <!-- Daily Trivia Bridge -->
    <script>
    // === Daily Trivia <-> Modal bridge (iframe mount/unmount) ===
    window.DailyTriviaBridge = (() => {
      let handle = null;
      const TRIVIA_SRC = 'features/trivia.html'; // change here if your path differs

      function todayISO(){ return new Date().toISOString().slice(0,10); }

      function mount(rootSel){
        const root = typeof rootSel === 'string' ? document.querySelector(rootSel) : rootSel;
        if (!root) throw new Error('DailyTrivia root not found');
        if (handle) return handle;

        const iframe = document.createElement('iframe');
        iframe.id = 'triviaFrame_new';
        iframe.title = 'Daily Trivia Game';
        iframe.loading = 'eager';
        iframe.referrerPolicy = 'no-referrer';
        iframe.allow = '';
        iframe.sandbox = 'allow-scripts';
        iframe.style.width = '100%';
        /* Height now managed by card system */
        iframe.style.border = 'none';
        iframe.style.borderRadius = '10px';

        // If your trivia uses a daily seed, pass date (safe even if ignored)
        iframe.src = `${TRIVIA_SRC}?date=${todayISO()}`;

        root.replaceChildren(iframe);

        const onLoad = () => { try { iframe.focus(); } catch {} };
        iframe.addEventListener('load', onLoad);

        // Listen for results and update teaser stats
        const onMsg = (event) => {
          const data = event.data;
          if (!data || data.type !== 'trivia:result') return;
          // Expect payload like { streak, best, acc } — adjust if your keys differ
          try {
            const prev = JSON.parse(localStorage.getItem('trivia:stats') || '{}');
            const next = { ...prev, ...data.payload };
            localStorage.setItem('trivia:stats', JSON.stringify(next));
          } catch {}

          try {
            const $ = (s)=>document.querySelector(s);
            const stats = JSON.parse(localStorage.getItem('trivia:stats') || '{}');
            $('[data-tv-streak]') && $('[data-tv-streak]').replaceChildren(String(stats.streak ?? 0));
            $('[data-tv-best]')   && $('[data-tv-best]').replaceChildren(String(stats.best ?? 0));
            $('[data-tv-acc]')    && $('[data-tv-acc]').replaceChildren(String(stats.acc ?? '—'));
          } catch {}
        };
        window.addEventListener('message', onMsg);

        handle = {
          iframe,
          destroy(){
            try { iframe.removeEventListener('load', onLoad); } catch {}
            try { window.removeEventListener('message', onMsg); } catch {}
            try { iframe.src = 'about:blank'; } catch {}
            if (iframe.parentNode) iframe.parentNode.replaceChildren();
            handle = null;
          }
        };
        return handle;
      }

      function unmount(){ if (handle) handle.destroy(); }

      return { mount, unmount };
    })();

    // === Wire to modal lifecycle ===
    (function wireTriviaToModal(){
      document.addEventListener('modal:open', (e)=>{
        if (e.detail?.id === 'modal-trivia') {
          try { window.DailyTriviaBridge.mount('#dailytrivia-game'); }
          catch(err){ console.error('Trivia mount failed', err); }
        }
      });
      document.addEventListener('modal:close', (e)=>{
        if (e.detail?.id === 'modal-trivia') {
          try { window.DailyTriviaBridge.unmount(); }
          catch(err){ console.error('Trivia unmount failed', err); }
        }
      });
    })();

    // === Initialize teaser with any saved stats (runs once at startup) ===
    (function initTriviaTeaserNew(){
      try {
        const stats = JSON.parse(localStorage.getItem('trivia:stats') || '{}');
        const set = (sel, val)=>{ const el=document.querySelector(sel); if (el) el.textContent = String(val); };
        set('[data-tv-streak]', stats.streak ?? 0);
        set('[data-tv-best]',   stats.best   ?? 0);
        set('[data-tv-acc]',    stats.acc    ?? '—');
      } catch {}
    })();
    </script>

    <!-- Modal Iframe Sizing -->
    <script>
    // Helper to size an iframe to its modal body
    function sizeModalIframe(modalId, iframeEl){
      const modal = document.getElementById(modalId);
      if (!modal || !iframeEl) return;
      const body = modal.querySelector('.gm-body');
      if (!body) return;

      /* Height now managed by card system - no forced heights */
    }

    // Patch FlickWordBridge to use dynamic sizing
    (function patchFlickWordSizing(){
      if (!window.FlickWordBridge) return;
      const _mount = window.FlickWordBridge.mount;
      window.FlickWordBridge.mount = async function(rootSel){
        const handle = await _mount.call(window.FlickWordBridge, rootSel);

        // Try to find the iframe we just created
        const root = typeof rootSel === 'string' ? document.querySelector(rootSel) : rootSel;
        const iframe = root && (root.querySelector('iframe') || root.firstElementChild);

        // Initial size after next frame
        requestAnimationFrame(()=> sizeModalIframe('modal-flickword', iframe));

        // Resize with window
        function onResize(){ sizeModalIframe('modal-flickword', iframe); }
        window.addEventListener('resize', onResize);

        // Keep cleanup on destroy
        const _destroy = handle?.destroy;
        if (_destroy){
          handle.destroy = function(){
            window.removeEventListener('resize', onResize);
            _destroy.call(handle);
          };
        }
        return handle;
      };
    })();
    </script>

    

    <!-- CLEANUP: All test and duplicate scripts removed for production -->
    
    <!-- Fallback search initialization -->
    <script>
    (function() {
      'use strict';
      
      // Fallback search initialization to ensure search works
      function initializeSearchFallback() {
        console.log('🔍 Fallback search initialization starting...');
        
        const searchBtn = document.getElementById('searchBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const searchInput = document.getElementById('search');
        
        if (searchBtn && typeof window.performSearch === 'function') {
          console.log('✅ Setting up search button (fallback)');
          searchBtn.onclick = function() {
            console.log('🔍 Search button clicked (fallback)');
            window.performSearch();
          };
        }
        
        if (clearSearchBtn && typeof window.clearSearch === 'function') {
          console.log('✅ Setting up clear search button (fallback)');
          clearSearchBtn.onclick = function() {
            console.log('🧹 Clear search button clicked (fallback)');
            window.clearSearch();
          };
        }
        
        if (searchInput && typeof window.performSearch === 'function') {
          console.log('✅ Setting up search input Enter key (fallback)');
          searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              console.log('⌨️ Enter key pressed (fallback)');
              e.preventDefault();
              window.performSearch();
            }
          });
        }
        
        console.log('✅ Fallback search initialization complete');
      }
      
      // Run immediately and also after a delay
      initializeSearchFallback();
      setTimeout(initializeSearchFallback, 2000);
      
    })();
    </script>

    <!-- Feedback Link Handler -->
    <script>
    function openSettingsToFeedback() {
      console.log('💬 Opening settings to feedback section');
      
      // Use the global switchToTab function if available
      if (typeof window.switchToTab === 'function') {
        window.switchToTab('settings');
        
        // Wait for settings to load, then switch to About tab
        setTimeout(() => {
          const aboutTab = document.querySelector('.settings-tabs button[data-target="#about"]');
          if (aboutTab) {
            aboutTab.click();
            
            // Scroll to feedback section
            setTimeout(() => {
              const feedbackSection = document.querySelector('#about .settings-subsection:last-child');
              if (feedbackSection) {
                feedbackSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 100);
          }
        }, 200);
      } else {
        // Fallback to direct tab click
        const settingsTab = document.getElementById('settingsTab');
        if (settingsTab) {
          settingsTab.click();
          
          // Wait for settings to load, then switch to About tab
          setTimeout(() => {
            const aboutTab = document.querySelector('.settings-tabs button[data-target="#about"]');
            if (aboutTab) {
              aboutTab.click();
              
              // Scroll to feedback section
              setTimeout(() => {
                const feedbackSection = document.querySelector('#about .settings-subsection:last-child');
                if (feedbackSection) {
                  feedbackSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
              }, 100);
            }
          }, 200);
        } else {
          console.warn('💬 Settings tab not found');
          alert('Please go to Settings → About to share your feedback');
        }
      }
    }
    </script>

    <!-- Episode Tracking Toggle Handler -->
    <script>
    (function(){
      console.log('🔧 Episode tracking toggle handler starting...');
      
      let toggle = null;
      
      // Function to find and setup the toggle
      function setupToggle() {
        if (toggle && toggle.dataset.setupComplete) {
          console.log('🔧 Episode tracking toggle already set up, skipping');
          return true;
        }
        
        toggle = document.querySelector('#enableEpisodeTracking');
        console.log('🔧 Episode tracking toggle found:', !!toggle, toggle);
        if (!toggle) {
          console.warn('🔧 Episode tracking toggle not found, will retry...');
          return false;
        }
        
        // Load saved value
        const stored = localStorage.getItem('flicklet:episodeTracking:enabled');
        console.log('🔧 Stored episode tracking value:', stored);
        if (stored !== null) {
          toggle.checked = stored === 'true';
        } else {
          // Default to false (disabled)
          toggle.checked = false;
        }
        
        // Apply the setting
        applyEpisodeTrackingSetting();
        
        // Add event listener
        toggle.addEventListener('change', () => {
          console.log('🔧 Episode tracking toggle changed:', toggle.checked);
          applyEpisodeTrackingSetting();
        });
        
        // Mark as set up
        toggle.dataset.setupComplete = 'true';
        
        return true;
      }
      
      // Function to apply the setting
      function applyEpisodeTrackingSetting() {
        const enabled = toggle.checked;
        console.log('🔧 Setting episode tracking to:', enabled);
        localStorage.setItem('flicklet:episodeTracking:enabled', String(enabled));
        
        // Update UI visibility based on setting
        // Add a small delay to ensure cards are rendered first
        setTimeout(() => {
          updateEpisodeTrackingUI(enabled);
        }, 100);
      }
      
      // Function to update UI based on episode tracking setting
      function updateEpisodeTrackingUI(enabled) {
        console.log('🔧 updateEpisodeTrackingUI called with enabled:', enabled);
        
        // Show/hide episode tracking buttons on TV series cards
        const episodeButtons = document.querySelectorAll('[data-action="track-episodes"]');
        console.log('🔧 Found episode buttons:', episodeButtons.length);
        episodeButtons.forEach((btn, index) => {
          console.log(`🔧 Button ${index}:`, btn.textContent, 'setting display to:', enabled ? 'inline-block' : 'none');
          btn.style.display = enabled ? 'inline-block' : 'none';
        });
        
        // Update any existing progress hints
        const progressHints = document.querySelectorAll('.episode-progress-hint');
        progressHints.forEach(hint => {
          hint.style.display = enabled ? 'inline' : 'none';
        });
        
        // Note: UI update handled by episode tracking system initialization
      }
      
      // Try to setup immediately
      if (!setupToggle()) {
        // If not found, retry every 500ms for up to 10 seconds
        let retries = 0;
        const retryInterval = setInterval(() => {
          retries++;
          console.log('🔧 Retrying to find episode tracking toggle, attempt:', retries);
          if (setupToggle() || retries >= 20) {
            clearInterval(retryInterval);
            if (retries >= 20) {
              console.warn('🔧 Failed to find episode tracking toggle after 20 attempts');
            }
          }
        }, 500);
      }
      
      // Expose function to update UI
      window.updateEpisodeTrackingUI = updateEpisodeTrackingUI;
      
      // Update UI on page load to show existing buttons
      setTimeout(() => {
        const enabled = localStorage.getItem('flicklet:episodeTracking:enabled') === 'true';
        console.log('🔧 Page load - updating episode tracking UI, enabled:', enabled);
        updateEpisodeTrackingUI(enabled);
      }, 1000);
      
    })();
    </script>

    <!-- Curated Rows Count Setting Handler -->
    <script>
    (function(){
      console.log('🔧 Curated rows setting handler starting...');
      
      let input = null;
      let debounceTimer;
      
      // Function to find and setup the input
      function setupInput() {
        // If already set up, don't do it again
        if (input && input.dataset.setupComplete) {
          console.log('🔧 Input already set up, skipping');
          return true;
        }
        
        input = document.querySelector('#settingCuratedRows, [name="curatedRows"]');
        console.log('🔧 Input found:', !!input, input);
        if (!input) {
          console.warn('🔧 Curated rows input not found, will retry...');
          return false;
        }
        
        // Track if this is initial setup to avoid showing notification
        let isInitialSetup = true;
        let hasUserInteracted = false;
        let isSettingValue = false; // Flag to prevent notifications when setting value programmatically
        let lastNotifiedValue = null; // Track last value we showed notification for
        
        // Function to safely set value without triggering notifications
        function setValueSafely(value) {
          console.log('🔧 setValueSafely called with:', value, 'isSettingValue will be set to true');
          isSettingValue = true;
          input.value = value;
          console.log('🔧 Set value safely to:', value, 'isSettingValue:', isSettingValue);
          // Apply the setting but without notification
          applySetting();
          isSettingValue = false;
          console.log('🔧 setValueSafely completed, isSettingValue reset to false');
        }
        
        // Load saved value
        const stored = localStorage.getItem('flicklet:curated:rows');
        console.log('🔧 Stored value:', stored);
        if (stored) {
          // Set value without triggering notifications
          setValueSafely(stored);
        } else {
          // Set default value without triggering notifications
          setValueSafely('3');
        }
        
        // Function to apply the setting
        function applySetting() {
          console.log('🔧 applySetting called with value:', input.value, 'isInitialSetup:', isInitialSetup, 'hasUserInteracted:', hasUserInteracted, 'isSettingValue:', isSettingValue);
          const n = Math.max(1, Math.min(10, Number(input.value)||3));
          console.log('🔧 Setting curated rows to:', n);
          localStorage.setItem('flicklet:curated:rows', String(n));
          document.dispatchEvent(new CustomEvent('curated:rerender'));
          console.log('🔧 Dispatched curated:rerender event');
          
          // Only show notification if user has actually interacted with the input, we're not setting the value programmatically, and the value has changed
          if (hasUserInteracted && !isSettingValue && lastNotifiedValue !== n && window.showNotification) {
            console.log('🔧 Showing notification for user interaction - value changed from', lastNotifiedValue, 'to', n);
            window.showNotification(`✅ Showing ${n} TV/Movie list${n>1?'s':''}`, 'success');
            lastNotifiedValue = n; // Remember this value so we don't notify again
          } else {
            console.log('🔧 Notification blocked - hasUserInteracted:', hasUserInteracted, 'isSettingValue:', isSettingValue, 'value changed:', lastNotifiedValue !== n, 'showNotification available:', !!window.showNotification);
          }
          
          // Visual feedback on the input
          input.style.borderColor = '#10b981';
          input.style.backgroundColor = '#f0fdf4';
          
          // Update status indicator
          const status = document.getElementById('curatedRowsStatus');
          if (status) {
            status.textContent = '✅ Saved';
            status.style.color = '#10b981';
            setTimeout(() => {
              status.textContent = 'Auto-saves';
              status.style.color = '';
            }, 2000);
          }
          
          setTimeout(() => {
            input.style.borderColor = '';
            input.style.backgroundColor = '';
          }, 1000);
        }
        
        // Debounced function for input events
        function debouncedApply() {
          console.log('🔧 debouncedApply called');
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(applySetting, 300);
        }
        
        // Track user interaction to enable notifications
        input.addEventListener('input', () => {
          hasUserInteracted = true;
          lastNotifiedValue = null; // Reset so we can notify for new changes
          console.log('🔧 User interacted with input - notifications enabled, reset lastNotifiedValue');
          debouncedApply();
        });
        input.addEventListener('change', () => {
          hasUserInteracted = true;
          console.log('🔧 User changed input - notifications enabled');
          applySetting();
        });
        input.addEventListener('blur', () => {
          hasUserInteracted = true;
          console.log('🔧 User blurred input - notifications enabled');
          applySetting();
        });
        
        // Mark setup as complete after a short delay to avoid initial notification
        setTimeout(() => {
          isInitialSetup = false;
          console.log('🔧 Initial setup complete - notifications enabled');
        }, 1000);
        
        // Function to refresh value when settings tab is opened
        function refreshValue() {
          console.log('🔧 refreshValue called - resetting hasUserInteracted to false');
          hasUserInteracted = false; // Reset user interaction flag for refresh operations
          
          const currentStored = localStorage.getItem('flicklet:curated:rows');
          if (currentStored && currentStored !== input.value) {
            console.log('🔧 Refreshing value from storage:', currentStored);
            // Use setValueSafely to avoid notifications during refresh
            setValueSafely(currentStored);
          } else {
            console.log('🔧 No refresh needed - value already correct:', input.value);
          }
        }
        
        // Expose refresh function globally so it can be called when settings tab opens
        window.refreshCuratedRowsSetting = refreshValue;
        
        // Test if input is responsive
        input.addEventListener('click', () => console.log('🔧 Input clicked'));
        input.addEventListener('focus', () => console.log('🔧 Input focused'));
        
        console.log('🔧 Event listeners attached to input');
        
        // Mark as set up to prevent duplicate setup
        input.dataset.setupComplete = 'true';
        
        // Test the input
        setTimeout(() => {
          if (input.offsetParent === null) {
            console.log('🔧 Input is hidden - user needs to go to Settings > Layout tab to see it');
          } else {
            console.log('🔧 Input is visible and ready');
          }
        }, 1000);
        
        return true;
      }
      
      // Try to setup immediately
      if (!setupInput()) {
        // If not found, retry every 500ms for up to 10 seconds
        let retries = 0;
        const retryInterval = setInterval(() => {
          retries++;
          console.log('🔧 Retrying to find input, attempt:', retries);
          if (setupInput() || retries >= 20) {
            clearInterval(retryInterval);
            if (retries >= 20) {
              console.warn('🔧 Failed to find input after 20 attempts');
            }
          }
        }, 500);
      }
      
      // Also listen for when the Layout tab becomes active
      document.addEventListener('DOMContentLoaded', () => {
        // Listen for tab changes to re-setup the input if needed
        const layoutSection = document.querySelector('#layout');
        if (layoutSection) {
          // Use MutationObserver to detect when the section becomes active
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const isActive = layoutSection.classList.contains('active');
                if (isActive && !input) {
                  console.log('🔧 Layout section became active, re-setting up input');
                  setupInput();
                }
              }
            });
          });
          
          observer.observe(layoutSection, { attributes: true, attributeFilter: ['class'] });
        }
        
        // Also listen for the settings tabs initialization
        const checkForTabs = setInterval(() => {
          if (document.querySelector('.settings-tabs button[data-target="#layout"]')) {
            console.log('🔧 Settings tabs found, setting up layout tab listener');
            clearInterval(checkForTabs);
            
            const layoutTab = document.querySelector('.settings-tabs button[data-target="#layout"]');
            if (layoutTab) {
              layoutTab.addEventListener('click', () => {
                console.log('🔧 Layout tab clicked, ensuring input is set up');
                setTimeout(() => {
                  if (!input) {
                    console.log('🔧 Input not found, setting up...');
                    setupInput();
                  } else {
                    console.log('🔧 Input already exists, checking visibility...');
                    console.log('🔧 Input visible?', input.offsetParent !== null);
                    console.log('🔧 Input parent visible?', input.parentElement?.offsetParent !== null);
                    console.log('🔧 Input parent classes:', input.parentElement?.className);
                    console.log('🔧 Input parent parent classes:', input.parentElement?.parentElement?.className);
                    
                    // Refresh the value to ensure it shows the correct stored value
                    if (typeof window.refreshCuratedRowsSetting === 'function') {
                      console.log('🔧 Refreshing curated rows setting on Layout tab click');
                      window.refreshCuratedRowsSetting();
                    }
                  }
                }, 100);
              });
            }
          }
        }, 500);
        
        // Stop checking after 10 seconds
        setTimeout(() => clearInterval(checkForTabs), 10000);
      });
      
    })();
    </script>

    <!-- Currently Watching Limit Setting Handler -->
    <script>
    (function(){
      console.log('🔧 Currently watching limit setting handler starting...');
      
      let input = null;
      let debounceTimer;
      
      // Function to find and setup the input
      function setupInput() {
        // If already set up, don't do it again
        if (input && input.dataset.setupComplete) {
          console.log('🔧 Currently watching limit input already set up, skipping');
          return true;
        }
        
        input = document.querySelector('#settingCurrentlyWatchingLimit, [name="currentlyWatchingLimit"]');
        console.log('🔧 Currently watching limit input found:', !!input, input);
        if (!input) {
          console.warn('🔧 Currently watching limit input not found, will retry...');
          return false;
        }
        
        // Track if this is initial setup to avoid showing notification
        let isInitialSetup = true;
        let hasUserInteracted = false;
        let isSettingValue = false; // Flag to prevent notifications when setting value programmatically
        let lastNotifiedValue = null; // Track last value we showed notification for
        
        // Function to safely set value without triggering notifications
        function setValueSafely(value) {
          console.log('🔧 setValueSafely called with:', value, 'isSettingValue will be set to true');
          isSettingValue = true;
          input.value = value;
          console.log('🔧 Set value safely to:', value, 'isSettingValue:', isSettingValue);
          // Apply the setting but without notification
          applySetting();
          isSettingValue = false;
          console.log('🔧 setValueSafely completed, isSettingValue reset to false');
        }
        
        // Load saved value
        const stored = localStorage.getItem('flicklet:currentlyWatching:limit');
        console.log('🔧 Stored currently watching limit value:', stored);
        if (stored) {
          // Set value without triggering notifications
          setValueSafely(stored);
        } else {
          // Set default value without triggering notifications
          setValueSafely('12');
        }
        
        // Function to apply the setting
        function applySetting() {
          console.log('🔧 applyCurrentlyWatchingSetting called with value:', input.value, 'isInitialSetup:', isInitialSetup, 'hasUserInteracted:', hasUserInteracted, 'isSettingValue:', isSettingValue);
          const n = Math.max(5, Math.min(20, Number(input.value)||12));
          console.log('🔧 Setting currently watching limit to:', n);
          localStorage.setItem('flicklet:currentlyWatching:limit', String(n));
          
          // Trigger currently watching preview update
          if (typeof window.renderCurrentlyWatchingPreview === 'function') {
            window.renderCurrentlyWatchingPreview();
          }
          document.dispatchEvent(new CustomEvent('currentlyWatching:rerender'));
          console.log('🔧 Dispatched currentlyWatching:rerender event');
          
          // Only show notification if user has actually interacted with the input, we're not setting the value programmatically, and the value has changed
          if (hasUserInteracted && !isSettingValue && lastNotifiedValue !== n && window.showNotification) {
            console.log('🔧 Showing notification for user interaction - value changed from', lastNotifiedValue, 'to', n);
            window.showNotification(`✅ Showing ${n} currently watching shows`, 'success');
            lastNotifiedValue = n; // Remember this value so we don't notify again
          } else {
            console.log('🔧 Notification blocked - hasUserInteracted:', hasUserInteracted, 'isSettingValue:', isSettingValue, 'value changed:', lastNotifiedValue !== n, 'showNotification available:', !!window.showNotification);
          }
          
          // Visual feedback on the input
          input.style.borderColor = '#10b981';
          input.style.backgroundColor = '#f0fdf4';
          
          // Update status indicator
          const status = document.getElementById('currentlyWatchingLimitStatus');
          if (status) {
            status.textContent = '✅ Saved';
            status.style.color = '#10b981';
            setTimeout(() => {
              status.textContent = 'Auto-saves';
              status.style.color = '';
            }, 2000);
          }
          
          setTimeout(() => {
            input.style.borderColor = '';
            input.style.backgroundColor = '';
          }, 1000);
        }
        
        // Debounced function for input events
        function debouncedApply() {
          console.log('🔧 debouncedApply called for currently watching limit');
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            console.log('🔧 Debounced apply executing for currently watching limit');
            applySetting();
          }, 500);
        }
        
        // Event listeners
        input.addEventListener('input', () => {
          console.log('🔧 Currently watching limit input event fired');
          hasUserInteracted = true;
          isInitialSetup = false;
          debouncedApply();
        });
        
        input.addEventListener('change', () => {
          console.log('🔧 Currently watching limit change event fired');
          hasUserInteracted = true;
          isInitialSetup = false;
          applySetting();
        });
        
        // Mark as set up
        input.dataset.setupComplete = 'true';
        console.log('🔧 Currently watching limit input setup complete');
        return true;
      }
      
      // Try to setup immediately
      if (!setupInput()) {
        // If not ready, retry every 100ms for up to 10 seconds
        let attempts = 0;
        const maxAttempts = 100;
        const interval = setInterval(() => {
          attempts++;
          console.log('🔧 Currently watching limit setup attempt', attempts);
          if (setupInput() || attempts >= maxAttempts) {
            clearInterval(interval);
            if (attempts >= maxAttempts) {
              console.error('🔧 Failed to setup currently watching limit input after', maxAttempts, 'attempts');
            }
          }
        }, 100);
      }
      
      // Expose refresh function for external use
      window.refreshCurrentlyWatchingLimitSetting = function() {
        console.log('🔧 Refreshing currently watching limit setting...');
        if (input) {
          const stored = localStorage.getItem('flicklet:currentlyWatching:limit');
          if (stored) {
            input.value = stored;
          }
        }
      };
      
    })();
    </script>
    
    <!-- Global modal mount, never hidden by tab switching -->
    <div id="modal-root" data-modal-root style="position:relative; z-index:0;"></div>
    
    <!-- FlickWord Modal -->
    <div id="flickwordModal" class="modal" style="display: none;">
      <div class="modal-backdrop" onclick="closeFlickWordModal()"></div>
      <div class="modal-dialog flickword-modal">
        <div class="modal-header">
          <h3 data-i18n="flickword">🎯 FlickWord</h3>
          <button class="modal-close" onclick="closeFlickWordModal()" data-i18n="close_game">×</button>
        </div>
        <div class="modal-content">
          <iframe 
            id="flickwordFrame" 
            src="/features/flickword-v2.html" 
            style="width: 100%; height: 500px; border: none; border-radius: 8px;"
            title="FlickWord Game"
            sandbox="allow-scripts allow-same-origin"
          ></iframe>
        </div>
        <div class="modal-actions">
          <button class="btn btn--secondary" onclick="closeFlickWordModal()">Close Game</button>
        </div>
      </div>
    </div>

    <!-- Game Modals -->
    <div class="game-modal" id="modal-flickword" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modal-flickword-title">
      <div class="gm-overlay" data-close></div>
      <div class="gm-dialog" role="document">
        <header class="gm-header">
          <h3 id="modal-flickword-title" data-i18n="flickword">FlickWord</h3>
          <button class="gm-close" type="button" aria-label="Close" data-close>&times;</button>
        </header>
        <main class="gm-body">
          <iframe 
            id="flickword-game-frame" 
            src="/features/flickword-v2.html" 
            style="width: 100%; height: 100%; border: none; border-radius: 8px;"
            title="FlickWord Game"
            sandbox="allow-scripts allow-same-origin"
          ></iframe>
        </main>
      </div>
    </div>

    <div class="game-modal" id="modal-trivia" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modal-trivia-title">
      <div class="gm-overlay" data-close></div>
      <div class="gm-dialog" role="document">
        <header class="gm-header">
          <h3 id="modal-trivia-title" data-i18n="daily_trivia">Daily Trivia</h3>
          <button class="gm-close" type="button" aria-label="Close" data-close>&times;</button>
        </header>
        <main class="gm-body">
          <div id="dailytrivia-game" class="gm-placeholder">[ Daily Trivia game mounts here ]</div>
        </main>
      </div>
    </div>
	
	<!-- Notifications regions (required by notifications.js) -->
<div id="toastRegion" role="status" aria-live="polite" aria-atomic="true" class="toast-region"></div>
<div id="bannerRegion" role="alert" aria-live="assertive" aria-atomic="true" class="banner-region"></div>

          <!-- Verification Script - Remove after testing -->
          </body>
</html>