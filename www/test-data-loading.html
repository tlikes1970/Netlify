<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Loading Test - Flicklet</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .test-card {
        background: white;
        margin: 15px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .success {
        border-left: 4px solid #28a745;
      }
      .error {
        border-left: 4px solid #dc3545;
      }
      .warning {
        border-left: 4px solid #ffc107;
      }
      .info {
        border-left: 4px solid #17a2b8;
      }
      button {
        padding: 10px 20px;
        margin: 10px 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-warning {
        background: #ffc107;
        color: black;
      }
      .log {
        background: #f8f9fa;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .status {
        font-weight: bold;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Data Loading Test</h1>
      <p>This tool tests if user data is being loaded from Firebase after authentication.</p>

      <div class="test-card" id="auth-status">
        <h3>Authentication Status</h3>
        <div id="auth-info">Checking...</div>
      </div>

      <div class="test-card" id="data-status">
        <h3>Data Status</h3>
        <div id="data-info">Checking...</div>
      </div>

      <div class="test-card" id="test-actions">
        <h3>Test Actions</h3>
        <button class="btn-primary" onclick="testDataLoad()">Test Data Load</button>
        <button class="btn-warning" onclick="testWatchlistsAdapter()">
          Test WatchlistsAdapter
        </button>
        <button class="btn-success" onclick="testUIUpdate()">Test UI Update</button>
        <button class="btn-warning" onclick="clearLogs()">Clear Logs</button>
      </div>

      <div class="test-card">
        <h3>Test Log</h3>
        <div id="test-log" class="log"></div>
      </div>
    </div>

    <!-- Load Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="/firebase-config.js"></script>
    <script src="/js/auth-manager.js"></script>
    <script src="/js/functions.js"></script>
    <script src="/js/utils.js"></script>

    <script>
      let testLog = document.getElementById('test-log');

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const prefix =
          type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
        testLog.textContent += `[${timestamp}] ${prefix} ${message}\n`;
        testLog.scrollTop = testLog.scrollHeight;
        console.log(`[Data Loading Test] ${message}`);
      }

      function clearLogs() {
        testLog.textContent = '';
      }

      function updateStatus(cardId, status, message, type = 'info') {
        const card = document.getElementById(cardId);
        const statusDiv = card.querySelector('[id$="-info"]');

        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        card.className = `test-card ${type}`;
      }

      // Check authentication status
      function checkAuthStatus() {
        log('Checking authentication status...');

        if (window.firebaseAuth && window.firebaseAuth.currentUser) {
          const user = window.firebaseAuth.currentUser;
          updateStatus('auth-status', 'success', `‚úÖ Signed in as: ${user.email}`, 'success');
          log(`User signed in: ${user.email}`, 'success');
          return user;
        } else {
          updateStatus('auth-status', 'error', '‚ùå Not signed in', 'error');
          log('No user signed in', 'error');
          return null;
        }
      }

      // Check data status
      function checkDataStatus() {
        log('Checking data status...');

        if (!window.appData) {
          updateStatus('data-status', 'error', '‚ùå appData not available', 'error');
          log('appData not available', 'error');
          return false;
        }

        const tv = window.appData.tv || {};
        const movies = window.appData.movies || {};

        const tvCounts = {
          watching: (tv.watching || []).length,
          wishlist: (tv.wishlist || []).length,
          watched: (tv.watched || []).length,
        };

        const movieCounts = {
          watching: (movies.watching || []).length,
          wishlist: (movies.wishlist || []).length,
          watched: (movies.watched || []).length,
        };

        const totalItems =
          Object.values(tvCounts).reduce((a, b) => a + b, 0) +
          Object.values(movieCounts).reduce((a, b) => a + b, 0);

        if (totalItems > 0) {
          updateStatus(
            'data-status',
            'success',
            `‚úÖ Data loaded: ${totalItems} total items`,
            'success',
          );
          log(
            `Data loaded: TV(${tvCounts.watching}w/${tvCounts.wishlist}wl/${tvCounts.watched}wd) Movies(${movieCounts.watching}w/${movieCounts.wishlist}wl/${movieCounts.watched}wd)`,
            'success',
          );
          return true;
        } else {
          updateStatus('data-status', 'warning', '‚ö†Ô∏è No data loaded (0 items)', 'warning');
          log('No data loaded - all lists are empty', 'warning');
          return false;
        }
      }

      // Test data loading
      async function testDataLoad() {
        log('Testing data loading...');

        const user = checkAuthStatus();
        if (!user) {
          log('Cannot test data loading - no user signed in', 'error');
          return;
        }

        try {
          if (
            window.AuthManager &&
            typeof window.AuthManager.loadUserDataFromFirebase === 'function'
          ) {
            log('Using AuthManager.loadUserDataFromFirebase...');
            await window.AuthManager.loadUserDataFromFirebase(user);
            log('Data loading completed', 'success');
          } else {
            log('AuthManager.loadUserDataFromFirebase not available', 'error');
          }

          // Check data status after loading
          setTimeout(() => {
            checkDataStatus();
          }, 1000);
        } catch (error) {
          log(`Data loading failed: ${error.message}`, 'error');
        }
      }

      // Test WatchlistsAdapter
      async function testWatchlistsAdapter() {
        log('Testing WatchlistsAdapter...');

        if (!window.WatchlistsAdapter) {
          log('WatchlistsAdapter not available', 'error');
          return;
        }

        try {
          const user = window.firebaseAuth?.currentUser;
          const uid = user?.uid || null;

          log(`Loading watchlists for user: ${uid || 'null'}`);
          const watchlists = await window.WatchlistsAdapter.load(uid);

          log(
            `WatchlistsAdapter loaded: ${watchlists.watchingIds.length} watching, ${watchlists.wishlistIds.length} wishlist, ${watchlists.watchedIds.length} watched`,
            'success',
          );
        } catch (error) {
          log(`WatchlistsAdapter test failed: ${error.message}`, 'error');
        }
      }

      // Test UI update
      function testUIUpdate() {
        log('Testing UI update...');

        try {
          if (typeof window.updateUI === 'function') {
            window.updateUI();
            log('updateUI() called', 'success');
          } else {
            log('updateUI() not available', 'error');
          }

          if (typeof window.updateTabCounts === 'function') {
            window.updateTabCounts();
            log('updateTabCounts() called', 'success');
          } else {
            log('updateTabCounts() not available', 'error');
          }
        } catch (error) {
          log(`UI update failed: ${error.message}`, 'error');
        }
      }

      // Run all checks
      function runAllChecks() {
        log('Running all data loading checks...');
        checkAuthStatus();
        checkDataStatus();
      }

      // Initialize tests when page loads
      window.addEventListener('load', () => {
        log('Data loading test page loaded');
        runAllChecks();
      });

      // Listen for Firebase ready
      window.addEventListener('firebase:ready', () => {
        log('Firebase ready event received');
        runAllChecks();
      });

      // Listen for data ready
      window.addEventListener('app:data:ready', (event) => {
        log(`Data ready event received from: ${event.detail?.source || 'unknown'}`);
        checkDataStatus();
      });
    </script>
  </body>
</html>
