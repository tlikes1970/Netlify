<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modal Fix Validation Tests</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .test-pass {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .test-fail {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      button {
        margin: 5px;
        padding: 10px 15px;
      }
      .console-output {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        font-family: monospace;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>Modal Fix Validation Tests</h1>

    <div class="test-section">
      <h2>Test 1: Auth Modal Open/Close</h2>
      <button onclick="testAuthModal()">Test Auth Modal</button>
      <div id="test1-result" class="console-output"></div>
    </div>

    <div class="test-section">
      <h2>Test 2: Modal Count Check</h2>
      <button onclick="testModalCount()">Check Modal Count</button>
      <div id="test2-result" class="console-output"></div>
    </div>

    <div class="test-section">
      <h2>Test 3: Z-Index Hierarchy</h2>
      <button onclick="testZIndex()">Check Z-Index</button>
      <div id="test3-result" class="console-output"></div>
    </div>

    <div class="test-section">
      <h2>Test 4: Self-Heal Mechanism</h2>
      <button onclick="testSelfHeal()">Test Self-Heal</button>
      <div id="test4-result" class="console-output"></div>
    </div>

    <script>
      // Test functions
      function testAuthModal() {
        const result = document.getElementById('test1-result');
        result.textContent = 'Testing auth modal...\n';

        try {
          // Test opening
          if (window.AUTH_MANAGER && window.AUTH_MANAGER._authModalManager) {
            const opened = window.AUTH_MANAGER._authModalManager.open();
            result.textContent += `Open result: ${opened}\n`;

            // Check if modal is visible
            const modal = document.getElementById('providerModal');
            if (modal) {
              const isVisible = modal.classList.contains('is-active');
              const ariaHidden = modal.getAttribute('aria-hidden');
              result.textContent += `Modal visible: ${isVisible}, aria-hidden: ${ariaHidden}\n`;

              // Test closing
              window.AUTH_MANAGER._authModalManager.close();
              result.textContent += 'Modal closed\n';

              // Check if closed
              const isVisibleAfter = modal.classList.contains('is-active');
              const ariaHiddenAfter = modal.getAttribute('aria-hidden');
              result.textContent += `After close - visible: ${isVisibleAfter}, aria-hidden: ${ariaHiddenAfter}\n`;

              result.parentElement.className = 'test-section test-pass';
            } else {
              result.textContent += 'ERROR: Modal element not found\n';
              result.parentElement.className = 'test-section test-fail';
            }
          } else {
            result.textContent += 'ERROR: AUTH_MANAGER not available\n';
            result.parentElement.className = 'test-section test-fail';
          }
        } catch (error) {
          result.textContent += `ERROR: ${error.message}\n`;
          result.parentElement.className = 'test-section test-fail';
        }
      }

      function testModalCount() {
        const result = document.getElementById('test2-result');
        const authModals = document.querySelectorAll('.auth-modal-backdrop');
        const shareModals = document.querySelectorAll('.share-modal-backdrop');
        const gameModals = document.querySelectorAll('.game-modal');

        result.textContent = `Auth modals: ${authModals.length}\n`;
        result.textContent += `Share modals: ${shareModals.length}\n`;
        result.textContent += `Game modals: ${gameModals.length}\n`;
        result.textContent += `Total modal-backdrop elements: ${document.querySelectorAll('.modal-backdrop').length}\n`;

        result.parentElement.className = 'test-section test-pass';
      }

      function testZIndex() {
        const result = document.getElementById('test3-result');

        const authModal = document.getElementById('providerModal');
        const shareModal = document.getElementById('shareSelectionModal');
        const gameModal = document.querySelector('.game-modal');

        if (authModal) {
          const authZ = getComputedStyle(authModal).zIndex;
          result.textContent += `Auth modal z-index: ${authZ}\n`;
        }

        if (shareModal) {
          const shareZ = getComputedStyle(shareModal).zIndex;
          result.textContent += `Share modal z-index: ${shareZ}\n`;
        }

        if (gameModal) {
          const gameZ = getComputedStyle(gameModal).zIndex;
          result.textContent += `Game modal z-index: ${gameZ}\n`;
        }

        result.parentElement.className = 'test-section test-pass';
      }

      function testSelfHeal() {
        const result = document.getElementById('test4-result');

        try {
          if (window.AUTH_MANAGER && window.AUTH_MANAGER._authModalManager) {
            // Simulate broken state
            const modal = document.getElementById('providerModal');
            if (modal) {
              modal.classList.add('is-active');
              modal.setAttribute('aria-hidden', 'false');
              window.AUTH_MANAGER._authModalManager.isOpen = true;
              window.AUTH_MANAGER._authModalManager.modalElement = modal;

              // Now try to open - should self-heal
              const opened = window.AUTH_MANAGER._authModalManager.open();
              result.textContent += `Self-heal test result: ${opened}\n`;
              result.textContent += `Modal state after self-heal: ${window.AUTH_MANAGER._authModalManager.isOpen}\n`;

              result.parentElement.className = 'test-section test-pass';
            } else {
              result.textContent += 'ERROR: Modal element not found\n';
              result.parentElement.className = 'test-section test-fail';
            }
          } else {
            result.textContent += 'ERROR: AUTH_MANAGER not available\n';
            result.parentElement.className = 'test-section test-fail';
          }
        } catch (error) {
          result.textContent += `ERROR: ${error.message}\n`;
          result.parentElement.className = 'test-section test-fail';
        }
      }

      // Console one-liners for PM
      console.log('=== Console One-Liners for PM ===');
      console.log('Count curtains:', "document.querySelectorAll('.modal-backdrop').length");
      console.log(
        'Check auth visibility:',
        "(()=>{const m=document.getElementById('providerModal');if(!m)return'no el';const cs=getComputedStyle(m);return {display:cs.display,aria:m.getAttribute('aria-hidden')}})()",
      );
      console.log(
        'Quick z-order sanity:',
        "getComputedStyle(document.getElementById('providerModal')).zIndex",
      );
    </script>
  </body>
</html>
