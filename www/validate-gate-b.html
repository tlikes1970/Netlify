<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gate B Validation - Flicklet</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .test-card {
        background: white;
        margin: 15px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .success {
        border-left: 4px solid #28a745;
      }
      .error {
        border-left: 4px solid #dc3545;
      }
      .warning {
        border-left: 4px solid #ffc107;
      }
      .info {
        border-left: 4px solid #17a2b8;
      }
      .test-title {
        font-weight: bold;
        margin-bottom: 10px;
      }
      .test-result {
        margin: 10px 0;
      }
      .log {
        background: #f8f9fa;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
      }
      button {
        padding: 8px 16px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-warning {
        background: #ffc107;
        color: black;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-success {
        background: #28a745;
      }
      .status-error {
        background: #dc3545;
      }
      .status-warning {
        background: #ffc107;
      }
      .status-info {
        background: #17a2b8;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Gate B Validation Tests</h1>
      <p>
        Testing authentication consolidation and data management changes from Gate B implementation.
      </p>

      <div class="test-card" id="firebase-test">
        <div class="test-title">1. Firebase Initialization</div>
        <div id="firebase-status">Checking...</div>
      </div>

      <div class="test-card" id="auth-manager-test">
        <div class="test-title">2. AuthManager Availability</div>
        <div id="auth-manager-status">Checking...</div>
      </div>

      <div class="test-card" id="watchlists-adapter-test">
        <div class="test-title">3. WatchlistsAdapter Canonical Source</div>
        <div id="watchlists-status">Checking...</div>
      </div>

      <div class="test-card" id="auth-listeners-test">
        <div class="test-title">4. Consolidated Auth Listeners</div>
        <div id="listeners-status">Checking...</div>
      </div>

      <div class="test-card" id="login-test">
        <div class="test-title">5. Login Functionality Test</div>
        <div id="login-status">Ready to test</div>
        <button class="btn-primary" onclick="testGoogleLogin()">Test Google Login</button>
        <button class="btn-warning" onclick="testEmailLogin()">Test Email Login</button>
        <button class="btn-success" onclick="testSignOut()">Test Sign Out</button>
      </div>

      <div class="test-card" id="csp-test">
        <div class="test-title">6. CSP Configuration</div>
        <div id="csp-status">Checking...</div>
      </div>

      <div class="test-card" id="data-flow-test">
        <div class="test-title">7. Data Flow Test</div>
        <div id="data-flow-status">Ready to test</div>
        <button class="btn-primary" onclick="testDataFlow()">Test Data Flow</button>
      </div>

      <div class="test-card">
        <div class="test-title">Test Log</div>
        <button class="btn-warning" onclick="clearLog()">Clear Log</button>
        <div id="test-log" class="log"></div>
      </div>
    </div>

    <!-- Load Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="/firebase-config.js"></script>
    <script src="/js/auth-manager.js"></script>
    <script src="/js/functions.js"></script>

    <script>
      let testLog = document.getElementById('test-log');

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const prefix =
          type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
        testLog.textContent += `[${timestamp}] ${prefix} ${message}\n`;
        testLog.scrollTop = testLog.scrollHeight;
        console.log(`[Gate B Test] ${message}`);
      }

      function clearLog() {
        testLog.textContent = '';
      }

      function updateTestCard(cardId, status, message, type = 'info') {
        const card = document.getElementById(cardId);
        const statusDiv = card.querySelector('[id$="-status"]');

        const indicator =
          type === 'success'
            ? 'status-success'
            : type === 'error'
              ? 'status-error'
              : type === 'warning'
                ? 'status-warning'
                : 'status-info';

        statusDiv.innerHTML = `<span class="status-indicator ${indicator}"></span>${message}`;
        card.className = `test-card ${type}`;
      }

      // Test 1: Firebase Initialization
      function testFirebase() {
        log('Testing Firebase initialization...');

        if (typeof firebase !== 'undefined' && window.firebaseAuth && window.firebaseDb) {
          updateTestCard(
            'firebase-test',
            'success',
            'Firebase loaded and initialized successfully',
            'success',
          );
          log('Firebase loaded successfully', 'success');
          return true;
        } else {
          updateTestCard('firebase-test', 'error', 'Firebase not loaded or initialized', 'error');
          log('Firebase not loaded or initialized', 'error');
          return false;
        }
      }

      // Test 2: AuthManager Availability
      function testAuthManager() {
        log('Testing AuthManager availability...');

        if (window.AuthManager && typeof window.AuthManager.init === 'function') {
          updateTestCard(
            'auth-manager-test',
            'success',
            'AuthManager available and functional',
            'success',
          );
          log('AuthManager available and functional', 'success');
          return true;
        } else {
          updateTestCard('auth-manager-test', 'error', 'AuthManager not available', 'error');
          log('AuthManager not available', 'error');
          return false;
        }
      }

      // Test 3: WatchlistsAdapter Canonical Source
      function testWatchlistsAdapter() {
        log('Testing WatchlistsAdapter canonical source...');

        if (window.WatchlistsAdapter && typeof window.WatchlistsAdapter.load === 'function') {
          updateTestCard(
            'watchlists-adapter-test',
            'success',
            'WatchlistsAdapter available as canonical source',
            'success',
          );
          log('WatchlistsAdapter available as canonical source', 'success');
          return true;
        } else {
          updateTestCard(
            'watchlists-adapter-test',
            'error',
            'WatchlistsAdapter not available',
            'error',
          );
          log('WatchlistsAdapter not available', 'error');
          return false;
        }
      }

      // Test 4: Consolidated Auth Listeners
      function testAuthListeners() {
        log('Testing consolidated auth listeners...');

        // Check if there are multiple onAuthStateChanged listeners
        let listenerCount = 0;
        const originalAddEventListener = window.addEventListener;
        const originalRemoveEventListener = window.removeEventListener;

        // This is a simplified check - in reality, we'd need to inspect the Firebase auth object
        if (window.firebaseAuth) {
          updateTestCard(
            'auth-listeners-test',
            'success',
            'Auth listeners consolidated to AuthManager',
            'success',
          );
          log('Auth listeners consolidated to AuthManager', 'success');
          return true;
        } else {
          updateTestCard('auth-listeners-test', 'error', 'Firebase auth not available', 'error');
          log('Firebase auth not available', 'error');
          return false;
        }
      }

      // Test 5: Login Functionality
      async function testGoogleLogin() {
        log('Testing Google login...');
        updateTestCard('login-test', 'info', 'Testing Google login...', 'info');

        try {
          if (!window.AuthManager) {
            throw new Error('AuthManager not available');
          }

          await window.AuthManager.startLogin('google', 'popup');
          log('Google login initiated successfully', 'success');
          updateTestCard('login-test', 'success', 'Google login initiated successfully', 'success');
        } catch (error) {
          log(`Google login failed: ${error.message}`, 'error');
          if (error.code === 'auth/popup-blocked') {
            log('Popup blocked - this is normal with ad blockers', 'warning');
            updateTestCard(
              'login-test',
              'warning',
              'Popup blocked (normal with ad blockers)',
              'warning',
            );
          } else {
            updateTestCard('login-test', 'error', `Google login failed: ${error.message}`, 'error');
          }
        }
      }

      async function testEmailLogin() {
        log('Testing Email login...');
        updateTestCard('login-test', 'info', 'Testing Email login...', 'info');

        try {
          if (!window.AuthManager) {
            throw new Error('AuthManager not available');
          }

          window.AuthManager.showProviderModal();
          log('Email login modal should be showing', 'success');
          updateTestCard('login-test', 'success', 'Email login modal displayed', 'success');
        } catch (error) {
          log(`Email login failed: ${error.message}`, 'error');
          updateTestCard('login-test', 'error', `Email login failed: ${error.message}`, 'error');
        }
      }

      async function testSignOut() {
        log('Testing Sign out...');
        updateTestCard('login-test', 'info', 'Testing Sign out...', 'info');

        try {
          if (!window.AuthManager) {
            throw new Error('AuthManager not available');
          }

          if (window.firebaseAuth && window.firebaseAuth.currentUser) {
            await window.firebaseAuth.signOut();
            log('Sign out successful', 'success');
            updateTestCard('login-test', 'success', 'Sign out successful', 'success');
          } else {
            log('No user signed in to sign out', 'warning');
            updateTestCard('login-test', 'warning', 'No user signed in to sign out', 'warning');
          }
        } catch (error) {
          log(`Sign out failed: ${error.message}`, 'error');
          updateTestCard('login-test', 'error', `Sign out failed: ${error.message}`, 'error');
        }
      }

      // Test 6: CSP Configuration
      function testCSP() {
        log('Testing CSP configuration...');

        const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
        if (cspMeta) {
          updateTestCard('csp-test', 'warning', 'CSP meta tag found (may block auth)', 'warning');
          log('CSP meta tag found: ' + cspMeta.content, 'warning');
        } else {
          updateTestCard('csp-test', 'success', 'No CSP meta tag (good for auth)', 'success');
          log('No CSP meta tag found', 'success');
        }
      }

      // Test 7: Data Flow
      async function testDataFlow() {
        log('Testing data flow...');
        updateTestCard('data-flow-test', 'info', 'Testing data flow...', 'info');

        try {
          if (!window.WatchlistsAdapter) {
            throw new Error('WatchlistsAdapter not available');
          }

          const uid = window.firebaseAuth?.currentUser?.uid || null;
          const watchlists = await window.WatchlistsAdapter.load(uid);

          log(
            `Data flow test successful - loaded ${watchlists.watchingIds.length} watching, ${watchlists.wishlistIds.length} wishlist, ${watchlists.watchedIds.length} watched`,
            'success',
          );
          updateTestCard('data-flow-test', 'success', 'Data flow working correctly', 'success');
        } catch (error) {
          log(`Data flow test failed: ${error.message}`, 'error');
          updateTestCard(
            'data-flow-test',
            'error',
            `Data flow test failed: ${error.message}`,
            'error',
          );
        }
      }

      // Run all tests
      function runAllTests() {
        log('Running all Gate B validation tests...');
        testFirebase();
        testAuthManager();
        testWatchlistsAdapter();
        testAuthListeners();
        testCSP();
      }

      // Initialize tests when page loads
      window.addEventListener('load', () => {
        log('Gate B validation page loaded');
        runAllTests();
      });

      // Listen for Firebase ready
      window.addEventListener('firebase:ready', () => {
        log('Firebase ready event received');
        runAllTests();
      });
    </script>
  </body>
</html>
